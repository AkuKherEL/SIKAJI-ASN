<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIKAJI ASN - Sistem Informasi Kenaikan Pangkat & Gaji Berkala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                extend: {
                    colors: {
                        navy: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        gold: { 500: '#d97706', 400: '#f59e0b', 100: '#fef3c7' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1)', 'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(40px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #334155; }
        .bg-luxury-pattern { background-color: #f1f5f9; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 32px 32px; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .glass-dark { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-item-active { background: linear-gradient(90deg, rgba(217, 119, 6, 0.15) 0%, rgba(217, 119, 6, 0) 100%); border-left: 3px solid #f59e0b; color: #fbbf24 !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,1); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .table-row-hover:hover td { background-color: #f8fafc; transition: background-color 0.2s; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        /* Modal Styles */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="antialiased overflow-hidden selection:bg-gold-500 selection:text-white bg-luxury-pattern">

    <!-- LOADER -->
    <div id="app-loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-6 text-center px-4 w-full max-w-md">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-slate-100 border-t-gold-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center font-bold text-gold-500 text-xs">S</div>
            </div>
            <div id="loader-content">
                <p class="text-sm font-bold text-slate-800 tracking-wide uppercase animate-pulse" id="loader-text">Memuat Sistem...</p>
                <p class="text-xs text-slate-400 mt-1">SIKAJI ASN &copy; 2025</p>
            </div>
            <div id="loader-error" class="hidden bg-white/80 p-6 rounded-2xl border border-red-200 text-sm text-left w-full shadow-xl backdrop-blur-sm">
                <p class="font-bold flex items-center gap-2 text-red-600 text-lg mb-2"><i class="ph ph-warning-octagon text-2xl"></i> Koneksi Terputus</p>
                <p class="text-slate-600 mb-4">Gagal terhubung ke server cloud atau script terblokir. Mohon periksa koneksi internet Anda.</p>
                <div class="flex gap-2">
                    <button onclick="location.reload()" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold hover:bg-red-700 transition-all shadow-lg hover:shadow-red-600/30">Muat Ulang</button>
                    <button onclick="window.hardReset()" class="flex-1 bg-white border border-red-200 text-red-600 px-4 py-2.5 rounded-xl text-xs font-bold hover:bg-red-50 transition-all">Reset Cache</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GLOBAL CUSTOM MODAL -->
    <div id="global-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="window.closeGlobalModal()"></div>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 relative z-10 transform transition-all scale-100 animate-slide-up mx-4">
            <div class="mb-4">
                <div id="global-modal-icon" class="w-12 h-12 rounded-2xl flex items-center justify-center mb-4 bg-slate-100 text-slate-600">
                    <i class="ph ph-info text-2xl"></i>
                </div>
                <h3 id="global-modal-title" class="text-xl font-bold text-slate-800 mb-2">Title</h3>
                <p id="global-modal-message" class="text-sm text-slate-600 leading-relaxed">Message content goes here.</p>
            </div>
            <div id="global-modal-actions" class="flex justify-end gap-3 pt-4 border-t border-slate-100"></div>
        </div>
    </div>

    <!-- SETUP INTERFACE -->
    <div id="setup-interface" class="fixed inset-0 z-[60] bg-slate-900/90 backdrop-blur-md flex items-center justify-center hidden overflow-y-auto py-10">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-2xl mx-4 border border-white/20 relative overflow-hidden animate-slide-up">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-gold-500 to-amber-300"></div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Setup Database</h2>
            <p class="text-sm text-slate-500 mb-6 tracking-tight">Kredensial Supabase Anda telah dimuat otomatis.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Project URL</label><input type="text" id="supabase-url" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium outline-none transition-all" value="https://cfnnibbzhbylykckhpiy.supabase.co"></div>
                <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Anon Key</label><input type="password" id="supabase-key" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium outline-none transition-all" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbm5pYmJ6aGJ5bHlrY2tocGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4OTAyMTAsImV4cCI6MjA4NjQ2NjIxMH0.Xuk9m85FQ8VrRjxyMeCxnx-3_8plOBVm9-Im9S41wPk"></div>
            </div>
            <div class="bg-slate-900 p-6 rounded-2xl mb-8">
                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i class="ph ph-warning text-gold-500"></i>
                    <span>Jalankan Script Ini di Supabase SQL Editor</span>
                </h4>
                <textarea id="sql-script" class="w-full h-32 p-4 bg-slate-800 text-emerald-400 border border-slate-700 rounded-xl text-xs font-mono outline-none resize-none leading-relaxed" readonly>
-- 1. Setup Extension & Tabel Utama
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE IF NOT EXISTS users ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, username TEXT UNIQUE, password TEXT, name TEXT, role TEXT );
CREATE TABLE IF NOT EXISTS employees ( 
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY, 
    nama TEXT, nip TEXT, jabatan TEXT, jenis_jabatan TEXT, golongan TEXT, 
    mk_pangkat_tahun INTEGER, mk_pangkat_bulan INTEGER, -- MK Pada SK Pangkat
    mk_gaji_tahun INTEGER, mk_gaji_bulan INTEGER,       -- MK Pada SK Berkala/Gaji
    tgl_lahir DATE, tmt_pangkat DATE, tmt_berkala DATE, 
    nilai_skp TEXT, hukuman_disiplin BOOLEAN, pendidikan TEXT, ujian_dinas BOOLEAN, 
    lastsync BIGINT 
);
CREATE TABLE IF NOT EXISTS proposals ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, empid UUID, empname TEXT, empnip TEXT, type TEXT, status TEXT, date TIMESTAMP, newtmt DATE, oldrank TEXT, newrank TEXT, newgaji BIGINT, newmktahun INTEGER, reduction INTEGER );
CREATE TABLE IF NOT EXISTS activity_logs ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, text TEXT, type TEXT, time TEXT, createdat BIGINT );
CREATE TABLE IF NOT EXISTS settings ( id TEXT PRIMARY KEY, signername TEXT, signernip TEXT, signerposition TEXT, signergolongan TEXT, logourl TEXT, regulation TEXT, effectivedate TEXT, ranges JSONB, updatedat BIGINT, updatedby TEXT );

-- 2. Data Awal Admin (Username: admin, Pass: admin123)
INSERT INTO users (username, password, name, role) VALUES ('admin', 'admin123', 'Administrator', 'admin') ON CONFLICT (username) DO NOTHING;

-- 3. Buka Akses RLS (Untuk Prototype)
ALTER TABLE users DISABLE ROW LEVEL SECURITY; 
ALTER TABLE employees DISABLE ROW LEVEL SECURITY; 
ALTER TABLE proposals DISABLE ROW LEVEL SECURITY; 
ALTER TABLE activity_logs DISABLE ROW LEVEL SECURITY; 
ALTER TABLE settings DISABLE ROW LEVEL SECURITY;
                </textarea>
                <button onclick="window.copySQL()" class="mt-2 text-[10px] text-blue-400 hover:text-blue-300 font-bold flex items-center gap-1"><i class="ph ph-copy"></i> Salin Script</button>
            </div>
            <button onclick="window.saveLocalConfig()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-sm shadow-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-2"><i class="ph ph-plug"></i> Simpan & Muat Ulang</button>
        </div>
    </div>

    <!-- LOGIN INTERFACE -->
    <div id="login-interface" class="fixed inset-0 z-50 flex hidden bg-white">
        <!-- SISI KIRI: INFORMASI INSTANSI -->
        <div class="hidden lg:flex w-7/12 bg-navy-900 relative flex-col justify-between p-16 text-white overflow-hidden group">
            <div class="absolute inset-0 z-0">
                <img id="login-bg-img" src="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover opacity-30 mix-blend-overlay filter grayscale transition-transform duration-[20s] group-hover:scale-105">
                <div class="absolute inset-0 bg-gradient-to-br from-navy-900/95 via-navy-900/90 to-blue-900/60"></div>
                <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fbbf24 1px, transparent 1px); background-size: 24px 24px;"></div>
            </div>
            <div class="relative z-10 flex items-center gap-5 animate-fade-in">
                <div>
                    <h3 class="font-bold text-xl tracking-wide leading-tight border-l-4 border-gold-500 pl-4">PEMERINTAH PROVINSI<br>KALIMANTAN SELATAN</h3>
                </div>
            </div>
            <div class="relative z-10 space-y-8 max-w-2xl animate-slide-up">
                <div>
                    <span class="inline-block px-4 py-1.5 bg-gold-500/20 border border-gold-500/30 text-gold-400 text-xs font-bold uppercase tracking-wider rounded-full mb-4">Portal Internal</span>
                    <h1 class="text-6xl font-extrabold leading-tight text-white mb-3">SIKAJI <span class="text-gold-500">ASN</span></h1>
                    <p class="text-xl text-slate-300 font-light">Sistem Informasi Kenaikan Pangkat & Gaji Berkala ASN</p>
                </div>
                <div class="w-24 h-1.5 bg-gold-500 rounded-full"></div>
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-white">UPTD Laboratorium Bahan Konstruksi</h2>
                    <p class="text-sm text-slate-300 leading-relaxed text-justify opacity-90 font-light pr-12">Laboratorium Bahan Konstruksi merupakan UPTD Dinas Pekerjaan Umum dan Penataan Ruang Provinsi Kalimantan Selatan...</p>
                </div>
            </div>
            <div class="relative z-10 border-t border-white/10 pt-8">
                <div class="flex flex-col gap-4 text-sm text-slate-400">
                    <div class="flex items-start gap-3"><i class="ph ph-map-pin text-gold-500 text-xl shrink-0"></i><span>Jl. Yos Sudarso No. 35, Kel. Telaga Biru, Kec. Banjarmasin Barat, Kota Banjarmasin</span></div>
                </div>
            </div>
        </div>
        <!-- SISI KANAN: FORM LOGIN -->
        <div class="w-full lg:w-5/12 flex items-center justify-center p-8 lg:p-12 relative bg-white">
             <div class="absolute inset-0 lg:hidden z-0"><img src="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover opacity-5"><div class="absolute inset-0 bg-gradient-to-b from-white via-white/95 to-slate-50/90"></div></div>
            <div class="w-full max-w-xs relative z-10">
                <div class="text-center mb-12 lg:text-left"><h2 class="text-3xl font-extrabold text-navy-900 mb-2">Selamat Datang</h2><p class="text-slate-500 text-sm">Silakan login untuk mengakses dashboard kepegawaian.</p></div>
                <form onsubmit="event.preventDefault(); window.performLogin();" class="space-y-6">
                    <div class="space-y-2"><label class="block text-xs font-bold text-slate-700 uppercase tracking-wide">Username</label><div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph ph-user text-slate-400 group-focus-within:text-gold-500 transition-colors text-lg"></i></div><input type="text" id="login-username" class="w-full pl-11 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 text-sm focus:ring-2 focus:ring-gold-500/20 focus:border-gold-500 focus:bg-white outline-none transition-all placeholder-slate-400" placeholder="Username (admin)" required></div></div>
                    <div class="space-y-2"><label class="block text-xs font-bold text-slate-700 uppercase tracking-wide">Password</label><div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph ph-lock-key text-slate-400 group-focus-within:text-gold-500 transition-colors text-lg"></i></div><input type="password" id="login-password" class="w-full pl-11 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 text-sm focus:ring-2 focus:ring-gold-500/20 focus:border-gold-500 focus:bg-white outline-none transition-all placeholder-slate-400" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div></div>
                    <button type="submit" class="w-full bg-navy-900 text-white py-4 rounded-xl font-bold text-sm shadow-xl shadow-navy-900/10 hover:bg-navy-800 hover:shadow-navy-900/20 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 group"><span>Masuk Aplikasi</span><i class="ph ph-arrow-right font-bold group-hover:translate-x-1 transition-transform"></i></button>
                </form>
                <div class="mt-8 text-center lg:text-left pt-6 border-t border-slate-100"><p class="text-[10px] text-slate-400 mb-2">Mengalami kendala login? Hubungi Administrator.</p></div>
            </div>
            <div class="absolute bottom-4 right-4 lg:right-8 text-right"><p class="text-[10px] text-slate-300">v2.1 Production</p></div>
        </div>
    </div>

    <!-- APP INTERFACE -->
    <div id="app-interface" class="hidden flex h-screen w-full bg-luxury-pattern">
        <!-- SIDEBAR -->
        <aside class="w-72 glass-dark text-slate-300 flex flex-col shrink-0 z-30 transition-all duration-300" id="sidebar">
            <div class="p-8 flex items-center gap-4 border-b border-white/5 relative overflow-hidden">
                <div class="w-10 h-10 bg-gradient-to-br from-gold-400 to-yellow-600 rounded-xl flex items-center justify-center text-white font-bold text-xl relative z-10">S</div>
                <div class="relative z-10"><h1 class="font-bold tracking-tight text-white text-lg">SIKAJI ASN</h1><p class="text-[10px] text-gold-400 font-medium tracking-wide">Enterprise Edition</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1.5 custom-scrollbar">
                <button onclick="window.nav('dashboard')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group sidebar-item-active" id="nav-dashboard"><i class="ph ph-squares-four text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Dashboard</span></button>
                <button onclick="window.nav('pegawai')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-pegawai"><i class="ph ph-users text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Data Pegawai</span></button>
                <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-8 h-px bg-slate-700"></span> Layanan Karir</div>
                <button onclick="window.nav('usulan-pangkat')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group relative" id="nav-usulan-pangkat"><i class="ph ph-trend-up text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Usulan Pangkat</span><span id="badge-pangkat" class="hidden ml-auto bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-lg shadow-blue-500/30">0</span></button>
                <button onclick="window.nav('usulan-kgb')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group relative" id="nav-usulan-kgb"><i class="ph ph-money text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Usulan KGB</span><span id="badge-kgb" class="hidden ml-auto bg-emerald-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-lg shadow-emerald-500/30">0</span></button>
                <button onclick="window.nav('verifikasi')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group relative" id="nav-verifikasi"><i class="ph ph-check-circle text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Verifikasi Usulan</span><span id="badge-verif" class="hidden ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md shadow-lg shadow-red-500/30">0</span></button>
                <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-8 h-px bg-slate-700"></span> Laporan & Sistem</div>
                <button onclick="window.nav('laporan')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-laporan"><i class="ph ph-file-pdf text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Pusat Laporan</span></button>
                <button onclick="window.nav('simulation')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-simulation"><i class="ph ph-calculator text-xl group-hover:text-gold-400 transition-colors"></i> <span class="font-medium text-sm">Simulasi Karir</span></button>
                <button onclick="window.nav('salary')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-salary"><i class="ph ph-table text-xl group-hover:text-gold-400"></i> <span class="font-medium text-sm">Standar Gaji</span></button>
                <button onclick="window.nav('pensiun')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-pensiun"><i class="ph ph-hourglass-high text-xl group-hover:text-gold-400"></i> <span class="font-medium text-sm">Monitoring Pensiun</span></button>
                <button onclick="window.nav('settings')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group" id="nav-settings"><i class="ph ph-gear text-xl group-hover:text-gold-400"></i> <span class="font-medium text-sm">Pengaturan</span></button>
                <button onclick="window.nav('update-data')" class="w-full text-left px-4 py-3.5 rounded-xl hover:bg-white/5 hover:text-white flex items-center gap-3 transition-all group text-red-400 hover:bg-red-500/10" id="nav-update-data"><i class="ph ph-database-gear text-xl"></i> <span class="font-medium text-sm">Manajemen Data</span></button>
            </nav>
            <div class="p-6 border-t border-white/5 bg-slate-900/50"><div class="flex items-center gap-3 mb-4"><img src="https://ui-avatars.com/api/?name=Admin+Sikaji&background=d97706&color=fff" class="w-10 h-10 rounded-full border-2 border-slate-700 shadow-md" id="user-avatar-display"><div class="overflow-hidden"><p class="text-sm font-bold text-white truncate" id="user-name-display">Administrator</p><p class="text-[10px] text-slate-400 truncate">Kepegawaian</p></div></div><button onclick="window.performLogout()" class="w-full py-2 bg-slate-800 hover:bg-red-900/30 text-slate-400 hover:text-red-400 rounded-lg text-xs font-bold transition-all border border-slate-700 flex items-center justify-center gap-2"><i class="ph ph-sign-out text-lg"></i> Keluar Aplikasi</button></div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            <header class="h-20 px-8 z-20 shrink-0 flex items-center justify-between sticky top-0 bg-white/70 backdrop-blur-xl border-b border-white/50 shadow-sm transition-all">
                <div class="flex items-center gap-4">
                    <div class="md:hidden p-2 bg-white rounded-lg shadow-sm border border-slate-200 text-slate-600"><i class="ph ph-list text-xl"></i></div>
                    <div><h2 id="page-title" class="text-xl font-bold text-slate-800 tracking-tight">Dashboard Eksekutif</h2><p class="text-xs text-slate-500 hidden md:block">Selamat datang kembali di panel kontrol.</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex flex-col items-end mr-2">
                        <div id="date-display" class="text-xs font-bold text-slate-500 uppercase tracking-wide"></div>
                        <div class="flex items-center gap-1.5"><i class="ph ph-clock text-slate-400 text-xs"></i><div id="clock" class="text-sm font-mono font-bold text-slate-800"></div><span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 rounded border border-slate-200">WITA</span></div>
                    </div>
                    <div class="h-10 w-px bg-slate-200 mx-2 hidden md:block"></div>
                    <div class="px-4 py-2 bg-white text-emerald-600 rounded-xl text-xs font-bold border border-emerald-100 flex items-center gap-2 shadow-sm"><span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span></span> <span id="regulation-badge">Regulasi 2024</span></div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth" id="content-area">
                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="space-y-8 animate-fade-in">
                    <div class="bg-gradient-to-br from-navy-900 to-navy-800 p-8 md:p-10 rounded-3xl shadow-2xl relative overflow-hidden group text-white">
                        <div class="relative z-10 max-w-2xl"><h2 class="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-300">Selamat Datang di SIKAJI ASN ðŸ‘‹</h2><p class="text-slate-400 mb-8 leading-relaxed">Sistem terintegrasi Cloud dengan keamanan tingkat tinggi. Data gaji dan karir telah disesuaikan secara otomatis dengan regulasi terbaru.</p><div class="flex gap-3"><button onclick="window.nav('pegawai')" class="bg-gold-500 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg shadow-gold-500/20 hover:shadow-gold-500/40 hover:-translate-y-1 transition-all flex items-center gap-2"><i class="ph ph-users-three text-lg"></i> Kelola Pegawai</button><button onclick="window.nav('laporan')" class="bg-white/10 backdrop-blur-md text-white border border-white/20 px-6 py-3 rounded-xl text-sm font-bold hover:bg-white/20 transition-all">Lihat Laporan</button></div></div>
                        <div class="absolute right-0 top-0 w-96 h-96 bg-gold-500 rounded-full blur-[120px] -mr-20 -mt-40 opacity-20 group-hover:opacity-30 transition-opacity duration-700"></div><i class="ph ph-crown absolute right-12 bottom-12 text-9xl text-white opacity-5 rotate-12 group-hover:rotate-0 group-hover:scale-110 transition-all duration-700"></i>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass p-6 rounded-2xl relative overflow-hidden group hover:-translate-y-1 transition-all duration-300"><div class="flex justify-between items-start mb-4"><div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i class="ph ph-users-three text-2xl"></i></div><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-md">TOTAL</span></div><div class="text-4xl font-bold text-slate-800 mb-1" id="stat-total">0</div><div class="text-slate-500 text-sm font-medium">Pegawai Aktif</div></div>
                        <div class="glass p-6 rounded-2xl relative overflow-hidden group hover:-translate-y-1 transition-all duration-300"><div class="flex justify-between items-start mb-4"><div class="p-3 bg-emerald-50 text-emerald-600 rounded-xl"><i class="ph ph-trend-up text-2xl"></i></div><span class="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-2 py-1 rounded-md">PANGKAT</span></div><div class="text-4xl font-bold text-slate-800 mb-1" id="stat-pangkat">0</div><div class="text-slate-500 text-sm font-medium">Eligible</div></div>
                        <div class="glass p-6 rounded-2xl relative overflow-hidden group hover:-translate-y-1 transition-all duration-300"><div class="flex justify-between items-start mb-4"><div class="p-3 bg-purple-50 text-purple-600 rounded-xl"><i class="ph ph-money text-2xl"></i></div><span class="text-[10px] font-bold bg-purple-50 text-purple-600 px-2 py-1 rounded-md">KGB</span></div><div class="text-4xl font-bold text-slate-800 mb-1" id="stat-kgb">0</div><div class="text-slate-500 text-sm font-medium">Eligible</div></div>
                        <div onclick="window.nav('verifikasi')" class="bg-gradient-to-br from-gold-500 to-amber-600 p-6 rounded-2xl text-white relative overflow-hidden group cursor-pointer hover:shadow-xl hover:shadow-gold-500/20 hover:-translate-y-1 transition-all duration-300"><div class="flex justify-between items-start mb-4 relative z-10"><div class="p-3 bg-white/20 backdrop-blur-sm rounded-xl"><i class="ph ph-stamp text-2xl"></i></div><span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded-md animate-pulse">ACTION</span></div><div class="text-4xl font-bold mb-1 relative z-10" id="hero-pending-count">0</div><div class="text-gold-100 text-sm font-medium relative z-10">Menunggu Verifikasi</div><div class="absolute -right-4 -bottom-4 bg-white/10 w-32 h-32 rounded-full blur-2xl"></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass p-6 rounded-2xl flex items-center gap-5 border-l-4 border-emerald-500">
                            <div class="p-4 bg-emerald-50 text-emerald-600 rounded-full"><i class="ph ph-coins text-3xl"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Estimasi Belanja Gaji (Bulan)</p><div class="text-2xl font-bold text-slate-800 mt-1" id="stat-total-gaji">Rp 0</div><p class="text-[10px] text-emerald-600 mt-0.5 flex items-center gap-1"><i class="ph ph-info"></i> Gaji Pokok Only</p></div>
                        </div>
                        <div class="glass p-6 rounded-2xl flex items-center gap-5 border-l-4 border-red-500">
                            <div class="p-4 bg-red-50 text-red-600 rounded-full"><i class="ph ph-hourglass-low text-3xl"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pensiun Tahun Ini</p><div class="text-2xl font-bold text-slate-800 mt-1" id="stat-pensiun-year">0 Pegawai</div><p class="text-[10px] text-red-600 mt-0.5 cursor-pointer hover:underline" onclick="window.nav('pensiun')">Lihat Detail &rarr;</p></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass p-8 rounded-3xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i class="ph ph-chart-bar text-xl text-blue-500"></i> Distribusi Golongan</h3></div><div class="h-72 w-full relative"><canvas id="chart-golongan"></canvas></div></div>
                        <div class="glass p-8 rounded-3xl flex flex-col justify-center items-center"><h3 class="font-bold text-slate-800 text-lg mb-4">Komposisi Jabatan</h3><div class="h-48 w-48 relative"><canvas id="chart-jabatan"></canvas></div><div class="mt-4 text-center text-xs text-slate-500">Struktural vs Fungsional vs Pelaksana</div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="glass p-6 rounded-3xl">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-warning-circle text-amber-500 text-lg"></i> Segera Naik Pangkat</h3><button onclick="window.nav('usulan-pangkat')" class="text-xs text-amber-600 font-bold hover:underline">Lihat Semua</button></div>
                            <div id="priority-list-container" class="space-y-3"><p class="text-xs text-slate-400 italic text-center py-4">Tidak ada data prioritas.</p></div>
                         </div>
                         <div class="glass p-6 rounded-3xl flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-slate-400 text-lg"></i> Log Aktivitas</h3><button onclick="window.loadData()" class="text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded-lg transition-colors"><i class="ph ph-arrows-clockwise"></i> Refresh</button></div>
                            <div class="flex-1 overflow-y-auto pr-2 max-h-[200px] space-y-3 custom-scrollbar" id="activity-log-container"></div>
                        </div>
                    </div>
                </div>

                <!-- PEGAWAI VIEW -->
                <div id="view-pegawai" class="hidden space-y-6 animate-fade-in">
                    <div class="glass p-6 rounded-3xl flex flex-col md:flex-row justify-between items-center gap-4">
                        <div><h2 class="font-bold text-xl text-slate-800">Direktori Pegawai</h2><p class="text-sm text-slate-500 mt-1">Kelola data pegawai dengan mudah.</p></div>
                        <div class="flex gap-3 w-full md:w-auto"><div class="relative flex-1 md:w-64"><i class="ph ph-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i><input type="text" id="search-pegawai" onkeyup="window.renderPegawai()" placeholder="Cari Nama / NIP..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none w-full sm:w-64"></div><button onclick="window.openAddEmployeeModal()" class="bg-navy-900 text-white px-5 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-navy-800 flex items-center gap-2 transition-all"><i class="ph ph-plus-circle text-lg"></i> Tambah</button></div>
                    </div>
                    <div class="glass rounded-3xl overflow-hidden shadow-sm">
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th class="p-5 pl-8">Pegawai</th><th class="p-5">Jabatan & Golongan</th><th class="p-5">Target Kenaikan (YAD)</th><th class="p-5 text-center">Masa Kerja</th><th class="p-5 text-right">Gaji Pokok (<span class="regulation-text">Regulasi</span>)</th><th class="p-5 text-center">Aksi</th></tr></thead><tbody id="table-pegawai-body" class="divide-y divide-slate-100 bg-white/50"></tbody></table></div><div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-center text-xs text-slate-500 font-medium"><span id="pegawai-count">Menampilkan data pegawai</span></div></div>
                </div>

                <!-- USULAN VIEW -->
                <div id="view-usulan" class="hidden space-y-6 animate-fade-in"><div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-3xl p-10 text-white shadow-2xl relative overflow-hidden"><div class="relative z-10"><h2 class="text-3xl font-bold mb-2" id="usulan-title">Periodisasi KP</h2><p class="text-blue-100 text-sm max-w-xl">Sistem otomatis mendeteksi pegawai yang memenuhi syarat (Eligible) berdasarkan perhitungan Masa Kerja Golongan dan regulasi BKN.</p><div class="mt-6 inline-flex items-center gap-2 bg-white/10 backdrop-blur-md border border-white/20 px-4 py-2 rounded-xl"><i class="ph ph-check-circle text-gold-400 text-xl"></i><span class="font-bold text-lg" id="usulan-count">0</span> <span class="text-xs opacity-80 uppercase tracking-wide font-bold pt-1">Pegawai Eligible</span></div></div><div class="absolute right-0 top-0 w-64 h-64 bg-white rounded-full blur-[100px] opacity-10"></div></div><div class="glass rounded-3xl overflow-hidden"><div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><h4 class="font-bold text-slate-700">Daftar Nominatif</h4><input type="text" id="search-usulan" onkeyup="window.filterUsulanTable()" placeholder="Filter..." class="pl-4 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-xs w-64 focus:ring-2 focus:ring-blue-500/20 outline-none"></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-5 pl-8 w-1/3">Pegawai</th><th class="p-5 w-1/3">Estimasi</th><th class="p-5 text-center">Analisis</th><th class="p-5 text-right pr-8">Aksi</th></tr></thead><tbody id="table-usulan-body" class="divide-y divide-slate-100 bg-white/50"></tbody></table></div></div>
                <div id="view-verifikasi" class="hidden space-y-6 animate-fade-in"><div class="flex justify-between items-end"><div><h2 class="font-bold text-2xl text-slate-800">Antrian Verifikasi</h2><p class="text-slate-500 text-sm">Validasi usulan kenaikan pangkat & gaji berkala.</p></div><button onclick="window.printGeneralReport('PENDING')" class="bg-white border border-slate-200 text-slate-700 px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2"><i class="ph ph-printer"></i> Cetak Daftar</button></div><div class="glass rounded-3xl overflow-hidden shadow-sm"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-5 pl-8">Tgl Usulan</th><th class="p-5">Jenis</th><th class="p-5">Pegawai</th><th class="p-5">Detail Perubahan</th><th class="p-5 text-center">Status</th><th class="p-5 text-right pr-8">Kontrol</th></tr></thead><tbody id="table-verifikasi-body" class="divide-y divide-slate-100 bg-white/50"></tbody></table></div></div>
                <div id="view-simulation" class="hidden space-y-6 animate-fade-in"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200"><h3 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2"><i class="ph ph-sliders-horizontal text-gold-500"></i> Parameter Simulasi</h3><div class="space-y-5"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Golongan Saat Ini</label><select id="sim-golongan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:ring-2 focus:ring-gold-500/20 outline-none"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Tahun</label><input type="number" id="sim-mk-tahun" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-slate-50 outline-none" value="0"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Bulan</label><input type="number" id="sim-mk-bulan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-slate-50 outline-none" value="0"></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Pangkat Terakhir</label><input type="date" id="sim-tmt-pangkat" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-slate-50 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Berkala Terakhir</label><input type="date" id="sim-tmt-berkala" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-slate-50 outline-none"></div><button onclick="window.runSimulation()" class="w-full py-3.5 bg-navy-900 hover:bg-navy-800 text-white rounded-xl font-bold shadow-lg transition-colors flex items-center justify-center gap-2 mt-2"><i class="ph ph-magic-wand text-lg"></i> Hitung Proyeksi</button></div></div><div class="lg:col-span-2 space-y-6"><div id="sim-result-header" class="hidden bg-slate-800 text-white p-6 rounded-2xl shadow-lg"><h4 class="text-lg font-bold">Hasil Proyeksi Karir (10 Tahun)</h4><p class="text-slate-300 text-sm">Estimasi kenaikan berdasarkan regulasi PerBKN 4/2025.</p></div><div id="sim-timeline" class="space-y-4 relative"><div class="text-center text-slate-400 py-20 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-3xl bg-slate-50/50"><i class="ph ph-chart-line-up text-4xl mb-2 text-slate-300"></i><p>Masukkan parameter di sebelah kiri<br>untuk melihat hasil simulasi.</p></div></div></div></div></div>
                <div id="view-laporan" class="hidden space-y-6 animate-fade-in"><div class="flex items-center justify-between"><div><h3 class="font-bold text-slate-800 text-xl">Pusat Laporan</h3><p class="text-slate-500 text-sm">Cetak dokumen rekapitulasi kepegawaian dan usulan.</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="glass p-8 rounded-3xl hover:shadow-lg transition-all group cursor-pointer text-center" onclick="window.printGeneralReport('ALL')"><div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 mb-6 mx-auto group-hover:scale-110 transition-transform"><i class="ph ph-users-three text-3xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Daftar Nominatif</h4><p class="text-sm text-slate-500 mb-6">Rekapitulasi seluruh data pegawai aktif.</p><button class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800">Cetak</button></div><div class="glass p-8 rounded-3xl hover:shadow-lg transition-all group cursor-pointer text-center" onclick="window.printGeneralReport('APPROVED')"><div class="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 mb-6 mx-auto group-hover:scale-110 transition-transform"><i class="ph ph-check-fat text-3xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Laporan SK Terbit</h4><p class="text-sm text-slate-500 mb-6">Daftar usulan yang telah disetujui.</p><button class="w-full py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50">Cetak</button></div><div class="glass p-8 rounded-3xl hover:shadow-lg transition-all group cursor-pointer text-center" onclick="window.printGeneralReport('PENDING')"><div class="w-16 h-16 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-600 mb-6 mx-auto group-hover:scale-110 transition-transform"><i class="ph ph-clock-countdown text-3xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Antrian Verifikasi</h4><p class="text-sm text-slate-500 mb-6">Daftar usulan menunggu persetujuan.</p><button class="w-full py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50">Cetak</button></div></div></div>
                
                <!-- VIEW SALARY (UPDATED WITH CALCULATOR) -->
                <div id="view-salary" class="hidden space-y-6 animate-fade-in">
                    <!-- Calculator Widget -->
                    <div class="glass p-8 rounded-3xl border border-white/50 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph ph-calculator text-[150px] text-slate-800"></i></div>
                        <h3 class="font-bold text-slate-800 text-lg mb-6 relative z-10 flex items-center gap-2"><i class="ph ph-calculator text-emerald-500 text-xl"></i> Kalkulator Gaji Pokok</h3>
                        <div class="flex flex-col md:flex-row gap-6 items-end relative z-10">
                            <div class="flex-1 w-full">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Golongan Ruang</label>
                                <select id="calc-golongan" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500/20 shadow-sm transition-all" onchange="window.calculateQuickSalary()">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div class="flex-1 w-full">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Masa Kerja (Tahun)</label>
                                <input type="number" id="calc-mk" class="w-full p-4 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500/20 shadow-sm transition-all" value="0" min="0" max="33" oninput="window.calculateQuickSalary()">
                            </div>
                            <div class="flex-1 w-full bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-4 rounded-xl shadow-lg shadow-emerald-500/20 flex flex-col justify-center items-center">
                                <span class="text-[10px] font-bold uppercase opacity-80 tracking-wider">Estimasi Gaji Pokok</span>
                                <span id="calc-result" class="text-3xl font-bold font-mono tracking-tight mt-1">Rp 0</span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-2 text-[10px] text-slate-400 font-medium relative z-10 bg-slate-50/50 inline-block px-3 py-1 rounded-lg border border-slate-100">
                            <i class="ph ph-info"></i> Perhitungan merujuk pada tabel referensi Perpres No. 10 Tahun 2024.
                        </div>
                    </div>

                    <!-- Table Header -->
                    <div class="flex justify-between items-center mb-4 mt-8">
                        <div><h3 class="font-bold text-slate-800 text-xl">Tabel Referensi Lengkap</h3><p class="text-slate-500 text-sm">Penyesuaian gaji pokok berdasarkan Perpres No. 10 Tahun 2024.</p></div>
                        <div class="text-xs bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1.5 rounded-lg font-bold">Efektif: Jan 2024</div>
                    </div>
                    <div class="glass rounded-3xl overflow-hidden shadow-sm"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-navy-900 text-white font-bold border-b border-navy-800 uppercase text-xs"><tr><th class="p-5 pl-8">Golongan</th><th class="p-5">Pangkat</th><th class="p-5 text-center">MKG Min (0 Thn)</th><th class="p-5 text-center">MKG Maks</th><th class="p-5 text-right pr-8">Gaji Maksimal</th><th class="p-5 text-center">Opsi</th></tr></thead><tbody id="table-salary-body" class="divide-y divide-slate-100 bg-white/50"></tbody></table></div></div>
                </div>

                <div id="view-pensiun" class="hidden space-y-6 animate-fade-in"><div class="flex items-center justify-between"><h3 class="font-bold text-slate-700 text-xl">Monitoring Batas Usia Pensiun</h3><span class="text-xs bg-red-50 text-red-600 border border-red-100 px-3 py-1 rounded-full font-bold">BUP: 58 Tahun</span></div><div id="pensiun-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div class="glass rounded-3xl overflow-hidden shadow-sm mt-8"><div class="p-5 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700 text-sm">Daftar Lengkap Estimasi Pensiun</div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-5 pl-8">Pegawai</th><th class="p-5">Tanggal Lahir</th><th class="p-5 text-center">Usia Saat Ini</th><th class="p-5 text-center">Sisa Masa Kerja</th><th class="p-5">TMT Pensiun</th></tr></thead><tbody id="table-pensiun-body" class="divide-y divide-slate-100 bg-white/50"></tbody></table></div></div>
                <div id="view-update-data" class="hidden space-y-6 animate-fade-in"><div class="glass p-10 rounded-3xl shadow-sm"><div class="flex items-center gap-6 mb-8"><div class="w-14 h-14 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-600"><i class="ph ph-database-gear text-3xl"></i></div><div><h3 class="font-bold text-2xl text-slate-800">Pemutakhiran Data Sistem</h3><p class="text-slate-500 text-sm">Kelola referensi global dan sinkronisasi data pegawai dengan Postgres.</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="border border-slate-200 rounded-2xl p-6 hover:border-blue-500 hover:bg-blue-50/30 transition-all cursor-pointer group" onclick="window.updateSalaryReference()"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform"><i class="ph ph-table text-xl"></i></div><span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">Regulasi 2024</span></div><h4 class="font-bold text-slate-800 mb-1">Update Referensi Gaji</h4><p class="text-xs text-slate-500">Terapkan standar gaji pokok Perpres No. 10 Tahun 2024 ke database Supabase.</p></div><div class="border border-slate-200 rounded-2xl p-6 hover:border-emerald-500 hover:bg-emerald-50/30 transition-all cursor-pointer group" onclick="window.syncEmployeeData()"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform"><i class="ph ph-arrows-clockwise text-xl"></i></div><span class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-2 py-1 rounded">Sync</span></div><h4 class="font-bold text-slate-800 mb-1">Refresh Data Tabel</h4><p class="text-xs text-slate-500">Tarik ulang data terbaru dari server untuk memastikan sinkronisasi.</p></div><div class="border border-slate-200 rounded-2xl p-6 hover:border-purple-500 hover:bg-purple-50/30 transition-all cursor-pointer group" onclick="window.openAddEmployeeModal()"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 group-hover:scale-110 transition-transform"><i class="ph ph-user-plus text-xl"></i></div><span class="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded">Input</span></div><h4 class="font-bold text-slate-800 mb-1">Input Pegawai Baru</h4><p class="text-xs text-slate-500">Tambahkan data pegawai baru ke dalam database SQL.</p></div><div class="border border-slate-200 rounded-2xl p-6 hover:border-teal-500 hover:bg-teal-50/30 transition-all cursor-pointer group" onclick="window.nav('verifikasi')"><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-teal-100 rounded-xl flex items-center justify-center text-teal-600 group-hover:scale-110 transition-transform"><i class="ph ph-check-circle text-xl"></i></div><span class="text-[10px] font-bold bg-teal-100 text-teal-700 px-2 py-1 rounded">Approval</span></div><h4 class="font-bold text-slate-800 mb-1">Verifikasi Usulan</h4><p class="text-xs text-slate-500">Validasi perubahan data pangkat dan gaji berkala yang tertunda.</p></div></div><div class="mt-8 pt-6 border-t border-red-100"><h4 class="font-bold text-red-600 mb-4 flex items-center gap-2"><i class="ph ph-warning-octagon"></i> Zona Berbahaya</h4><div class="bg-red-50 p-6 rounded-2xl border border-red-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><h5 class="font-bold text-red-800">Hapus Keseluruhan Data Pegawai</h5><p class="text-xs text-red-600 mt-1">Menghapus seluruh rekaman dari tabel Supabase. Tindakan ini <strong>permanen</strong>.</p></div><button onclick="window.wipeDatabase()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-red-700 transition-all shrink-0 flex items-center gap-2"><i class="ph ph-trash"></i> Kosongkan Tabel</button></div></div></div></div>
                <div id="view-settings" class="hidden space-y-6 animate-fade-in"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="glass p-8 rounded-3xl"><h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b border-slate-100 pb-4"><i class="ph ph-lock-key text-xl text-gold-500"></i> Keamanan Akun</h4><div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200"><p class="text-sm text-slate-600 mb-2">Anda login sebagai: <strong id="settings-current-user">admin</strong></p></div><form onsubmit="event.preventDefault(); window.changePassword();" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Lama</label><input type="password" id="set-pass-old" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none" required></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Baru</label><input type="password" id="set-pass-new" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none" required></div></div><div class="flex justify-end"><button type="submit" class="bg-navy-900 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-navy-800 transition-all flex items-center gap-2 text-sm"><i class="ph ph-key"></i> Ganti Password</button></div></form></div><div class="glass p-8 rounded-3xl"><h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b border-slate-100 pb-4"><i class="ph ph-pen-nib text-xl text-gold-500"></i> Konfigurasi Tanda Tangan SK</h4><div class="mb-8 flex items-start gap-6 p-4 bg-slate-50 rounded-xl border border-slate-100"><div class="w-20 h-20 bg-white rounded-lg border border-slate-200 flex items-center justify-center p-2 shadow-sm overflow-hidden"><img id="settings-logo-preview" src="" class="w-full h-full object-contain"></div><div class="flex-1"><label class="block text-sm font-bold text-slate-700 mb-1">Logo Kop Surat</label><div class="flex gap-3"><label for="input-logo" class="cursor-pointer px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2"><i class="ph ph-upload-simple"></i> Upload Logo</label><input type="file" id="input-logo" accept="image/*" class="hidden" onchange="window.uploadLogo(event)"><button onclick="window.resetLogo()" class="px-3 py-1.5 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors">Reset Default</button></div></div></div><form id="form-settings" onsubmit="event.preventDefault(); window.saveSettings();"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Pejabat</label><input type="text" id="set-nama" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none" oninput="window.updateQRPreview()"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP Pejabat</label><input type="text" id="set-nip" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none" oninput="window.updateQRPreview()"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan Struktural</label><input type="text" id="set-jabatan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/50 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat/Golongan</label><select id="set-golongan" class="w-full p-3.5 border border-slate-200 rounded-xl bg-white text-sm focus:ring-2 focus:ring-gold-500/50 outline-none"></select></div></div><div class="mt-8 flex justify-end"><button type="submit" class="bg-navy-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-navy-800 transition-all flex items-center gap-2"><i class="ph ph-floppy-disk"></i> Simpan Konfigurasi</button></div></form></div></div><div class="glass p-8 rounded-3xl flex flex-col items-center justify-center text-center"><p class="text-xs font-bold text-slate-400 uppercase mb-6 tracking-wider">Preview Digital Signature</p><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 w-full max-w-[220px]"><img id="set-qr-preview" src="" class="w-full aspect-square object-contain mix-blend-multiply" alt="QR Validasi"></div><div class="text-xs text-slate-600 space-y-1"><p class="font-bold">Ditandatangani secara elektronik oleh:</p><p id="preview-nama-pejabat" class="font-medium text-slate-800 text-sm">...</p><p id="preview-nip-pejabat" class="font-mono text-[10px] text-slate-500">NIP. ...</p></div><div class="mt-6 flex items-center gap-2 text-[10px] text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100 font-bold"><i class="ph ph-shield-check text-lg"></i> Sertifikat Valid</div></div></div></div>

            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-add-employee" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm"><div class="absolute inset-0 bg-slate-900/60" onclick="window.closeAddEmployeeModal()"></div><div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-transform duration-300 m-4 flex flex-col max-h-[90vh]" id="modal-content"><div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10"><div><h3 class="text-xl font-bold text-slate-800" id="modal-title">Form Data Pegawai</h3><p class="text-xs text-slate-500 mt-1">Lengkapi data pegawai sesuai SK terakhir.</p></div><button onclick="window.closeAddEmployeeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="ph ph-x text-xl"></i></button></div><div class="flex-1 overflow-y-auto bg-slate-50/50 p-6 md:p-8"><form id="form-add-employee" class="space-y-8"><input type="hidden" id="input-id"><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-user-circle text-lg text-emerald-500"></i> Identitas Pegawai</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label><input id="input-nama" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/20 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP</label><input id="input-nip" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/20 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tgl Lahir</label><input type="date" id="input-lahir" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-gold-500/20 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pendidikan Terakhir</label><select id="input-pendidikan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-white outline-none"><option value="SD">SD/Sederajat</option><option value="SLTP">SLTP/Sederajat</option><option value="SLTA">SLTA/Diploma I</option><option value="D-II">D-II / SGPLB</option><option value="D-III">D-III / Sarjana Muda</option><option value="S1">S1 / D-IV</option><option value="S2">S2 / Spesialis I</option><option value="S3">S3 / Spesialis II</option></select></div></div></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-briefcase text-lg text-teal-500"></i> Data Jabatan & Pangkat</h4><div class="grid grid-cols-1 md:grid-cols-12 gap-6"><div class="md:col-span-7 space-y-6"><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenis</label><select id="input-jenis-jabatan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm bg-white outline-none"><option value="Umum">Pelaksana</option><option value="Fungsional">Fungsional</option><option value="Struktural">Struktural</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Jabatan</label><input id="input-jabatan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat</label><select id="input-golongan" onchange="window.previewGajiForm()" class="w-full p-3.5 border border-slate-200 rounded-xl bg-white text-sm outline-none"></select></div><div><label class="block text-[10px] font-bold text-emerald-600 uppercase mb-1">MK Golongan (SK Pangkat)</label><div class="flex gap-2"><input type="number" id="input-mk-pangkat-tahun" oninput="window.previewGajiForm()" onchange="window.previewGajiForm()" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-emerald-500" placeholder="Thn"><input type="number" id="input-mk-pangkat-bulan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-emerald-500" placeholder="Bln"></div></div><div><label class="block text-[10px] font-bold text-purple-600 uppercase mb-1">MK Gaji (SK KGB/Terakhir)</label><div class="flex gap-2"><input type="number" id="input-mk-gaji-tahun" oninput="window.previewGajiForm()" onchange="window.previewGajiForm()" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-purple-500" placeholder="Thn"><input type="number" id="input-mk-gaji-bulan" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:border-purple-500" placeholder="Bln"></div></div></div></div><div class="md:col-span-5 bg-slate-50 p-5 rounded-2xl border border-dashed border-slate-300 flex flex-col justify-center text-center"><p class="text-xs font-bold text-slate-400 uppercase mb-2">Gaji Pokok (<span class="regulation-text">...</span>)</p><div id="form-salary-preview" class="text-3xl font-bold text-slate-800 font-mono tracking-tight">Rp 0</div></div></div></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-xs font-bold text-emerald-600 uppercase mb-1">TMT Pangkat</label><input type="date" id="input-tmt-pangkat" class="w-full p-3.5 border border-emerald-200 bg-emerald-50/30 rounded-xl text-sm outline-none"></div><div><label class="block text-xs font-bold text-teal-600 uppercase mb-1">TMT Berkala</label><input type="date" id="input-tmt-berkala" class="w-full p-3.5 border border-teal-200 bg-teal-50/30 rounded-xl text-sm outline-none"></div></div><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nilai SKP</label><select id="input-skp" class="w-full p-3.5 border border-slate-200 rounded-xl bg-white text-sm outline-none"><option value="Sangat Baik">Sangat Baik</option><option value="Baik">Baik</option><option value="Cukup">Cukup</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status Disiplin / Ujian</label><div class="flex gap-4"><div class="flex-1"><label class="block text-[10px] text-slate-400 mb-1">Hukuman Disiplin</label><select id="input-hukuman" class="w-full p-3.5 border border-slate-200 rounded-xl bg-white text-sm outline-none"><option value="false">Tidak Ada</option><option value="true">Ada Hukuman</option></select></div><div class="flex-1"><label class="block text-[10px] text-slate-400 mb-1">Lulus Ujian Dinas</label><select id="input-ujian" class="w-full p-3.5 border border-slate-200 rounded-xl bg-white text-sm outline-none"><option value="false">Belum</option><option value="true">Sudah Lulus</option></select></div></div></div></div></div></div></form></div><div class="p-6 border-t border-slate-100 bg-white flex justify-end gap-3 sticky bottom-0 z-10"><button onclick="window.closeAddEmployeeModal()" class="px-6 py-3 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-100 transition-colors">Batal</button><button onclick="window.saveNewEmployee()" class="px-8 py-3 bg-navy-900 text-white rounded-xl font-bold text-sm hover:bg-navy-800 shadow-lg transition-all">Simpan Data</button></div></div></div>
    
    <div id="toast-container" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- CONSTANTS & CONFIGURATION ---
        const REGULATION_NAME = "Perpres No. 10 Tahun 2024";

        // --- FULL SALARY REFERENCE TABLE (PERPRES 10/2024 - LAMPIRAN) ---
        // DATA FIXED: Values exactly match the PDF attachments.
        const SALARY_REFERENCES = {
            'I/a': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26],
                salaries: [1685700, 1738800, 1793500, 1850000, 1908300, 1968400, 2030400, 2094300, 2160300, 2228300, 2298500, 2370900, 2445500, 2522600]
            },
            'I/b': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27],
                salaries: [1840800, 1898800, 1958600, 2020300, 2083900, 2149600, 2217300, 2287100, 2359100, 2433400, 2510100, 2589100, 2670700]
            },
            'I/c': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27],
                salaries: [1918700, 1979100, 2041500, 2105800, 2172100, 2240500, 2311100, 2383900, 2458900, 2536400, 2616300, 2698700, 2783700]
            },
            'I/d': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27],
                salaries: [1999900, 2062900, 2127800, 2194800, 2264000, 2335300, 2408800, 2484700, 2562900, 2643700, 2726900, 2812800, 2901400]
            },
            'II/a': {
                years: [0, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33],
                salaries: [2184000, 2252800, 2323700, 2396900, 2472400, 2550300, 2630600, 2713400, 2798900, 2887100, 2978000, 3071800, 3168500, 3268300, 3371200, 3477400, 3586900, 3643400]
            },
            'II/b': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33],
                salaries: [2385000, 2460100, 2537600, 2617500, 2700000, 2785000, 2872700, 2963200, 3056500, 3152800, 3252100, 3354500, 3460200, 3569100, 3681600, 3797500]
            },
            'II/c': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33],
                salaries: [2485900, 2564200, 2645000, 2728300, 2814200, 2902800, 2994300, 3088600, 3185800, 3286200, 3389700, 3496400, 3606500, 3720100, 3837300, 3958200]
            },
            'II/d': {
                years: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33],
                salaries: [2591100, 2672700, 2756800, 2843700, 2933200, 3025600, 3120900, 3219200, 3320600, 3425200, 3533100, 3644300, 3759100, 3877500, 3999600, 4125600]
            },
            'III/a': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [2785700, 2873500, 2964000, 3057300, 3153600, 3252900, 3355400, 3461100, 3570100, 3682500, 3798500, 3918100, 4041500, 4168800, 4300100, 4435500, 4575200]
            },
            'III/b': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [2903600, 2995000, 3089300, 3186600, 3287000, 3390500, 3497300, 3607500, 3721100, 3838300, 3959200, 4083900, 4212500, 4345100, 4482000, 4623200, 4768800]
            },
            'III/c': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3026400, 3121700, 3220000, 3321400, 3426000, 3533900, 3645200, 3760100, 3878500, 4000600, 4126600, 4256600, 4390700, 4528900, 4671600, 4818700, 4970500]
            },
            'III/d': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3154400, 3253700, 3356200, 3461900, 3571000, 3683400, 3799400, 3919100, 4042500, 4169900, 4301200, 4436700, 4576400, 4720500, 4869200, 5022500, 5180700]
            },
            'IV/a': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3287800, 3391400, 3498200, 3608400, 3722000, 3839200, 3960200, 4084900, 4213500, 4346200, 4483100, 4624300, 4770000, 4920200, 5075200, 5235000, 5399900]
            },
            'IV/b': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3426900, 3534800, 3646200, 3761000, 3879500, 4001600, 4127700, 4257700, 4391800, 4530100, 4672800, 4819900, 4971700, 5128300, 5289800, 5456400, 5628300]
            },
            'IV/c': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3571900, 3684400, 3800400, 3920100, 4043600, 4170900, 4302300, 4437800, 4577500, 4721700, 4870400, 5023800, 5182000, 5345200, 5513600, 5687200, 5866400]
            },
            'IV/d': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3723000, 3840300, 3961200, 4085900, 4214600, 4347300, 4484300, 4625500, 4771200, 4921400, 5076400, 5236300, 5401200, 5571400, 5746800, 5927800, 6114500]
            },
            'IV/e': {
                years: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32],
                salaries: [3880400, 4002700, 4128700, 4258700, 4392900, 4531200, 4673900, 4821100, 4973000, 5129600, 5291200, 5457800, 5629700, 5807000, 5989900, 6178600, 6373200]
            }
        };

        const MASTER_RANK={'I/a':'Juru Muda','I/b':'Juru Muda Tk.I','I/c':'Juru','I/d':'Juru Tk.I','II/a':'Pengatur Muda','II/b':'Pengatur Muda Tk.I','II/c':'Pengatur','II/d':'Pengatur Tk.I','III/a':'Penata Muda','III/b':'Penata Muda Tk.I','III/c':'Penata','III/d':'Penata Tk.I','IV/a':'Pembina','IV/b':'Pembina Tk.I','IV/c':'Pembina Utama Muda','IV/d':'Pembina Utama Madya','IV/e':'Pembina Utama'};
        const GOLONGAN = Object.keys(MASTER_RANK);

        const MAX_RANK_REGULER = {
            'SD': 'II/a',
            'SLTP': 'II/c',
            'SLTA': 'III/b',
            'D-II': 'III/b',
            'D-III': 'III/c',
            'S1': 'III/d', 
            'S2': 'IV/a',
            'S3': 'IV/b'
        };

        // --- SUPABASE SETUP ---
        let supabaseConfig = {
            url: "https://cfnnibbzhbylykckhpiy.supabase.co",
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbm5pYmJ6aGJ5bHlrY2tocGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4OTAyMTAsImV4cCI6MjA4NjQ2NjIxMH0.Xuk9m85FQ8VrRjxyMeCxnx-3_8plOBVm9-Im9S41wPk"
        };
        let supabase = null;
        let isConfigured = false;
        let isProcessLocked = false;

        const savedConfig = localStorage.getItem('sikaji_supabase_config');
        if (savedConfig) {
            try {
                supabaseConfig = JSON.parse(savedConfig);
            } catch (e) { console.error("Invalid saved config"); }
        }

        try {
            supabase = createClient(supabaseConfig.url, supabaseConfig.key);
            isConfigured = true;
        } catch (e) {
            console.error("Supabase config error", e);
            isConfigured = false;
        }

        // --- STATE ---
        let employees=[], proposals=[], activityLog=[], appSettings={
            signerName: 'Nama Pejabat', signerNIP: '19000000', signerPosition: 'Kepala Dinas', signerGolongan: 'IV/a', 
            logoUrl: "https://kalselprov.go.id/wp-content/uploads/2020/09/Logo-Kalsel.png"
        }, currentUser=null, chartGolongan=null, chartJabatan=null;

        // --- MODAL UTILS ---
        window.closeGlobalModal = () => document.getElementById('global-modal').classList.add('hidden');

        window.showModal = (title, message, type = 'alert', onConfirm = null, isDestructive = false) => {
            document.getElementById('global-modal-title').innerText = title;
            document.getElementById('global-modal-message').innerText = message;
            const actions = document.getElementById('global-modal-actions');
            actions.innerHTML = '';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = "px-4 py-2 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-100 transition-colors";
            cancelBtn.innerText = type === 'alert' ? 'Tutup' : 'Batal';
            cancelBtn.onclick = window.closeGlobalModal;
            actions.appendChild(cancelBtn);

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = `px-6 py-2 rounded-xl text-white font-bold text-sm shadow-lg transition-all ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-navy-900 hover:bg-navy-800'}`;
                confirmBtn.innerText = isDestructive ? 'Ya, Lanjutkan' : 'Konfirmasi';
                confirmBtn.onclick = () => {
                    window.closeGlobalModal();
                    if (onConfirm) onConfirm();
                };
                actions.appendChild(confirmBtn);
            }

            document.getElementById('global-modal').classList.remove('hidden');
        };

        // --- DATA LOADER ---
        window.loadData = async function() {
            if (!supabase) return;
            document.getElementById('app-loader').classList.remove('hidden');

            try {
                // 1. Load Settings
                const { data: setConfig } = await supabase.from('settings').select('*').eq('id', 'config').single();
                if (setConfig) {
                    appSettings.signerName = setConfig.signername || appSettings.signerName;
                    appSettings.signerNIP = setConfig.signernip || appSettings.signerNIP;
                    appSettings.signerPosition = setConfig.signerposition || appSettings.signerPosition;
                    appSettings.signerGolongan = setConfig.signergolongan || appSettings.signerGolongan;
                    appSettings.logoUrl = setConfig.logourl || appSettings.logoUrl;
                }
                
                // 2. Load Employees
                const { data: emps, error: empErr } = await supabase.from('employees').select('*');
                if (empErr) throw empErr;
                employees = (emps || []).map(e => ({
                    ...e,
                    mk_pangkat_tahun: e.mk_pangkat_tahun != null ? parseInt(e.mk_pangkat_tahun) : (parseInt(e.mk_tahun) || 0),
                    mk_pangkat_bulan: e.mk_pangkat_bulan != null ? parseInt(e.mk_pangkat_bulan) : (parseInt(e.mk_bulan) || 0),
                    mk_gaji_tahun: e.mk_gaji_tahun != null ? parseInt(e.mk_gaji_tahun) : (parseInt(e.mk_tahun) || 0),
                    mk_gaji_bulan: e.mk_gaji_bulan != null ? parseInt(e.mk_gaji_bulan) : (parseInt(e.mk_bulan) || 0),
                    tgl_lahir: e.tgl_lahir ? new Date(e.tgl_lahir) : new Date(),
                    tmt_pangkat: e.tmt_pangkat ? new Date(e.tmt_pangkat) : new Date(),
                    tmt_berkala: e.tmt_berkala ? new Date(e.tmt_berkala) : new Date()
                }));

                // 3. Load Proposals
                const { data: props, error: propErr } = await supabase.from('proposals').select('*');
                if (propErr) throw propErr;
                proposals = (props || []).map(p => ({
                    ...p,
                    date: p.date ? new Date(p.date) : new Date(),
                    newtmt: p.newtmt ? new Date(p.newtmt) : new Date()
                }));

                // 4. Load Activity Logs
                const { data: logs, error: logErr } = await supabase.from('activity_logs').select('*').order('createdat', { ascending: false }).limit(20);
                if (logErr) throw logErr;
                activityLog = logs || [];

                // Re-render UI Elements
                if(!document.getElementById('view-salary').classList.contains('hidden')) window.renderSalaryTable();
                if(!document.getElementById('view-pegawai').classList.contains('hidden')) window.renderPegawai();
                if(!document.getElementById('view-usulan').classList.contains('hidden')) window.renderUsulan(document.getElementById('usulan-title').innerText.includes('Pangkat') ? 'PANGKAT' : 'KGB');
                if(!document.getElementById('view-verifikasi').classList.contains('hidden')) window.renderVerifikasi();
                if(!document.getElementById('view-settings').classList.contains('hidden')) window.loadSettingsUI();
                
                window.renderActivityLog();
                window.updateDashboard();

                // Update Regulation Labels
                document.querySelectorAll('.regulation-text').forEach(el => el.innerText = REGULATION_NAME);
                const regBadge = document.getElementById('regulation-badge');
                if(regBadge) regBadge.innerText = REGULATION_NAME;

            } catch (err) {
                console.error("Failed fetching data:", err);
                if (err.message && (err.message.includes("relation") || err.message.includes("does not exist") || err.message.includes("column"))) {
                    document.getElementById('setup-interface').classList.remove('hidden');
                } else {
                    window.showToast("Gagal menarik data database", "error");
                }
            } finally {
                document.getElementById('app-loader').classList.add('hidden');
            }
        };

        // --- AUTH ---
        window.performLogin = async function() {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            
            if(!supabase) return window.showModal("Error", "Koneksi database belum diatur.");

            try {
                const { data, error } = await supabase.from('users').select('*').eq('username', u).eq('password', p).single();
                
                if (error || !data) {
                    window.showToast("Username atau Password salah!", "error");
                    return;
                }

                currentUser = data; 
                try { sessionStorage.setItem('sikaji_session', JSON.stringify(data)); } catch(e) {}
                
                document.getElementById('login-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=10b981&color=fff`;
                
                window.showToast(`Selamat datang, ${currentUser.name}!`); 
                window.nav('dashboard');

                await window.loadData();

            } catch (e) {
                console.error(e);
                window.showToast("Terjadi kesalahan saat login: " + e.message, "error");
            }
        };

        window.performLogout = function() { 
            window.showModal('Konfirmasi', 'Keluar aplikasi?', 'confirm', () => {
                sessionStorage.removeItem('sikaji_session'); currentUser=null; location.reload();
            });
        };

        window.changePassword = async function() {
            const oldP = document.getElementById('set-pass-old').value;
            const newP = document.getElementById('set-pass-new').value;

            if (currentUser.password !== oldP) {
                return window.showModal("Gagal", "Password lama salah!");
            }

            try {
                const { error } = await supabase.from('users').update({ password: newP }).eq('id', currentUser.id);
                if (error) throw error;
                
                currentUser.password = newP;
                sessionStorage.setItem('sikaji_session', JSON.stringify(currentUser));
                
                window.showModal("Sukses", "Password berhasil diubah!");
                document.getElementById('set-pass-old').value = '';
                document.getElementById('set-pass-new').value = '';
            } catch(e) {
                window.showModal("Error", "Gagal mengubah password: " + e.message);
            }
        };

        function checkSession() {
            if (!isConfigured) return;
            try {
                const session = sessionStorage.getItem('sikaji_session');
                if (session) {
                    currentUser = JSON.parse(session);
                    document.getElementById('login-interface').classList.add('hidden');
                    document.getElementById('app-interface').classList.remove('hidden');
                    document.getElementById('user-name-display').innerText = currentUser.name;
                    document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=10b981&color=fff`;
                    window.nav('dashboard');
                    window.loadData();
                } else {
                    document.getElementById('login-interface').classList.remove('hidden');
                    document.getElementById('app-loader').classList.add('hidden');
                    document.getElementById('app-interface').classList.add('hidden');
                }
            } catch(e) {
                console.error("Session check failed", e);
                sessionStorage.removeItem('sikaji_session');
                document.getElementById('login-interface').classList.remove('hidden');
                document.getElementById('app-loader').classList.add('hidden');
            }
        }

        // --- UTILS ---
        function fmtMoney(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n); }
        
        function fmtDate(d) {
            if (!d) return '-';
            const dateObj = new Date(d);
            if (isNaN(dateObj.getTime())) return '-';
            return dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // --- SALARY CALCULATION LOGIC ---
        function calcGaji(g, mk) { 
            const data = SALARY_REFERENCES[g];
            if (!data || !data.years || !data.salaries) return 0;
            
            let targetMK = parseInt(mk, 10);
            if (isNaN(targetMK)) targetMK = 0;
            
            // LOGIC UPDATE: Menghapus pembatasan manual Minimal/Maksimal.
            // Menggunakan murni lookup data yang tersedia.

            // Iterate backwards to find the highest year <= targetMK (Floor Lookup)
            // Jika targetMK > max year tabel, loop akan langsung ketemu di index terakhir (max gaji).
            // Jika targetMK < min year tabel, loop selesai tanpa hasil -> return 0.
            for (let i = data.years.length - 1; i >= 0; i--) {
                if (data.years[i] <= targetMK) {
                    return data.salaries[i];
                }
            }
            
            return 0; // Jika MK di bawah tahun minimum tabel (misal MK 0 untuk Gol I/b)
        }

        function getEffectiveSalary(e) {
            const gajiPangkat = calcGaji(e.golongan, e.mk_pangkat_tahun);
            const gajiBerkala = calcGaji(e.golongan, e.mk_gaji_tahun);
            return Math.max(gajiPangkat, gajiBerkala);
        }

        function nextRank(c) { const i=GOLONGAN.indexOf(c); return (i!==-1 && i<GOLONGAN.length-1) ? GOLONGAN[i+1] : c; }
        
        function getTenure(d) { return Math.floor(Math.abs(new Date()-d)/(1000*60*60*24*365.25)); }
        
        function getAge(d) { const n=new Date(); let a=n.getFullYear()-d.getFullYear(); if(n.getMonth()<d.getMonth()||(n.getMonth()===d.getMonth()&&n.getDate()<d.getDate())) a--; return a; }
        
        function getBUP(jabatan, jenis) {
            const j = (jabatan || '').toLowerCase();
            const t = (jenis || '').toLowerCase();
            if (j.includes('ahli utama')) return 65;
            if (j.includes('ahli madya') || (t === 'struktural' && (j.includes('kepala dinas') || j.includes('kepala badan') || j.includes('asisten')))) return 60;
            return 58;
        }

        function getTmtPensiun(d, jab, jenis) { 
            const bup = getBUP(jab, jenis);
            let t = new Date(d); 
            t.setFullYear(t.getFullYear() + bup); 
            t.setMonth(t.getMonth() + 1); 
            t.setDate(1); 
            return t; 
        }
        
        function getReductionYears(o, n) { const mo=o.split('/')[0], mn=n.split('/')[0]; return (mo==='I'&&mn==='II')?6:(mo==='II'&&mn==='III')?5:(mo==='III'&&mn==='IV')?4:0; }
        
        window.showToast = function(m, t='success') { 
            const c=document.getElementById('toast-container'), d=document.createElement('div'); d.className=`${t==='success'?'bg-slate-800':'bg-red-600'} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up min-w-[300px] z-[100]`; d.innerHTML=`<i class="ph ${t==='success'?'ph-check-circle':'ph-warning-circle'} text-xl"></i><span class="font-medium text-sm">${m}</span>`; c.appendChild(d); setTimeout(() => { d.style.opacity='0'; setTimeout(()=>d.remove(),300); }, 3000); 
        };
        
        async function addActivity(text, type='info') {
            if(!supabase) return;
            try {
                await supabase.from('activity_logs').insert([{
                    text, type, time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}), createdat: Date.now()
                }]);
            } catch(e) { console.error("Log error", e); }
        }

        // --- SETUP LOGIC ---
        window.saveLocalConfig = async function() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if(!url || !key) return window.showModal("Error", "Mohon lengkapi URL dan Key Supabase!");

            document.getElementById('loader-text').innerText = "Menguji Koneksi Supabase...";
            document.getElementById('app-loader').classList.remove('hidden');

            const tempSupabase = createClient(url, key);
            const { error } = await tempSupabase.from('employees').select('id').limit(1);

            document.getElementById('app-loader').classList.add('hidden');

            if (error && error.code === 'PGRST116') {
                window.showModal("Peringatan", "Koneksi berhasil, tetapi tabel belum dibuat!\n\nMohon jalankan script SQL yang disediakan di tab SQL Editor pada dashboard Supabase Anda terlebih dahulu.");
            } else if (error && error.message.includes('FetchError')) {
                window.showModal("Error", "URL Supabase salah atau tidak dapat dijangkau.");
            } else {
                localStorage.setItem('sikaji_supabase_config', JSON.stringify({ url, key }));
                window.showModal("Sukses", "Koneksi Supabase berhasil disimpan. Aplikasi akan dimuat ulang.", 'alert', () => location.reload());
            }
        };

        window.copySQL = function() {
            const copyText = document.getElementById("sql-script");
            copyText.select();
            document.execCommand("copy");
            window.showToast("Script SQL disalin!");
        }

        window.hardReset = function() {
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        };

        // --- LOGIC ---
        window.isEligibleKP = function(e) {
            // 1. Cek Batas Pangkat Puncak (IV/e) atau Logic Next Rank
            if (e.golongan === 'IV/e') return { eligible: false, msg: "Pangkat Puncak (IV/e)" };
            
            const nextR = nextRank(e.golongan);
            if (nextR === e.golongan) return { eligible: false, msg: "Pangkat Mentok" };

            // 2. Cek Batas Pangkat berdasarkan Pendidikan
            const edu = e.pendidikan || 'SLTA';
            const maxRankEdu = MAX_RANK_REGULER[edu] || 'IV/e';
            const currentIdx = GOLONGAN.indexOf(e.golongan);
            const maxIdx = GOLONGAN.indexOf(maxRankEdu);
            if (currentIdx >= maxIdx) return { eligible: false, msg: `Mentok Pangkat Pendidikan (${edu})` };

            const currentLevel = e.golongan.split('/')[0];
            const nextLevel = nextR.split('/')[0];
            if (currentLevel !== nextLevel) {
                const isExempt = (edu === 'S1' && nextLevel === 'III') || (edu === 'S2' || edu === 'S3');
                if (!isExempt && !e.ujian_dinas) return { eligible: false, msg: "Wajib Ujian Dinas" };
            }

            if(!e.tgl_lahir || new Date() >= getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan)) return { eligible:false, msg: "BUP" };
            if(e.hukuman_disiplin || ['Cukup','Kurang'].includes(e.nilai_skp)) return { eligible:false, msg: "Tidak Memenuhi Syarat" };
            
            const isPending = proposals.some(p => p.empid === e.id && p.status === 'MENUNGGU' && p.type === 'PANGKAT');
            if(isPending) return { eligible:false, msg: "Sedang Proses" };

            const tmt = new Date(e.tmt_pangkat); 
            tmt.setFullYear(tmt.getFullYear() + 4);
            tmt.setDate(1); 
            const cutOff = new Date(); cutOff.setMonth(cutOff.getMonth() + 3);

            return { eligible: cutOff >= tmt, nextTMT: tmt };
        };

        window.isEligibleKGB = function(e) {
            // 1. Cek Batas MKG Maksimal sesuai Tabel
            const data = SALARY_REFERENCES[e.golongan];
            if (!data) return { eligible: false, msg: "Data Gaji Tidak Ditemukan" };
            
            // Ambil tahun tertinggi dari array years
            const maxMK = data.years[data.years.length - 1]; 

            // Jika MK Gaji sekarang sudah sama atau lebih besar dari max tabel -> Mentok
            if (e.mk_gaji_tahun >= maxMK) {
                return { eligible: false, msg: "Masa Kerja Mentok (Maksimal)" };
            }

            if(!e.tgl_lahir || new Date() >= getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan)) return { eligible:false, msg: "BUP" };
            if(e.hukuman_disiplin) return { eligible:false, msg: "Hukuman Disiplin" };

            const isPending = proposals.some(p => p.empid === e.id && p.status === 'MENUNGGU' && p.type === 'KGB');
            if(isPending) return { eligible:false, msg: "Sedang Proses" };

            const tmtBase = e.tmt_berkala ? new Date(e.tmt_berkala) : new Date(e.tmt_pangkat);
            const tmt = new Date(tmtBase); 
            
            // II/a Special Case: 0 -> 1 year (1 year gap), others 2 years
            let interval = 2;
            if (e.golongan === 'II/a' && e.mk_gaji_tahun === 0) interval = 1;
            
            tmt.setFullYear(tmt.getFullYear() + interval);
            tmt.setDate(1);
            
            const cutOff = new Date(); cutOff.setMonth(cutOff.getMonth() + 2);

            return { eligible: cutOff >= tmt, nextTMT: tmt, nextMKG: e.mk_gaji_tahun + interval };
        };

        // --- UI RENDERERS ---
        window.nav = function(page) {
            document.querySelectorAll('#content-area > div').forEach(e => { if(e.id.startsWith('view-')) e.classList.add('hidden'); });
            let target = 'view-' + (['usulan-pangkat','usulan-kgb'].includes(page) ? 'usulan' : page);
            document.getElementById(target).classList.remove('hidden');
            document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('sidebar-item-active'));
            const btn = document.getElementById('nav-' + page); if(btn) btn.classList.add('sidebar-item-active');
            if(page==='dashboard') window.updateDashboard();
            if(page==='pegawai') window.renderPegawai();
            if(page.includes('usulan')) window.renderUsulan(page === 'usulan-pangkat' ? 'PANGKAT' : 'KGB');
            if(page==='verifikasi') window.renderVerifikasi();
            if(page==='salary') {
                window.renderSalaryTable();
                const s = document.getElementById('calc-golongan');
                if(s && s.options.length === 0) {
                    GOLONGAN.forEach(g => s.innerHTML+=`<option value="${g}">${g} - ${MASTER_RANK[g]}</option>`);
                    window.calculateQuickSalary();
                }
            }
            if(page==='pensiun') window.renderPensiun();
            if(page==='settings') window.loadSettingsUI();
            if(page==='simulation') { const s = document.getElementById('sim-golongan'); if(s.options.length===0) GOLONGAN.forEach(g => s.innerHTML+=`<option value="${g}">${g}</option>`); }
        };

        window.calculateQuickSalary = function() {
            const gol = document.getElementById('calc-golongan').value;
            const mk = parseInt(document.getElementById('calc-mk').value) || 0;
            if(mk < 0) document.getElementById('calc-mk').value = 0;
            const salary = calcGaji(gol, mk);
            const resultEl = document.getElementById('calc-result');
            resultEl.style.opacity = '0.5';
            setTimeout(() => { resultEl.innerText = fmtMoney(salary); resultEl.style.opacity = '1'; }, 150);
        };

        window.renderActivityLog = function() { 
            const c = document.getElementById('activity-log-container'); 
            if(c) c.innerHTML = activityLog.map(l => {
                const date = new Date(l.createdat || Date.now());
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                return `<div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all"><div class="w-2 h-2 rounded-full mt-2 shrink-0 ${l.type==='success'?'bg-emerald-500':l.type==='warning'?'bg-amber-500':'bg-blue-500'}"></div><div><p class="text-xs font-bold text-slate-800">${l.text}</p><p class="text-[10px] text-slate-400 font-mono">${dateStr}, ${timeStr}</p></div></div>`;
            }).join(''); 
        }
        
        window.renderSalaryTable = function() { 
            const t = document.getElementById('table-salary-body'); 
            if(t) t.innerHTML = Object.keys(SALARY_REFERENCES).map(g => { 
                const data = SALARY_REFERENCES[g];
                const min = data.salaries[0];
                const max = data.salaries[data.salaries.length - 1];
                const maxMKG = data.years[data.years.length - 1];
                return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 pl-6 font-bold text-slate-800">${g}</td><td class="p-4 text-slate-600">${MASTER_RANK[g]}</td><td class="p-4 text-center font-mono text-emerald-600">${fmtMoney(min)}</td><td class="p-4 text-center text-slate-500">${maxMKG} Tahun</td><td class="p-4 text-right pr-6 font-mono text-slate-800 font-bold">${fmtMoney(max)}</td><td class="p-4 text-center"><button onclick="window.showSalaryDetail('${g}')" class="text-xs font-bold text-blue-600 hover:underline">Lihat Detail</button></td></tr>`; 
            }).join(''); 
        }

        window.showSalaryDetail = function(gol) {
            const data = SALARY_REFERENCES[gol];
            let detailHtml = '<div class="grid grid-cols-2 gap-2 text-sm">';
            data.years.forEach((year, idx) => {
                detailHtml += `<div class="flex justify-between border-b border-slate-100 py-1"><span>${year} Tahun</span><span class="font-mono font-bold text-slate-700">${fmtMoney(data.salaries[idx])}</span></div>`;
            });
            detailHtml += '</div>';
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-[70] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in";
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            modal.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 class="font-bold text-slate-800">Tabel Gaji Golongan ${gol}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-xl"></i></button>
                    </div>
                    <div class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                        ${detailHtml}
                    </div>
                </div>`;
            document.body.appendChild(modal);
        };
        
        window.renderPensiun = function() {
            const g = document.getElementById('pensiun-grid'); if(!g) return;
            const near = employees.filter(e => getAge(e.tgl_lahir) >= 56);
            g.innerHTML = near.length ? near.map(e => {
                const bup = getBUP(e.jabatan, e.jenis_jabatan);
                const tmtPensiun = getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan);
                return `<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500 flex justify-between items-center"><div><h4 class="font-bold text-slate-800">${e.nama}</h4><p class="text-xs text-slate-500 font-mono mb-2">${e.nip}</p><div class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded inline-block">${getAge(e.tgl_lahir)} Tahun (BUP ${bup})</div></div><div class="text-right"><div class="text-[10px] text-slate-400 uppercase font-bold">TMT Pensiun</div><div class="font-bold text-slate-700">${fmtDate(tmtPensiun)}</div></div></div>`
            }).join('') : `<div class="col-span-3 text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">Tidak ada pegawai yang mendekati masa pensiun (< 2 Tahun).</div>`;
            
            document.getElementById('table-pensiun-body').innerHTML = employees.sort((a,b) => a.tgl_lahir - b.tgl_lahir).map(e => {
                 const bup = getBUP(e.jabatan, e.jenis_jabatan);
                 const tmtPensiun = getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan);
                 const sisa = bup - getAge(e.tgl_lahir);
                 return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 font-bold text-slate-700 text-sm">${e.nama}</td><td class="p-4 text-sm">${fmtDate(e.tgl_lahir)}</td><td class="p-4 text-center font-bold text-sm">${getAge(e.tgl_lahir)}</td><td class="p-4 text-center text-sm text-slate-500">${sisa} Thn</td><td class="p-4 text-sm font-medium text-slate-800">${fmtDate(tmtPensiun)}</td></tr>`
            }).join('');
        }
        
        window.renderPegawai = function() {
            const s = document.getElementById('search-pegawai').value.toLowerCase();
            const f = employees.filter(e => (e.nama || '').toLowerCase().includes(s) || (e.nip || '').includes(s));
            document.getElementById('pegawai-count').innerText = `Menampilkan ${f.length} pegawai`;
            document.getElementById('table-pegawai-body').innerHTML = f.map(e => {
                const finalGaji = getEffectiveSalary(e);
                const gajiPangkat = calcGaji(e.golongan, e.mk_pangkat_tahun);
                const gajiBerkala = calcGaji(e.golongan, e.mk_gaji_tahun);
                
                // Hitung Next TMT
                const nextKP = new Date(e.tmt_pangkat); 
                nextKP.setFullYear(nextKP.getFullYear() + 4);
                
                const nextKGB = new Date(e.tmt_berkala); 
                nextKGB.setFullYear(nextKGB.getFullYear() + 2);

                // Cek Pangkat Puncak
                const isMaxRank = (e.golongan === 'IV/e');
                const displayNextKP = isMaxRank ? '<span class="text-slate-400 italic">Pangkat Puncak</span>' : fmtDate(nextKP);

                // Cek Gaji Puncak (approximate based on years data)
                const salaryData = SALARY_REFERENCES[e.golongan];
                const maxYear = salaryData && salaryData.years ? Math.max(...salaryData.years) : 32;
                const isMaxSalary = e.mk_gaji_tahun >= maxYear;
                const displayNextKGB = isMaxSalary ? '<span class="text-slate-400 italic">Maksimal</span>' : fmtDate(nextKGB);
                
                return `<tr class="hover:bg-slate-50 border-b border-slate-100 group">
                    <td class="p-4 pl-6 font-bold text-sm text-slate-700">${e.nama}<br><span class="font-normal text-xs text-slate-500 font-mono">${e.nip}</span></td>
                    <td class="p-4 text-sm text-slate-600">${e.jabatan}<div class="mt-1"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded border border-slate-200">${e.golongan}</span></div></td>
                    <td class="p-4 text-xs text-slate-500">
                        <div class="mb-2">
                            <div class="flex items-center gap-1 font-bold text-navy-900" title="Kenaikan Pangkat Berikutnya"><i class="ph ph-medal text-emerald-500"></i> KP: ${displayNextKP}</div>
                            <div class="text-[10px] text-slate-400 ml-5">Lalu: ${fmtDate(e.tmt_pangkat)}</div>
                        </div>
                        <div>
                            <div class="flex items-center gap-1 font-bold text-navy-900" title="Gaji Berkala Berikutnya"><i class="ph ph-money text-teal-500"></i> KGB: ${displayNextKGB}</div>
                            <div class="text-[10px] text-slate-400 ml-5">Lalu: ${fmtDate(e.tmt_berkala)}</div>
                        </div>
                    </td>
                    <td class="p-4 text-center text-xs text-slate-700">
                        <div class="mb-1 font-bold" title="MK SK Pangkat">Pkt: ${e.mk_pangkat_tahun} Thn ${e.mk_pangkat_bulan} Bln</div>
                        <div class="text-slate-500" title="MK SK Berkala">Gaji: ${e.mk_gaji_tahun} Thn ${e.mk_gaji_bulan} Bln</div>
                    </td>
                    <td class="p-4 text-right">
                        <div class="font-mono text-sm font-bold text-emerald-700 bg-emerald-50/30 p-1 rounded-md shadow-sm border-l-4 border-emerald-500" title="Gaji Pokok Tertinggi (Perpres 10/2024)">${fmtMoney(finalGaji)}</div>
                        <div class="text-[10px] text-slate-400 mt-1 grid grid-cols-2 gap-2">
                            <div class="text-right border-r border-slate-200 pr-2">Pkt: ${fmtMoney(gajiPangkat)}</div>
                            <div class="text-left pl-2">KGB: ${fmtMoney(gajiBerkala)}</div>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="window.openAddEmployeeModal('${e.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-all" title="Edit"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button onclick="window.deleteEmployee('${e.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all" title="Hapus"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        window.renderUsulan = function(type) {
            const eligibleList = employees.filter(e => {
                const check = type === 'PANGKAT' ? window.isEligibleKP(e) : window.isEligibleKGB(e);
                return check.eligible;
            });

            document.getElementById('usulan-count').innerText = eligibleList.length + " Pegawai Eligible";
            
            if (eligibleList.length === 0) {
                document.getElementById('table-usulan-body').innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">Tidak ada pegawai yang memenuhi syarat usulan saat ini.</td></tr>`;
                return;
            }

            document.getElementById('table-usulan-body').innerHTML = eligibleList.map(e => {
                const r = type === 'PANGKAT' ? window.isEligibleKP(e) : window.isEligibleKGB(e);
                
                let nR = e.golongan, nMK = 0, nGaji = 0;
                if(type === 'PANGKAT') {
                     nR = nextRank(e.golongan);
                     const red = getReductionYears(e.golongan, nR);
                     nMK = Math.max(0, e.mk_gaji_tahun - red); 
                     nGaji = calcGaji(nR, nMK); 
                } else {
                     nMK = r.nextMKG;
                     nR = e.golongan;
                     nGaji = calcGaji(nR, nMK); 
                }

                // Status logic for UI
                const today = new Date();
                const isDue = r.nextTMT <= today;
                const statusLabel = isDue ? 
                    '<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-md text-[10px] font-bold border border-emerald-200">SIAP PROSES</span>' : 
                    '<span class="bg-amber-100 text-amber-700 px-2 py-1 rounded-md text-[10px] font-bold border border-amber-200">SEGERA</span>';

                return `<tr class="hover:bg-slate-50 border-b border-slate-100 group">
                    <td class="p-5 font-bold text-sm text-slate-700">
                        ${e.nama}<br><span class="font-normal text-xs text-slate-500">${e.nip}</span>
                    </td>
                    <td class="p-5">
                        <div class="text-xs text-slate-600 font-bold">${type === 'PANGKAT' ? 'Kenaikan Pangkat' : 'Gaji Berkala'}</div>
                        <div class="text-[10px] text-slate-400">TMT: ${fmtDate(r.nextTMT)}</div>
                        <div class="text-[10px] text-emerald-600 mt-0.5">Estimasi: ${fmtMoney(nGaji)}</div>
                    </td>
                    <td class="p-5 text-center">
                        ${statusLabel}
                    </td>
                    <td class="p-5 text-right">
                        <button onclick="window.createProposal('${e.id}', '${type}')" class="bg-navy-900 hover:bg-navy-800 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-navy-900/20 transition-all flex items-center gap-2 ml-auto">
                            <i class="ph ph-paper-plane-right"></i> Proses
                        </button>
                    </td>
                </tr>`;
            }).join('');
        };

        window.renderVerifikasi = function() {
            const t = document.getElementById('table-verifikasi-body');
            const l = proposals.sort((a,b) => { if(a.status==='MENUNGGU' && b.status!=='MENUNGGU') return -1; if(a.status!=='MENUNGGU' && b.status==='MENUNGGU') return 1; return new Date(b.date)-new Date(a.date); });
            if (l.length === 0) { t.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic bg-slate-50/50">Belum ada riwayat usulan.</td></tr>`; return; }
            t.innerHTML = l.map(p => {
                let bc = 'bg-slate-100 text-slate-700';
                if(p.status === 'MENUNGGU') bc = 'bg-amber-100 text-amber-700 border border-amber-200';
                else if(p.status === 'DISETUJUI') bc = 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                else if(p.status === 'DITOLAK') bc = 'bg-red-100 text-red-700 border border-red-200';
                return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 text-xs font-mono">${fmtDate(p.date)}</td><td class="p-4 text-xs font-bold">${p.type}</td><td class="p-4 text-sm font-bold text-slate-700">${p.empname}</td><td class="p-4 text-xs text-slate-500">${p.type==='KGB'?`MKG ${p.newmktahun} Thn`:`${p.newrank} (-${p.reduction} Thn)`}</td><td class="p-4 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${bc}">${p.status}</span></td><td class="p-4 text-right">${p.status==='MENUNGGU' ? `<div class="flex justify-end gap-1"><button onclick="window.approveProposal('${p.id}')" class="text-emerald-600 hover:bg-emerald-50 p-2 rounded transition-colors" title="Setujui"><i class="ph ph-check-circle text-xl"></i></button><button onclick="window.rejectProposal('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors" title="Tolak"><i class="ph ph-x-circle text-xl"></i></button></div>` : `<i class="ph ${p.status==='DISETUJUI'?'ph-check-circle text-emerald-500':'ph-x-circle text-red-300'} text-xl"></i>`}</td></tr>`;
            }).join('');
        }

        // --- HANDLERS SUPABASE ---
        window.createProposal = async function(id, type) {
            if(!supabase) return window.showModal("Error", "Koneksi terputus.");
            if(isProcessLocked) return; // Race condition block
            isProcessLocked = true;

            try {
                const e = employees.find(x => x.id === id);
                const rule = type === 'PANGKAT' ? window.isEligibleKP(e) : window.isEligibleKGB(e);
                let nR = e.golongan, nMK = 0, red = 0, nG = 0;
                
                if (type === 'PANGKAT') { 
                    nR = nextRank(e.golongan); 
                    red = getReductionYears(e.golongan, nR); 
                    nMK = Math.max(0, e.mk_gaji_tahun - red); 
                    nG = calcGaji(nR, nMK); 
                } else { 
                    nR = e.golongan; 
                    nMK = rule.nextMKG; 
                    nG = calcGaji(nR, nMK); 
                }
                
                const { error } = await supabase.from('proposals').insert([{
                    empid: e.id, empname: e.nama, empnip: e.nip, type: type, status: 'MENUNGGU', date: new Date().toISOString(), 
                    newtmt: rule.nextTMT.toISOString(), oldrank: e.golongan, newrank: nR, newgaji: nG, 
                    newmktahun: nMK, reduction: red
                }]);
                if (error) throw error;
                
                await addActivity(`Usulan ${type} ${e.nama}`, 'info'); 
                window.showToast("Usulan dibuat (Supabase)"); 
                await window.loadData();
            } catch(error) { 
                console.error(error); 
                window.showModal("Error", "Gagal menyimpan usulan: " + error.message); 
            } finally {
                isProcessLocked = false;
            }
        };

        // --- FIXED VERIFICATION HANDLERS ---
        window.approveProposal = async function(pid) {
            if(isProcessLocked) return;
            isProcessLocked = true;

            try {
                const p = proposals.find(x => x.id === pid);
                if(!p) return window.showModal("Error", "Data usulan tidak ditemukan.");
                if(p.status !== 'MENUNGGU') return window.showModal("Error", "Status bukan MENUNGGU.");
                
                // Note: Using alert logic inside modal callback, manual unlock needed if cancelled
                window.showModal(
                    `Setujui ${p.type}?`, 
                    `Data gaji dan pangkat pegawai ${p.empname} akan otomatis diperbarui ke database. Lanjutkan?`, 
                    'confirm', 
                    async () => {
                        if(!supabase) return window.showModal("Error", "Koneksi Database terputus.");
                        window.showToast("Sedang memproses...", "info");

                        try {
                            // A. Update Status Proposal
                            const { error: propError } = await supabase.from('proposals').update({ status: 'DISETUJUI' }).eq('id', pid);
                            if(propError) throw new Error(propError.message);

                            // B. Update Data Pegawai (Master)
                            let updates = { lastsync: Date.now() };
                            
                            if(p.type === 'PANGKAT') { 
                                updates.golongan = p.newrank; 
                                updates.tmt_pangkat = p.newtmt.toISOString(); 
                                updates.mk_pangkat_tahun = p.newmktahun;
                                updates.mk_pangkat_bulan = 0;
                                
                                // Sync sisi gaji
                                updates.tmt_berkala = p.newtmt.toISOString(); 
                                updates.mk_gaji_tahun = p.newmktahun;
                                updates.mk_gaji_bulan = 0;

                            } else if (p.type === 'KGB') {
                                updates.tmt_berkala = p.newtmt.toISOString();
                                updates.mk_gaji_tahun = p.newmktahun;
                                updates.mk_gaji_bulan = 0;
                            }
                            
                            const { error: empError } = await supabase.from('employees').update(updates).eq('id', p.empid);
                            if(empError) throw new Error(empError.message);
                            
                            await addActivity(`Menyetujui ${p.type} ${p.empname}`, 'success'); 
                            window.showToast("Berhasil Disetujui & Data Diupdate!", "success");
                            await window.loadData();
                            
                        } catch(error) { 
                            console.error("Approval Error:", error); 
                            window.showModal("Error", "Terjadi Kesalahan: " + error.message); 
                        } finally {
                            isProcessLocked = false;
                        }
                    }
                );
                // Unlock immediately if modal is just shown (locking handled inside callback for async ops)
                isProcessLocked = false; 

            } catch(e) {
                isProcessLocked = false;
            }
        };

        window.rejectProposal = async function(pid) {
            const p = proposals.find(x => x.id === pid);
            if(!p) return window.showModal("Error", "Data usulan tidak ditemukan.");

            window.showModal(
                `Tolak Usulan ${p.type}?`, 
                `Apakah Anda yakin menolak usulan ini untuk pegawai ${p.empname}?`, 
                'confirm', 
                async () => {
                    if(!supabase) return window.showModal("Error", "Koneksi Database terputus.");
                    try {
                        const { error } = await supabase.from('proposals').update({ status: 'DITOLAK' }).eq('id', pid);
                        if(error) throw error;

                        await addActivity(`Menolak ${p.type} ${p.empname}`, 'warning'); 
                        window.showToast("Usulan Ditolak", "warning"); 
                        await window.loadData();
                    } catch(error) { 
                        console.error(error); 
                        window.showModal("Error", "Gagal menolak: " + error.message); 
                    }
                },
                true // Destructive
            );
        };

        window.deleteEmployee = async function(id) {
            window.showModal(
                "Hapus Pegawai?",
                "Tindakan ini permanen dan data tidak dapat dikembalikan. Lanjutkan?",
                'confirm',
                async () => {
                    if(!supabase) return window.showModal("Error", "Koneksi terputus.");
                    try {
                        const { error } = await supabase.from('employees').delete().eq('id', id);
                        if (error) throw error;
                        window.showToast("Data Dihapus", "warning"); 
                        await window.loadData();
                    } catch(error) { console.error(error); window.showModal("Error", "Gagal menghapus: " + error.message); }
                },
                true
            );
        };

        // --- SYSTEM UPDATE FUNCTIONS ---
        window.wipeDatabase = async function() {
            window.showModal(
                "ZONA BERBAHAYA",
                "Anda akan menghapus SELURUH data tabel dari database Supabase (Pegawai, Usulan, Log). Tindakan ini TIDAK DAPAT DIBATALKAN.",
                'confirm',
                async () => {
                    if(!supabase) return window.showModal("Error", "Koneksi terputus.");
                    const loader = document.getElementById('app-loader');
                    loader.classList.remove('hidden');
                    loader.querySelector('p').innerText = "Membersihkan Tabel...";

                    try {
                        await supabase.from('employees').delete().neq('nama', 'null');
                        await supabase.from('proposals').delete().neq('type', 'null');
                        await supabase.from('activity_logs').delete().neq('type', 'null');
                        
                        window.showToast("Tabel berhasil dikosongkan!", "success");
                        await window.loadData();
                    } catch (e) {
                        console.error(e);
                        window.showModal("Error", "Gagal mengosongkan: " + e.message);
                    } finally {
                        loader.classList.add('hidden');
                    }
                },
                true
            );
        };

        window.updateSalaryReference = async function() {
            window.showModal(
                "Update Regulasi",
                `Terapkan standar gaji ${REGULATION_NAME} ke Supabase? Ini akan menimpa pengaturan gaji saat ini.`,
                'confirm',
                async () => {
                    if (!supabase) return window.showModal("Error", "Harap setup Supabase terlebih dahulu.");
                    try {
                        const payload = {
                            id: 'salary_std',
                            regulation: REGULATION_NAME,
                            effectivedate: "2024-01-01",
                            ranges: GAJI_POKOK_2024,
                            updatedat: Date.now()
                        };
                        
                        const { error } = await supabase.from('settings').upsert([payload]);
                        if (error) throw error;

                        await addActivity(`Update Referensi Gaji (${REGULATION_NAME})`, "success");
                        window.showToast("Referensi Gaji Berhasil Diupdate!");
                        await window.loadData();
                    } catch (e) {
                        console.error(e);
                        window.showModal("Error", "Gagal update referensi: " + e.message);
                    }
                }
            );
        };

        window.syncEmployeeData = async function() {
            if (!supabase) return;
            window.showToast("Memulai sinkronisasi...");
            await window.loadData();
            window.showToast("Tabel tersinkronisasi!", "success");
        };

        window.openAddEmployeeModal = function(id = null) {
            const m = document.getElementById('modal-add-employee'); m.classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('modal-content').classList.add('scale-100');
            const s = document.getElementById('input-golongan'); if(s.options.length===0) GOLONGAN.forEach(g => s.innerHTML+=`<option value="${g}">${g}</option>`);
            if(id) {
                const e = employees.find(x => x.id === id); document.getElementById('modal-title').innerText = "Edit Pegawai";
                document.getElementById('input-id').value = e.id; document.getElementById('input-nama').value = e.nama; document.getElementById('input-nip').value = e.nip; document.getElementById('input-lahir').value = e.tgl_lahir.toISOString().split('T')[0]; document.getElementById('input-jabatan').value = e.jabatan; document.getElementById('input-jenis-jabatan').value = e.jenis_jabatan; document.getElementById('input-golongan').value = e.golongan; 
                // Populate both MKs
                document.getElementById('input-mk-pangkat-tahun').value = e.mk_pangkat_tahun; 
                document.getElementById('input-mk-pangkat-bulan').value = e.mk_pangkat_bulan; 
                document.getElementById('input-mk-gaji-tahun').value = e.mk_gaji_tahun; 
                document.getElementById('input-mk-gaji-bulan').value = e.mk_gaji_bulan;
                
                document.getElementById('input-tmt-pangkat').value = e.tmt_pangkat.toISOString().split('T')[0]; document.getElementById('input-tmt-berkala').value = e.tmt_berkala.toISOString().split('T')[0]; document.getElementById('input-skp').value = e.nilai_skp; document.getElementById('input-hukuman').value = e.hukuman_disiplin.toString(); document.getElementById('input-pendidikan').value = e.pendidikan || 'SLTA'; document.getElementById('input-ujian').value = e.ujian_dinas ? 'true' : 'false';
            } else { document.getElementById('form-add-employee').reset(); document.getElementById('input-id').value = ""; document.getElementById('modal-title').innerText = "Tambah Pegawai"; }
            window.previewGajiForm();
        };

        window.closeAddEmployeeModal = function() { const m = document.getElementById('modal-add-employee'); m.classList.add('opacity-0', 'pointer-events-none'); document.getElementById('modal-content').classList.remove('scale-100'); };

        window.saveNewEmployee = async function() {
            if(!supabase) return window.showModal("Error", "Koneksi ke database terputus.");
            const id = document.getElementById('input-id').value;
            const nama = document.getElementById('input-nama').value;
            const nip = document.getElementById('input-nip').value;
            const lahirStr = document.getElementById('input-lahir').value;
            const tmtPangkatStr = document.getElementById('input-tmt-pangkat').value;
            const tmtBerkalaStr = document.getElementById('input-tmt-berkala').value;

            if(!nama || !nip || !lahirStr || !tmtPangkatStr || !tmtBerkalaStr) {
                return window.showModal("Error", "Mohon lengkapi data Identitas dan Tanggal!");
            }

            const data = { 
                nama: nama, 
                nip: nip, 
                jabatan: document.getElementById('input-jabatan').value, 
                jenis_jabatan: document.getElementById('input-jenis-jabatan').value, 
                golongan: document.getElementById('input-golongan').value, 
                // Save both MKs
                mk_pangkat_tahun: parseInt(document.getElementById('input-mk-pangkat-tahun').value)||0, 
                mk_pangkat_bulan: parseInt(document.getElementById('input-mk-pangkat-bulan').value)||0,
                mk_gaji_tahun: parseInt(document.getElementById('input-mk-gaji-tahun').value)||0, 
                mk_gaji_bulan: parseInt(document.getElementById('input-mk-gaji-bulan').value)||0, 
                
                tgl_lahir: new Date(lahirStr).toISOString(), 
                tmt_pangkat: new Date(tmtPangkatStr).toISOString(), 
                tmt_berkala: new Date(tmtBerkalaStr).toISOString(), 
                nilai_skp: document.getElementById('input-skp').value, 
                hukuman_disiplin: document.getElementById('input-hukuman').value === 'true',
                pendidikan: document.getElementById('input-pendidikan').value,
                ujian_dinas: document.getElementById('input-ujian').value === 'true'
            };
            
            try {
                if(id) { 
                    const { error } = await supabase.from('employees').update(data).eq('id', id);
                    if(error) throw error;
                } else { 
                    const { error } = await supabase.from('employees').insert([data]);
                    if(error) throw error;
                }
                window.closeAddEmployeeModal(); 
                window.showToast("Disimpan ke Supabase");
                await window.loadData();
            } catch(e) { 
                console.error(e); 
                window.showModal("Error", "Gagal menyimpan: " + e.message); 
            }
        };

        window.previewGajiForm = function() { 
            const g = document.getElementById('input-golongan').value; 
            const mp = parseInt(document.getElementById('input-mk-pangkat-tahun').value)||0;
            const mg = parseInt(document.getElementById('input-mk-gaji-tahun').value)||0;
            const gp = calcGaji(g, mp);
            const gg = calcGaji(g, mg);
            
            document.getElementById('form-salary-preview').innerHTML = `
                <div class="text-3xl font-bold text-slate-800 font-mono tracking-tight">${fmtMoney(Math.max(gp, gg))}</div>
                <div class="text-[10px] text-slate-400 mt-1 grid grid-cols-2 gap-2">
                    <div class="text-right border-r border-slate-200 pr-2">Pkt: ${fmtMoney(gp)}</div>
                    <div class="text-left pl-2">KGB: ${fmtMoney(gg)}</div>
                </div>
            `;
        };
        
        window.updateDashboard = function() {
            const active = employees.filter(e => new Date() < getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan));
            document.getElementById('stat-total').innerText = active.length;
            
            // Statistik Usulan
            const elP = employees.filter(e => window.isEligibleKP(e).eligible).length; 
            const elK = employees.filter(e => window.isEligibleKGB(e).eligible).length; 
            const pend = proposals.filter(p => p.status === 'MENUNGGU').length;
            
            // Fixed: Use consistent calculation
            const totalGaji = active.reduce((acc, e) => acc + getEffectiveSalary(e), 0);
            const pensiunThisYear = active.filter(e => getTmtPensiun(e.tgl_lahir, e.jabatan, e.jenis_jabatan).getFullYear() === new Date().getFullYear()).length;
            
            // Jabatan Stats
            const jabatanStats = { 'Struktural': 0, 'Fungsional': 0, 'Pelaksana': 0 };
            active.forEach(e => {
                const type = e.jenis_jabatan || 'Pelaksana';
                if (jabatanStats[type] !== undefined) jabatanStats[type]++; else jabatanStats['Pelaksana']++;
            });

            document.getElementById('stat-pangkat').innerText = elP; 
            document.getElementById('stat-kgb').innerText = elK; 
            document.getElementById('hero-pending-count').innerText = pend;

            // UPDATE BADGES SIDEBAR (NOTIFIKASI)
            const badgeP = document.getElementById('badge-pangkat');
            if(badgeP) { 
                badgeP.innerText = elP; 
                elP > 0 ? badgeP.classList.remove('hidden') : badgeP.classList.add('hidden'); 
            }
            
            const badgeK = document.getElementById('badge-kgb');
            if(badgeK) { 
                badgeK.innerText = elK; 
                elK > 0 ? badgeK.classList.remove('hidden') : badgeK.classList.add('hidden'); 
            }
            
            const badgeV = document.getElementById('badge-verif');
            if(badgeV) { 
                badgeV.innerText = pend; 
                pend > 0 ? badgeV.classList.remove('hidden') : badgeV.classList.add('hidden'); 
            }
            
            const statTotalGaji = document.getElementById('stat-total-gaji'); if(statTotalGaji) statTotalGaji.innerText = fmtMoney(totalGaji);
            const statPensiun = document.getElementById('stat-pensiun-year'); if(statPensiun) statPensiun.innerText = `${pensiunThisYear} Pegawai`;

            if(chartGolongan) chartGolongan.destroy();
            const ctx = document.getElementById('chart-golongan').getContext('2d');
            const dataMap = {}; active.forEach(e => { const g = e.golongan.split('/')[0]; dataMap[g] = (dataMap[g]||0)+1; });
            chartGolongan = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(dataMap), datasets: [{ label: 'Pegawai', data: Object.values(dataMap), backgroundColor: '#10b981', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            if(chartJabatan) chartJabatan.destroy();
            const ctxJab = document.getElementById('chart-jabatan').getContext('2d');
            chartJabatan = new Chart(ctxJab, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(jabatanStats), 
                    datasets: [{ 
                        data: Object.values(jabatanStats), 
                        backgroundColor: ['#f59e0b', '#10b981', '#3b82f6'], 
                        borderWidth: 0 
                    }] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } 
            });

            const priorityList = active.filter(e => window.isEligibleKP(e).eligible).slice(0, 5);
            const priorityContainer = document.getElementById('priority-list-container');
            if(priorityContainer) {
                if (priorityList.length === 0) {
                    priorityContainer.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Tidak ada data prioritas.</p>';
                } else {
                    priorityContainer.innerHTML = priorityList.map(e => `
                        <div class="flex items-center justify-between p-3 bg-white/50 border border-slate-100 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">${e.nama.charAt(0)}</div>
                                <div><p class="text-xs font-bold text-slate-700">${e.nama}</p><p class="text-[10px] text-slate-400">Naik ke: ${nextRank(e.golongan)}</p></div>
                            </div>
                            <span class="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded">Urgent</span>
                        </div>
                    `).join('');
                }
            }
        };

        window.runSimulation = function() {
            const currentGol = document.getElementById('sim-golongan').value;
            let mkTahun = parseInt(document.getElementById('sim-mk-tahun').value) || 0;
            const tmtPangkatStr = document.getElementById('sim-tmt-pangkat').value;
            const tmtBerkalaStr = document.getElementById('sim-tmt-berkala').value;
            if(!tmtPangkatStr || !tmtBerkalaStr) { window.showModal("Info", "Mohon lengkapi TMT!"); return; }
            const timeline = document.getElementById('sim-timeline'); timeline.innerHTML = '';
            let simDate = new Date(); let currentRank = currentGol;
            let lastTMTPangkat = new Date(tmtPangkatStr); let lastTMTBerkala = new Date(tmtBerkalaStr);
            const events = []; const endDate = new Date(); endDate.setFullYear(endDate.getFullYear() + 10);
            while(simDate < endDate) {
                const mainGol = currentRank.split('/')[0]; const isGanjil = (mainGol === 'I' || mainGol === 'II');
                let targetMKG = mkTahun + 1; while((isGanjil && targetMKG % 2 === 0) || (!isGanjil && targetMKG % 2 !== 0)) { targetMKG++; }
                const yearsNeeded = targetMKG - mkTahun;
                const nextKGBDate = new Date(lastTMTBerkala); nextKGBDate.setFullYear(nextKGBDate.getFullYear() + yearsNeeded);
                const nextKPDate = new Date(lastTMTPangkat); nextKPDate.setFullYear(nextKPDate.getFullYear() + 4); nextKPDate.setDate(1); 
                if (nextKGBDate < nextKPDate) {
                    if (nextKGBDate > simDate) {
                        mkTahun = targetMKG; const currentSalary = calcGaji(currentRank, mkTahun);
                        lastTMTBerkala = new Date(nextKGBDate); simDate = new Date(nextKGBDate);
                        events.push({ date: new Date(nextKGBDate), type: 'KGB', desc: `Kenaikan Berkala (${mkTahun} Thn)`, detail: fmtMoney(currentSalary) });
                    } else { simDate.setMonth(simDate.getMonth() + 1); }
                } else {
                    if (nextKPDate > simDate) {
                        const nextR = nextRank(currentRank);
                        if(nextR !== currentRank) { 
                            const reduction = getReductionYears(currentRank, nextR); mkTahun = Math.max(0, mkTahun - reduction);
                            currentRank = nextR; const currentSalary = calcGaji(currentRank, mkTahun);
                            lastTMTPangkat = new Date(nextKPDate); lastTMTBerkala = new Date(nextKPDate); simDate = new Date(nextKPDate);
                            events.push({ date: new Date(nextKPDate), type: 'KP', desc: `Naik Pangkat ke ${currentRank}`, detail: `Potong ${reduction} Thn. Gaji: ${fmtMoney(currentSalary)}` });
                        } else { simDate.setFullYear(simDate.getFullYear() + 1); }
                    } else { simDate.setMonth(simDate.getMonth() + 1); }
                }
            }
            if(events.length === 0) { timeline.innerHTML = `<div class="p-4 text-center text-slate-500">Tidak ada kenaikan dalam 10 tahun.</div>`; } else { timeline.innerHTML = events.map(ev => `<div class="flex gap-4 items-start relative"><div class="w-12 text-right text-xs font-bold text-slate-400 pt-1">${ev.date.getFullYear()}</div><div class="relative flex-1 bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all"><div class="absolute -left-6 top-2 w-3 h-3 rounded-full ${ev.type==='KP'?'bg-emerald-500':'bg-teal-500'} border-2 border-white shadow"></div><div class="flex justify-between items-start"><div><h5 class="font-bold text-slate-800 text-sm">${ev.type}</h5><p class="text-xs text-slate-500">${fmtDate(ev.date)}</p></div></div><div class="mt-2 text-xs text-slate-600 font-medium border-t border-slate-50 pt-2">${ev.desc}<br><span class="text-slate-400">${ev.detail}</span></div></div></div>`).join(''); }
        };

        window.exportDataJSON = function() { const data = { employees, proposals, appSettings, activityLog }; const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data)); a.download = 'backup_sikaji_supabase.json'; a.click(); };
        window.importDataJSON = function(input) { 
            window.showModal("Info", "Fitur Restore via JSON dinonaktifkan di mode cloud. Harap import melalui dashboard Supabase Anda.");
            input.value = ''; 
        };
        
        window.loadSettingsUI = function() {
            document.getElementById('set-nama').value = appSettings.signerName || '';
            document.getElementById('set-nip').value = appSettings.signerNIP || '';
            document.getElementById('set-jabatan').value = appSettings.signerPosition || '';
            const sel = document.getElementById('set-golongan');
            if(sel.options.length === 0) GOLONGAN.forEach(g => sel.innerHTML += `<option value="${g}">${g} - ${MASTER_RANK[g]}</option>`);
            sel.value = appSettings.signerGolongan || 'IV/a';
            if(appSettings.logoUrl) document.getElementById('settings-logo-preview').src = appSettings.logoUrl;
            document.getElementById('settings-current-user').innerText = currentUser ? currentUser.username : 'GUEST';
            window.updateQRPreview();
        };
        
        window.saveSettings = async function() { 
            if(!supabase) return window.showModal("Error", "Koneksi terputus.");
            const newData = {
                id: 'config',
                signername: document.getElementById('set-nama').value,
                signernip: document.getElementById('set-nip').value,
                signerposition: document.getElementById('set-jabatan').value,
                signergolongan: document.getElementById('set-golongan').value,
                logourl: appSettings.logoUrl,
                updatedat: Date.now()
            };
            try {
                const { error } = await supabase.from('settings').upsert([newData]);
                if (error) throw error;
                window.showToast("Pengaturan Disimpan (Supabase)"); 
                await window.loadData();
            } catch(error) { console.error(error); window.showModal("Error", "Gagal menyimpan pengaturan: " + error.message); }
        };
        
        window.updateQRPreview = function() { const d = `TTE|${document.getElementById('set-nip').value}|${document.getElementById('set-nama').value}`; document.getElementById('set-qr-preview').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(d)}`; };
        window.resetLogo = function() { 
            appSettings.logoUrl = "https://kalselprov.go.id/wp-content/uploads/2020/09/Logo-Kalsel.png"; 
            document.getElementById('settings-logo-preview').src = appSettings.logoUrl; 
        };
        
        window.filterUsulanTable = function() { const v = document.getElementById('search-usulan').value.toLowerCase(); document.querySelectorAll('#table-usulan-body tr').forEach(r => { r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'; }); };
        
        // Updated Report Logic: Use modern fields
        window.printGeneralReport = function(type) {
            const win = window.open('','_blank'); let rows = ''; let title = ''; let headers = ''; const logo = appSettings.logoUrl;
            const reportId = `LAP-${type}-${Date.now()}`; const qrData = `SIKAJI-VALID|${reportId}|${appSettings.signerNIP}`; const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(qrData)}`;
            
            const rankName = MASTER_RANK[appSettings.signerGolongan] || '';
            const todayDate = fmtDate(new Date());

            if (type === 'ALL') { 
                title = 'DAFTAR NOMINATIF PEGAWAI'; 
                headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Nama / NIP</th><th style="border:1px solid #000; padding:8px">Jabatan</th><th style="border:1px solid #000; padding:8px">Golongan</th><th style="border:1px solid #000; padding:8px">MKG</th><th style="border:1px solid #000; padding:8px">Gaji Pokok (${REGULATION_NAME})</th>`; 
                rows = employees.map((e, i) => `<tr style="page-break-inside: avoid;"><td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td><td style="border:1px solid #000; padding:5px"><b>${e.nama}</b><br>${e.nip}</td><td style="border:1px solid #000; padding:5px">${e.jabatan}</td><td style="border:1px solid #000; padding:5px; text-align:center">${e.golongan}</td><td style="border:1px solid #000; padding:5px; text-align:center">${e.mk_gaji_tahun} Thn ${e.mk_gaji_bulan} Bln</td><td style="border:1px solid #000; padding:5px; text-align:right; font-family:monospace">${fmtMoney(getEffectiveSalary(e))}</td></tr>`).join(''); 
            } 
            else { 
                title = type === 'APPROVED' ? 'LAPORAN REALISASI SK (DISETUJUI)' : 'DAFTAR ANTRIAN VERIFIKASI'; 
                headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Pegawai</th><th style="border:1px solid #000; padding:8px">Jenis Usulan</th><th style="border:1px solid #000; padding:8px">Detail Perubahan</th><th style="border:1px solid #000; padding:8px">TMT</th>`; 
                const fs = type === 'APPROVED' ? 'DISETUJUI' : 'MENUNGGU'; 
                rows = proposals.filter(p => p.status === fs).map((p, i) => `<tr><td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td><td style="border:1px solid #000; padding:5px"><b>${p.empname}</b><br>${p.empnip}</td><td style="border:1px solid #000; padding:5px; text-align:center">${p.type}</td><td style="border:1px solid #000; padding:5px">${p.type === 'KGB' ? `Gaji: ${fmtMoney(p.newgaji)}` : `Pangkat: ${p.newrank}`}</td><td style="border:1px solid #000; padding:5px; text-align:center">${fmtDate(p.newtmt)}</td></tr>`).join(''); 
            }
            
            win.document.write(`<html><head><title>Laporan</title><style>@page { size: A4; margin: 2cm; } body { font-family: 'Times New Roman', serif; width: 100%; margin: 0; } .kop-surat { width: 100%; border-bottom: 3px double black; margin-bottom: 25px; padding-bottom: 10px; } .kop-logo-container { width: 100px; text-align: center; vertical-align: middle; } .kop-logo { height: 95px; width: auto; object-fit: contain; } .kop-text-container { text-align: center; vertical-align: middle; padding-left: 10px; padding-right: 10px; } .kop-row-1 { font-size: 13pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-row-2 { font-size: 15pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-row-3 { font-size: 17pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-address { font-size: 9pt; margin: 2px 0 0 0; line-height: 1.3; }</style></head><body><table class="kop-surat"><tr><td class="kop-logo-container"><img src="${logo}" class="kop-logo"></td><td class="kop-text-container"><h3 class="kop-row-1">PEMERINTAH PROVINSI KALIMANTAN SELATAN</h3><h2 class="kop-row-2">DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</h2><h2 class="kop-row-3">LABORATORIUM BAHAN KONSTRUKSI</h2><p class="kop-address">Jl. Yos Sudarso No. 35 Kel. Telaga Biru Kec. Banjarmasin Barat Kota Banjarmasin RT. 34 RW. 02</p><p class="kop-address">Telpon : (0511) 4423377 | Fax : (0511) 4423377 | Email : laboratoriumpuprov.kalsel@yahoo.com</p></td></tr></table><h1 style="text-align:center; font-size:14pt; font-weight:bold; text-decoration:underline; margin-bottom:20px; text-transform:uppercase">${title}</h1><table style="width:100%; border-collapse:collapse; font-size:11pt"><thead><tr style="background-color:#f3f4f6; text-align:center">${headers}</tr></thead><tbody>${rows || '<tr><td colspan="6" style="text-align:center; padding:10px; font-style:italic; border:1px solid #000">Tidak ada data.</td></tr>'}</tbody></table>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:50px">
                <div style="text-align:center">
                    <img src="${qrUrl}" style="width:90px; height:90px; margin-bottom:10px; border:1px solid #ddd; padding:5px">
                    <p style="font-size:9pt; color:#666; margin:0">Dokumen valid & terverifikasi<br>sistem SIKAJI ASN.</p>
                </div>
                <div style="text-align:center; width:350px">
                    <p style="margin-bottom:70px; font-size:12pt">Banjarmasin, ${todayDate}<br><strong>${appSettings.signerPosition}</strong></p>
                    <p style="font-weight:bold; text-decoration:underline; margin:0; font-size:12pt">${appSettings.signerName}</p>
                    <p style="margin:0; font-size:12pt">${rankName}</p>
                    <p style="margin:0; font-size:12pt">NIP. ${appSettings.signerNIP}</p>
                </div>
            </div>
            <script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script></body></html>`);
            win.document.close();
        }

        // --- INIT ---
        window.onload = async function() {
            if (!isConfigured) {
                document.getElementById('setup-interface').classList.remove('hidden');
                return;
            }

            checkSession();

            // Check for cached logo
            const cachedLogo = localStorage.getItem('custom_login_logo');
            if(cachedLogo) {
                const img = document.getElementById('login-logo-img');
                if(img) img.src = cachedLogo;
            }

            // Load data for the first time
            if (supabase) {
                await window.loadData();

                // --- AKTIVASI REALTIME LISTENER ---
                // Mendengarkan perubahan data dari database secara langsung
                console.log("Mengaktifkan Realtime Listener...");
                supabase.channel('public:db_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'employees' }, (payload) => {
                        console.log('Realtime: Data Pegawai berubah', payload);
                        window.showToast("Data Pegawai diperbarui secara Real-time", "info");
                        window.loadData(); // Reload UI otomatis
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'proposals' }, (payload) => {
                        console.log('Realtime: Data Usulan berubah', payload);
                        // Hanya reload jika bukan insert dari klien ini (opsional, tapi loadData aman)
                        window.loadData(); 
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, (payload) => {
                        console.log('Realtime: Pengaturan berubah', payload);
                        window.loadData();
                    })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('SIKAJI ASN terhubung ke Realtime Updates');
                        }
                    });
            }
            
            // Interval waktu & tanggal
            setInterval(() => { 
                const now = new Date();
                const d = document.getElementById('clock'); 
                const dt = document.getElementById('date-display');
                
                if(d) d.innerText = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); 
                if(dt) dt.innerText = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }, 1000);
        };
    </script>
</body>
</html>
