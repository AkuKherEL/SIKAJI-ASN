<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIKAJI ASN - Sistem Kepegawaian & Kinerja (Production)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                extend: {
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f3f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .gradient-primary { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .gradient-card-1 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .gradient-card-2 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-card-3 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .gradient-card-4 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-item-active { background-color: rgba(255, 255, 255, 0.1); border-left: 3px solid #f59e0b; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-slate-800 antialiased overflow-hidden">

    <!-- LOADER -->
    <div id="app-loader" class="loading-overlay hidden">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-emerald-500 rounded-full animate-spin"></div>
            <p class="text-sm font-bold text-slate-600 animate-pulse" id="loader-text">Menghubungkan ke Supabase...</p>
        </div>
    </div>

    <!-- VIEW: SETUP INTERFACE (FOR PORTABILITY) -->
    <div id="setup-interface" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center hidden overflow-y-auto py-10">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 border border-slate-700 relative overflow-hidden my-auto">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-500 to-teal-400"></div>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-slate-800">Setup Database</h2>
                <span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-3 py-1 rounded-full border border-emerald-200">Production</span>
            </div>
            <p class="text-sm text-slate-600 mb-6">
                Aplikasi SIKAJI menggunakan Supabase. Kredensial telah dimuat otomatis.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Supabase Project URL</label>
                    <input type="text" id="supabase-url" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none placeholder-slate-400" value="https://cfnnibbzhbylykckhpiy.supabase.co">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Supabase Anon Key</label>
                    <input type="password" id="supabase-key" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none placeholder-slate-400" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbm5pYmJ6aGJ5bHlrY2tocGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4OTAyMTAsImV4cCI6MjA4NjQ2NjIxMH0.Xuk9m85FQ8VrRjxyMeCxnx-3_8plOBVm9-Im9S41wPk">
                </div>
            </div>

            <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 mb-6">
                <h4 class="text-xs font-bold text-slate-700 uppercase mb-2 flex justify-between items-center">
                    <span>Langkah Wajib: Buat Tabel SQL (Termasuk Tabel User)</span>
                    <button onclick="window.copySQL()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded text-[10px] transition-colors"><i class="ph ph-copy"></i> Copy Script</button>
                </h4>
                <p class="text-xs text-slate-500 mb-2"><strong>PERHATIAN:</strong> Script ini membuat tabel 'users' dan akun admin default.</p>
                <textarea id="sql-script" class="w-full h-32 p-3 bg-slate-800 text-emerald-400 border border-slate-700 rounded-lg text-xs font-mono outline-none" readonly>
-- Script Setup SIKAJI ASN Database (Production)
CREATE TABLE IF NOT EXISTS users ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, username TEXT UNIQUE, password TEXT, name TEXT, role TEXT );
CREATE TABLE IF NOT EXISTS employees ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, nama TEXT, nip TEXT, jabatan TEXT, jenis_jabatan TEXT, golongan TEXT, mk_tahun INTEGER, mk_bulan INTEGER, tgl_lahir DATE, tmt_pangkat DATE, tmt_berkala DATE, nilai_skp TEXT, hukuman_disiplin BOOLEAN, lastsync BIGINT, salaryregulation TEXT );
CREATE TABLE IF NOT EXISTS proposals ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, empid UUID, empname TEXT, empnip TEXT, type TEXT, status TEXT, date TIMESTAMP, newtmt DATE, oldrank TEXT, newrank TEXT, newgaji BIGINT, newmktahun INTEGER, reduction INTEGER );
CREATE TABLE IF NOT EXISTS activity_logs ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, text TEXT, type TEXT, time TEXT, createdat BIGINT );
CREATE TABLE IF NOT EXISTS settings ( id TEXT PRIMARY KEY, signername TEXT, signernip TEXT, signerposition TEXT, signergolongan TEXT, logourl TEXT, regulation TEXT, effectivedate TEXT, ranges JSONB, updatedat BIGINT, updatedby TEXT );

-- Buat User Admin Default (Jika belum ada)
INSERT INTO users (username, password, name, role) VALUES ('admin', 'admin123', 'Administrator', 'admin') ON CONFLICT (username) DO NOTHING;

-- Bypass RLS (Untuk Kemudahan Akses Internal)
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE employees DISABLE ROW LEVEL SECURITY;
ALTER TABLE proposals DISABLE ROW LEVEL SECURITY;
ALTER TABLE activity_logs DISABLE ROW LEVEL SECURITY;
ALTER TABLE settings DISABLE ROW LEVEL SECURITY;
                </textarea>
            </div>

            <button onclick="window.saveLocalConfig()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                <i class="ph ph-plug"></i> Hubungkan ke Database
            </button>
        </div>
    </div>

    <!-- VIEW: LOGIN INTERFACE -->
    <div id="login-interface" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-200 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-teal-500"></div>
            <div class="text-center mb-8">
                <!-- LOGO UPDATE: Menambahkan referrerpolicy dan fallback berlapis -->
                <img src="https://kalselprov.go.id/wp-content/uploads/2020/09/Logo-Kalsel.png" 
                     referrerpolicy="no-referrer"
                     onerror="if (this.src != 'https://jdih.kalselprov.go.id/assets/img/logo-kalsel.png') this.src = 'https://jdih.kalselprov.go.id/assets/img/logo-kalsel.png'; else this.style.display = 'none';" 
                     class="h-24 w-auto mx-auto mb-4 drop-shadow-md object-contain" 
                     alt="Logo Pemprov Kalsel">
                <h1 class="text-2xl font-bold text-slate-800">SIKAJI ASN</h1>
                <p class="text-sm text-slate-500">Sistem Informasi Kepegawaian</p>
            </div>
            <form onsubmit="event.preventDefault(); window.performLogin();" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input type="text" id="login-username" class="w-full pl-4 pr-4 py-3 border border-slate-300 rounded-xl text-sm outline-none transition-all focus:ring-2 focus:ring-emerald-500" placeholder="Masukkan username" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full pl-4 pr-4 py-3 border border-slate-300 rounded-xl text-sm outline-none transition-all focus:ring-2 focus:ring-emerald-500" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                    <i class="ph ph-sign-in text-lg"></i> Masuk Aplikasi
                </button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400 space-y-2">
                <p>Login menggunakan akun Database Anda.</p>
            </div>
            <button onclick="window.resetAppConfig()" class="mt-4 text-xs text-slate-400 hover:text-red-500 underline w-full text-center">Reset Koneksi Database</button>
        </div>
        <div class="absolute bottom-6 text-slate-400 text-xs font-medium">&copy; 2025 Dinas PUPR Provinsi Kalsel - Lab Bahan Konstruksi</div>
    </div>

    <!-- VIEW: APP INTERFACE -->
    <div id="app-interface" class="hidden flex h-screen w-full">
        <aside class="w-64 bg-slate-900 text-white flex flex-col shrink-0 shadow-2xl z-30 transition-all duration-300" id="sidebar">
            <div class="p-6 flex items-center gap-3 border-b border-slate-700/50">
                <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-[0_0_15px_rgba(16,185,129,0.3)]">S</div>
                <div><h1 class="font-bold tracking-tight text-lg leading-tight">SIKAJI ASN</h1><p class="text-[10px] text-emerald-400 font-medium">PostgreSQL Powered</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <button onclick="window.nav('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group sidebar-item-active" id="nav-dashboard"><i class="ph ph-squares-four text-xl"></i> <span class="font-medium text-sm">Dashboard</span></button>
                <button onclick="window.nav('pegawai')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-pegawai"><i class="ph ph-users text-xl"></i> <span class="font-medium text-sm">Data Pegawai</span></button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Layanan Karir</div>
                <button onclick="window.nav('usulan-pangkat')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-usulan-pangkat"><i class="ph ph-trend-up text-xl"></i> <span class="font-medium text-sm">Usulan Pangkat</span><span id="badge-pangkat" class="hidden ml-auto bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span></button>
                <button onclick="window.nav('usulan-kgb')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-usulan-kgb"><i class="ph ph-money text-xl"></i> <span class="font-medium text-sm">Usulan KGB</span><span id="badge-kgb" class="hidden ml-auto bg-emerald-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span></button>
                <button onclick="window.nav('verifikasi')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-verifikasi"><i class="ph ph-check-circle text-xl"></i> <span class="font-medium text-sm">Verifikasi Usulan</span><span id="badge-verif" class="hidden ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span></button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Laporan & Sistem</div>
                <button onclick="window.nav('simulation')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-simulation"><i class="ph ph-calculator text-xl"></i> <span class="font-medium text-sm">Simulasi Karir</span></button>
                <button onclick="window.nav('laporan')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-laporan"><i class="ph ph-file-pdf text-xl"></i> <span class="font-medium text-sm">Pusat Laporan</span></button>
                <button onclick="window.nav('salary')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-salary"><i class="ph ph-table text-xl"></i> <span class="font-medium text-sm">Standar Gaji</span></button>
                <button onclick="window.nav('pensiun')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-pensiun"><i class="ph ph-hourglass-high text-xl"></i> <span class="font-medium text-sm">Monitoring Pensiun</span></button>
                <button onclick="window.nav('settings')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-settings"><i class="ph ph-gear text-xl"></i> <span class="font-medium text-sm">Pengaturan</span></button>
                <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Manajemen Data</div>
                <button onclick="window.nav('update-data')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group mb-2" id="nav-update-data"><i class="ph ph-database-gear text-xl"></i> <span class="font-medium text-sm">Update Data</span></button>
            </nav>
            <div class="p-4 border-t border-slate-700/50 bg-slate-800/50 flex justify-between items-center">
                <div class="flex items-center gap-3"><img src="https://ui-avatars.com/api/?name=Admin+Sikaji&background=10b981&color=fff" class="w-10 h-10 rounded-full border-2 border-slate-600" id="user-avatar-display"><div><p class="text-sm font-bold text-white" id="user-name-display">Administrator</p><p class="text-[10px] text-slate-400">Kepegawaian</p></div></div>
                <button onclick="window.performLogout()" class="text-slate-400 hover:text-red-400 transition-colors" title="Keluar"><i class="ph ph-sign-out text-xl"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative bg-slate-50/50">
            <header class="glass-panel h-16 flex items-center justify-between px-8 z-20 shrink-0 sticky top-0 shadow-sm">
                <div class="flex items-center gap-4"><h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard Eksekutif</h2></div>
                <div class="flex items-center gap-4"><div id="clock" class="text-sm font-mono font-bold text-slate-500 hidden md:block"></div><div class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold border border-emerald-100 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Regulasi: Perpres 10/2024</div></div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth" id="content-area">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group">
                        <div class="relative z-10 max-w-2xl"><h2 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang di SIKAJI ASN ðŸ‘‹</h2><p class="text-slate-500 mb-6">Sistem kini berjalan di atas arsitektur <strong>Supabase (PostgreSQL)</strong>. Data lebih rapi, relasional, dan aman. Gaji telah disesuaikan dengan Perpres No. 10 Tahun 2024.</p><button onclick="window.nav('pegawai')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2"><i class="ph ph-users"></i> Kelola Data Pegawai</button></div>
                        <div class="absolute right-0 top-0 w-80 h-80 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-full -mr-20 -mt-20 z-0 opacity-50"></div>
                        <i class="ph ph-database absolute right-10 bottom-10 text-9xl text-slate-100 z-0"></i>
                    </div>
                    <div id="priority-section" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="gradient-card-1 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform"><div class="relative z-10"><div class="flex justify-between items-start mb-4"><div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-users-three text-xl"></i></div><span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">TOTAL</span></div><div class="text-4xl font-bold mb-1" id="stat-total">0</div><div class="text-blue-100 text-xs font-medium">Pegawai Aktif</div></div><i class="ph ph-users-three absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i></div>
                        <div class="gradient-card-2 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform"><div class="relative z-10"><div class="flex justify-between items-start mb-4"><div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-trend-up text-xl"></i></div><span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">ELIGIBLE</span></div><div class="text-4xl font-bold mb-1" id="stat-pangkat">0</div><div class="text-emerald-100 text-xs font-medium">Kenaikan Pangkat</div></div><i class="ph ph-trend-up absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i></div>
                        <div class="gradient-card-3 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform"><div class="relative z-10"><div class="flex justify-between items-start mb-4"><div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-money text-xl"></i></div><span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">ELIGIBLE</span></div><div class="text-4xl font-bold mb-1" id="stat-kgb">0</div><div class="text-purple-100 text-xs font-medium">Kenaikan Gaji Berkala</div></div><i class="ph ph-money absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i></div>
                        <div onclick="window.nav('verifikasi')" class="gradient-card-4 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden cursor-pointer group hover:-translate-y-1 transition-transform"><div class="relative z-10"><div class="flex justify-between items-start mb-4"><div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-stamp text-xl"></i></div><span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded animate-pulse">ACTION</span></div><div class="text-4xl font-bold mb-1" id="hero-pending-count">0</div><div class="text-amber-100 text-xs font-medium">Menunggu Verifikasi</div></div><i class="ph ph-stamp absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-chart-bar text-xl text-blue-500"></i> Distribusi Golongan</h3></div><div class="h-64 w-full relative"><canvas id="chart-golongan"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-xl text-slate-500"></i> Log Aktivitas (Terbaru)</h3><button onclick="window.loadData()" class="text-xs text-blue-500 hover:underline"><i class="ph ph-arrows-clockwise"></i> Refresh</button></div><div class="flex-1 overflow-y-auto pr-2 max-h-[250px] space-y-4" id="activity-log-container"></div></div>
                    </div>
                </div>

                <!-- PEGAWAI -->
                <div id="view-pegawai" class="hidden space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-2xl border border-slate-200 shadow-sm gap-4">
                        <div><h2 class="font-bold text-lg text-slate-800">Direktori Pegawai</h2><p class="text-sm text-slate-500">Data tersimpan di Supabase PostgreSQL.</p></div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto"><div class="relative"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="search-pegawai" onkeyup="window.renderPegawai()" placeholder="Cari Nama / NIP..." class="pl-9 pr-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none w-full sm:w-64"></div><button onclick="window.openAddEmployeeModal()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl shadow-lg font-bold text-sm flex items-center gap-2 transition-colors"><i class="ph ph-user-plus text-lg"></i> Tambah</button></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th class="p-4 pl-6">Pegawai</th><th class="p-4">Jabatan & Golongan</th><th class="p-4">Riwayat TMT</th><th class="p-4 text-center">MKG (SK)</th><th class="p-4 text-right">Gaji Pokok</th><th class="p-4 text-center">Aksi</th></tr></thead><tbody id="table-pegawai-body" class="divide-y divide-slate-100 bg-white"></tbody></table></div><div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-center text-xs text-slate-500"><span id="pegawai-count">Menampilkan data pegawai</span></div></div>
                </div>

                <!-- USULAN -->
                <div id="view-usulan" class="hidden space-y-6 animate-fade-in">
                    <div id="usulan-header-card" class="bg-gradient-to-r from-emerald-600 to-teal-500 text-white p-8 rounded-2xl shadow-xl relative overflow-hidden transition-colors duration-300"><div class="relative z-10"><h3 class="font-bold text-2xl mb-1" id="usulan-title">Periodisasi KP</h3><p class="text-emerald-100 text-sm max-w-2xl opacity-90">Sistem mendeteksi pegawai eligible berdasarkan MKG Kumulatif (PerBKN 4/2025).</p><div class="mt-6 flex gap-4"><div class="bg-white/20 backdrop-blur-md px-5 py-2.5 rounded-xl border border-white/30 flex items-center gap-3"><div class="p-2 bg-white/20 rounded-full"><i class="ph ph-users text-xl"></i></div><div><p class="text-[10px] uppercase font-bold opacity-80">Total Eligible</p><p class="text-xl font-bold" id="usulan-count">0</p></div></div></div></div><i class="ph ph-trend-up absolute right-0 top-0 text-[15rem] opacity-10 -mr-10 -mt-10"></i></div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h4 class="font-bold text-slate-700 text-sm">Daftar Nominatif Usulan</h4><div class="relative"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="search-usulan" onkeyup="window.filterUsulanTable()" placeholder="Filter..." class="pl-8 pr-3 py-1.5 border border-slate-300 rounded-lg text-xs w-48 bg-white"></div></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th class="p-5 pl-6 w-1/3">Pegawai</th><th class="p-5 w-1/3">Estimasi Perubahan</th><th class="p-5 text-center">Analisis Sistem</th><th class="p-5 text-right pr-6">Aksi</th></tr></thead><tbody id="table-usulan-body" class="divide-y divide-slate-100"></tbody></table></div>
                </div>

                <!-- VERIFIKASI -->
                <div id="view-verifikasi" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center"><div><h3 class="font-bold text-slate-800 text-xl">Antrian Verifikasi</h3><p class="text-slate-500 text-sm">Verifikasi menerapkan pengurangan MKG otomatis (Lintas Golongan).</p></div><button onclick="window.printGeneralReport('PENDING')" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2"><i class="ph ph-printer"></i> Cetak Daftar Antrian</button></div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-4 pl-6">Tgl Usulan</th><th class="p-4">Jenis</th><th class="p-4">Pegawai</th><th class="p-4">Detail Perubahan</th><th class="p-4 text-center">Status</th><th class="p-4 text-right pr-6">Kontrol</th></tr></thead><tbody id="table-verifikasi-body" class="divide-y divide-slate-100"></tbody></table></div>
                </div>

                <!-- SIMULATION -->
                <div id="view-simulation" class="hidden space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><i class="ph ph-sliders-horizontal text-emerald-600"></i> Parameter Simulasi</h3><p class="text-xs text-slate-500 mb-6">Masukkan data terkini untuk memproyeksikan kenaikan pangkat dan gaji hingga 10 tahun ke depan.</p><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Golongan Saat Ini</label><select id="sim-golongan" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Tahun</label><input type="number" id="sim-mk-tahun" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value="0"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Bulan</label><input type="number" id="sim-mk-bulan" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value="0"></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Pangkat Terakhir</label><input type="date" id="sim-tmt-pangkat" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Berkala Terakhir</label><input type="date" id="sim-tmt-berkala" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none"></div><button onclick="window.runSimulation()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg transition-colors flex items-center justify-center gap-2 mt-4"><i class="ph ph-magic-wand text-lg"></i> Hitung Proyeksi</button></div></div>
                        <div class="lg:col-span-2 space-y-6"><div id="sim-result-header" class="hidden bg-slate-800 text-white p-6 rounded-2xl shadow-lg"><h4 class="text-lg font-bold">Hasil Proyeksi Karir (10 Tahun)</h4><p class="text-slate-300 text-sm">Estimasi kenaikan berdasarkan regulasi PP 5/2024 & PerBKN 4/2025.</p></div><div id="sim-timeline" class="space-y-4 relative"><div class="text-center text-slate-400 py-20 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50"><i class="ph ph-chart-line-up text-4xl mb-2 text-slate-300"></i><p>Masukkan parameter di sebelah kiri<br>untuk melihat hasil simulasi.</p></div></div></div>
                    </div>
                </div>

                <!-- LAPORAN -->
                <div id="view-laporan" class="hidden space-y-6 animate-fade-in">
                    <div class="flex items-center justify-between"><div><h3 class="font-bold text-slate-800 text-xl">Pusat Laporan</h3><p class="text-slate-500 text-sm">Cetak dokumen rekapitulasi kepegawaian dan usulan.</p></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group cursor-pointer" onclick="window.printGeneralReport('ALL')"><div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform"><i class="ph ph-users-three text-2xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Daftar Nominatif</h4><p class="text-sm text-slate-500 mb-6">Rekapitulasi seluruh data pegawai aktif beserta pangkat dan jabatan terakhir.</p><button class="w-full py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800 transition-colors flex items-center justify-center gap-2"><i class="ph ph-printer"></i> Cetak Nominatif</button></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group cursor-pointer" onclick="window.printGeneralReport('APPROVED')"><div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 mb-4 group-hover:scale-110 transition-transform"><i class="ph ph-check-fat text-2xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Rekap SK Terbit</h4><p class="text-sm text-slate-500 mb-6">Daftar usulan KP dan KGB yang telah disetujui dan diterbitkan SK-nya.</p><button class="w-full py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2"><i class="ph ph-printer"></i> Cetak Laporan SK</button></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group cursor-pointer" onclick="window.printGeneralReport('PENDING')"><div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600 mb-4 group-hover:scale-110 transition-transform"><i class="ph ph-clock-countdown text-2xl"></i></div><h4 class="font-bold text-slate-800 text-lg mb-2">Antrian Verifikasi</h4><p class="text-sm text-slate-500 mb-6">Daftar usulan yang masih menunggu persetujuan pejabat berwenang.</p><button class="w-full py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2"><i class="ph ph-printer"></i> Cetak Antrian</button></div>
                    </div>
                </div>

                <!-- SALARY TABLE -->
                <div id="view-salary" class="hidden space-y-6 animate-fade-in"><div class="flex justify-between items-center mb-4"><div><h3 class="font-bold text-slate-800 text-xl">Tabel Gaji Pokok PNS (Perpres 10/2024)</h3><p class="text-slate-500 text-sm">Penyesuaian gaji pokok berdasarkan Perpres No. 10 Tahun 2024.</p></div><div class="text-xs bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1.5 rounded-lg font-bold">Efektif: Jan 2024</div></div><div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-slate-900 text-white font-bold border-b border-slate-800 uppercase text-xs"><tr><th class="p-4 pl-6">Golongan</th><th class="p-4">Pangkat</th><th class="p-4 text-center">MKG Min (0 Thn)</th><th class="p-4 text-center">MKG Maks</th><th class="p-4 text-right pr-6">Gaji Maksimal</th></tr></thead><tbody id="table-salary-body" class="divide-y divide-slate-100"></tbody></table></div></div></div>

                <!-- PENSIUN -->
                <div id="view-pensiun" class="hidden space-y-6 animate-fade-in"><div class="flex items-center justify-between"><h3 class="font-bold text-slate-700 text-xl">Monitoring Batas Usia Pensiun</h3><span class="text-xs bg-red-50 text-red-600 border border-red-100 px-3 py-1 rounded-full font-bold">BUP: 58 Tahun</span></div><div id="pensiun-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mt-6"><div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 text-sm">Daftar Lengkap Estimasi Pensiun</div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-4 pl-6">Pegawai</th><th class="p-4">Tanggal Lahir</th><th class="p-4 text-center">Usia Saat Ini</th><th class="p-4 text-center">Sisa Masa Kerja</th><th class="p-4">TMT Pensiun</th></tr></thead><tbody id="table-pensiun-body" class="divide-y divide-slate-100"></tbody></table></div></div>

                <!-- UPDATE DATA -->
                <div id="view-update-data" class="hidden space-y-6 animate-fade-in">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600"><i class="ph ph-database-gear text-2xl"></i></div>
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">Pemutakhiran Data Sistem</h3>
                                <p class="text-slate-500 text-sm">Kelola referensi global dan sinkronisasi data pegawai dengan Postgres.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="border border-slate-200 rounded-xl p-6 hover:border-blue-500 hover:bg-blue-50/30 transition-all cursor-pointer group" onclick="window.updateSalaryReference()">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform"><i class="ph ph-table text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">Regulasi 2024</span>
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">Update Referensi Gaji</h4>
                                <p class="text-xs text-slate-500">Terapkan standar gaji pokok Perpres No. 10 Tahun 2024 ke database Supabase.</p>
                            </div>

                            <div class="border border-slate-200 rounded-xl p-6 hover:border-emerald-500 hover:bg-emerald-50/30 transition-all cursor-pointer group" onclick="window.syncEmployeeData()">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform"><i class="ph ph-arrows-clockwise text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-2 py-1 rounded">Sync</span>
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">Refresh Data Tabel</h4>
                                <p class="text-xs text-slate-500">Tarik ulang data terbaru dari server untuk memastikan sinkronisasi.</p>
                            </div>

                            <div class="border border-slate-200 rounded-xl p-6 hover:border-purple-500 hover:bg-purple-50/30 transition-all cursor-pointer group" onclick="window.openAddEmployeeModal()">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 group-hover:scale-110 transition-transform"><i class="ph ph-user-plus text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded">Input</span>
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">Input Pegawai Baru</h4>
                                <p class="text-xs text-slate-500">Tambahkan data pegawai baru ke dalam database SQL.</p>
                            </div>

                            <div class="border border-slate-200 rounded-xl p-6 hover:border-teal-500 hover:bg-teal-50/30 transition-all cursor-pointer group" onclick="window.nav('verifikasi')">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center text-teal-600 group-hover:scale-110 transition-transform"><i class="ph ph-check-circle text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-teal-100 text-teal-700 px-2 py-1 rounded">Approval</span>
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">Verifikasi Usulan</h4>
                                <p class="text-xs text-slate-500">Validasi perubahan data pangkat dan gaji berkala yang tertunda.</p>
                            </div>
                        </div>

                        <!-- ZONA BERBAHAYA -->
                        <div class="mt-8 pt-6 border-t border-red-100">
                            <h4 class="font-bold text-red-600 mb-4 flex items-center gap-2"><i class="ph ph-warning-octagon"></i> Zona Berbahaya</h4>
                            <div class="bg-red-50 p-6 rounded-xl border border-red-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h5 class="font-bold text-red-800">Hapus Keseluruhan Data Pegawai</h5>
                                    <p class="text-xs text-red-600 mt-1">Menghapus seluruh rekaman dari tabel Supabase. Tindakan ini <strong>permanen</strong>.</p>
                                </div>
                                <button onclick="window.wipeDatabase()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-red-700 transition-all shrink-0 flex items-center gap-2">
                                    <i class="ph ph-trash"></i> Kosongkan Tabel
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- SETTINGS -->
                <div id="view-settings" class="hidden space-y-6 animate-fade-in"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200"><h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b pb-4"><i class="ph ph-lock-key text-xl"></i> Keamanan Akun</h4><div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100"><p class="text-sm text-slate-600 mb-2">Anda login sebagai: <strong id="settings-current-user">admin</strong></p></div><form onsubmit="event.preventDefault(); window.changePassword();" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Lama</label><input type="password" id="set-pass-old" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none" required></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Baru</label><input type="password" id="set-pass-new" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none" required></div></div><div class="flex justify-end"><button type="submit" class="bg-amber-500 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-amber-600 transition-all flex items-center gap-2 text-sm"><i class="ph ph-key"></i> Ganti Password</button></div></form></div><div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200"><h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b pb-4"><i class="ph ph-pen-nib text-xl"></i> Konfigurasi Tanda Tangan SK</h4><div class="mb-8 flex items-start gap-6 p-4 bg-slate-50 rounded-xl border border-slate-100"><div class="w-20 h-20 bg-white rounded-lg border border-slate-200 flex items-center justify-center p-2 shadow-sm overflow-hidden"><img id="settings-logo-preview" src="" class="w-full h-full object-contain"></div><div class="flex-1"><label class="block text-sm font-bold text-slate-700 mb-1">Logo Kop Surat</label><div class="flex gap-3"><label for="input-logo" class="cursor-pointer px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2"><i class="ph ph-upload-simple"></i> Upload Logo</label><input type="file" id="input-logo" accept="image/*" class="hidden" onchange="window.uploadLogo(event)"><button onclick="window.resetLogo()" class="px-3 py-1.5 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors">Reset Default</button></div></div></div><form id="form-settings" onsubmit="event.preventDefault(); window.saveSettings();"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Pejabat</label><input type="text" id="set-nama" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none" oninput="window.updateQRPreview()"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP Pejabat</label><input type="text" id="set-nip" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none" oninput="window.updateQRPreview()"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan Struktural</label><input type="text" id="set-jabatan" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat/Golongan</label><select id="set-golongan" class="w-full p-3 border border-slate-300 rounded-xl bg-white text-sm focus:ring-2 focus:ring-emerald-500 outline-none"></select></div></div><div class="mt-8 flex justify-end"><button type="submit" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2"><i class="ph ph-floppy-disk"></i> Simpan Konfigurasi</button></div></form></div></div><div class="bg-slate-100 p-6 rounded-2xl border border-slate-200 flex flex-col items-center justify-center text-center"><p class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Preview Digital Signature</p><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-4 w-full max-w-[200px]"><img id="set-qr-preview" src="" class="w-full aspect-square object-contain mix-blend-multiply" alt="QR Validasi"></div><div class="text-xs text-slate-600 space-y-1"><p class="font-bold">Ditandatangani secara elektronik oleh:</p><p id="preview-nama-pejabat" class="font-medium text-slate-800 text-sm">...</p><p id="preview-nip-pejabat" class="font-mono text-[10px] text-slate-500">NIP. ...</p></div><div class="mt-4 flex items-center gap-2 text-[10px] text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100"><i class="ph ph-shield-check text-lg"></i> Sertifikat Valid</div></div></div></div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-add-employee" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeAddEmployeeModal()"></div><div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-transform duration-300 m-4 flex flex-col max-h-[90vh]" id="modal-content"><div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10"><div><h3 class="text-xl font-bold text-slate-800" id="modal-title">Form Data Pegawai</h3><p class="text-xs text-slate-500 mt-1">Lengkapi data pegawai sesuai SK terakhir.</p></div><button onclick="window.closeAddEmployeeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="ph ph-x text-xl"></i></button></div><div class="flex-1 overflow-y-auto bg-slate-50/50 p-6 md:p-8"><form id="form-add-employee" class="space-y-8"><input type="hidden" id="input-id"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-user-circle text-lg text-emerald-500"></i> Identitas Pegawai</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label><input id="input-nama" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP</label><input id="input-nip" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tgl Lahir</label><input type="date" id="input-lahir" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-briefcase text-lg text-teal-500"></i> Data Jabatan</h4><div class="grid grid-cols-1 md:grid-cols-12 gap-6"><div class="md:col-span-7 space-y-6"><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenis</label><select id="input-jenis-jabatan" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white"><option value="Umum">Pelaksana</option><option value="Fungsional">Fungsional</option><option value="Struktural">Struktural</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Jabatan</label><input id="input-jabatan" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat</label><select id="input-golongan" onchange="window.previewGajiForm()" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG</label><div class="flex gap-2"><input type="number" id="input-mk-tahun" onchange="window.previewGajiForm()" class="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="Thn"><input type="number" id="input-mk-bulan" class="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="Bln"></div></div></div></div><div class="md:col-span-5 bg-slate-50 p-5 rounded-xl border border-dashed border-slate-300 flex flex-col justify-center text-center"><p class="text-xs font-bold text-slate-400 uppercase mb-2">Estimasi Gaji</p><div id="form-salary-preview" class="text-2xl font-bold text-slate-800 font-mono">Rp 0</div></div></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-xs font-bold text-emerald-600 uppercase mb-1">TMT Pangkat</label><input type="date" id="input-tmt-pangkat" class="w-full p-3 border border-emerald-200 bg-emerald-50/30 rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-teal-600 uppercase mb-1">TMT Berkala</label><input type="date" id="input-tmt-berkala" class="w-full p-3 border border-teal-200 bg-teal-50/30 rounded-lg text-sm"></div></div><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nilai SKP</label><select id="input-skp" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"><option value="Sangat Baik">Sangat Baik</option><option value="Baik">Baik</option><option value="Cukup">Cukup</option></select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hukuman</label><select id="input-hukuman" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"><option value="false">Tidak Ada</option><option value="true">Ada Hukuman</option></select></div></div></div></div></form></div><div class="p-6 border-t border-slate-100 bg-white flex justify-end gap-3 sticky bottom-0 z-10"><button onclick="window.closeAddEmployeeModal()" class="px-6 py-3 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-100">Batal</button><button onclick="window.saveNewEmployee()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800 shadow-lg">Simpan</button></div></div></div>
    
    <div id="toast-container" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2"></div>

    <!-- SUPABASE IMPORT -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- CONSTANTS ---
        let GAJI_POKOK_2024 = {
            'I/a': { 0: 1685700, 1: 1685700, 2: 1738800, 3: 1738800, 4: 1793500, 5: 1793500, 6: 1850000, 7: 1850000, 8: 1908300, 9: 1908300, 10: 1968400, 11: 1968400, 12: 2030400, 13: 2030400, 14: 2094300, 15: 2094300, 16: 2160300, 17: 2160300, 18: 2228300, 19: 2228300, 20: 2298500, 21: 2298500, 22: 2370900, 23: 2370900, 24: 2445500, 25: 2445500, 26: 2522600 },
            'I/b': { 3: 1840800, 4: 1840800, 5: 1898800, 6: 1898800, 7: 1958600, 8: 1958600, 9: 2020300, 10: 2020300, 11: 2083900, 12: 2083900, 13: 2149600, 14: 2149600, 15: 2217300, 16: 2217300, 17: 2287100, 18: 2287100, 19: 2359100, 20: 2359100, 21: 2433400, 22: 2433400, 23: 2510100, 24: 2510100, 25: 2589100, 26: 2589100, 27: 2670700 },
            'I/c': { 3: 1918700, 4: 1918700, 5: 1979100, 6: 1979100, 7: 2041500, 8: 2041500, 9: 2105800, 10: 2105800, 11: 2172100, 12: 2172100, 13: 2240500, 14: 2240500, 15: 2311100, 16: 2311100, 17: 2383900, 18: 2383900, 19: 2458900, 20: 2458900, 21: 2536400, 22: 2536400, 23: 2616300, 24: 2616300, 25: 2698700, 26: 2698700, 27: 2783700 },
            'I/d': { 3: 1999900, 4: 1999900, 5: 2062900, 6: 2062900, 7: 2127800, 8: 2127800, 9: 2194800, 10: 2194800, 11: 2264000, 12: 2264000, 13: 2335300, 14: 2335300, 15: 2408800, 16: 2408800, 17: 2484700, 18: 2484700, 19: 2562900, 20: 2562900, 21: 2643700, 22: 2643700, 23: 2726900, 24: 2726900, 25: 2812800, 26: 2812800, 27: 2901400 },
            'II/a': { 0: 2184000, 1: 2184000, 2: 2218400, 3: 2218400, 4: 2288200, 5: 2288200, 6: 2360300, 7: 2360300, 8: 2434600, 9: 2434600, 10: 2511300, 11: 2511300, 12: 2590400, 13: 2590400, 14: 2672000, 15: 2672000, 16: 2756200, 17: 2756200, 18: 2843000, 19: 2843000, 20: 2932500, 21: 2932500, 22: 3024900, 23: 3024900, 24: 3120100, 25: 3120100, 26: 3218400, 27: 3218400, 28: 3319800, 29: 3319800, 30: 3424300, 31: 3424300, 32: 3532200, 33: 3643400 },
            'II/b': { 3: 2385000, 4: 2385000, 5: 2460100, 6: 2460100, 7: 2537600, 8: 2537600, 9: 2617500, 10: 2617500, 11: 2700000, 12: 2700000, 13: 2785000, 14: 2785000, 15: 2872700, 16: 2872700, 17: 2963200, 18: 2963200, 19: 3056500, 20: 3056500, 21: 3152800, 22: 3152800, 23: 3252100, 24: 3252100, 25: 3354500, 26: 3354500, 27: 3460200, 28: 3460200, 29: 3569200, 30: 3569200, 31: 3681600, 32: 3681600, 33: 3797500 },
            'II/c': { 3: 2485900, 4: 2485900, 5: 2564200, 6: 2564200, 7: 2645000, 8: 2645000, 9: 2728300, 10: 2728300, 11: 2814200, 12: 2814200, 13: 2902800, 14: 2902800, 15: 2994300, 16: 2994300, 17: 3088600, 18: 3088600, 19: 3185800, 20: 3185800, 21: 3286200, 22: 3286200, 23: 3389700, 24: 3389700, 25: 3496400, 26: 3496400, 27: 3606500, 28: 3606500, 29: 3720100, 30: 3720100, 31: 3837300, 32: 3837300, 33: 3958200 },
            'II/d': { 3: 2591100, 4: 2591100, 5: 2672700, 6: 2672700, 7: 2756800, 8: 2756800, 9: 2843700, 10: 2843700, 11: 2933200, 12: 2933200, 13: 3025600, 14: 3025600, 15: 3120900, 16: 3120900, 17: 3219200, 18: 3219200, 19: 3320600, 20: 3320600, 21: 3425200, 22: 3425200, 23: 3533100, 24: 3533100, 25: 3644300, 26: 3644300, 27: 3759100, 28: 3759100, 29: 3877500, 30: 3877500, 31: 3999600, 32: 3999600, 33: 4125600 },
            'III/a': { 0: 2785700, 1: 2785700, 2: 2873500, 3: 2873500, 4: 2964000, 5: 2964000, 6: 3057300, 7: 3057300, 8: 3153600, 9: 3153600, 10: 3252900, 11: 3252900, 12: 3355400, 13: 3355400, 14: 3461100, 15: 3461100, 16: 3570100, 17: 3570100, 18: 3682500, 19: 3682500, 20: 3798500, 21: 3798500, 22: 3918100, 23: 3918100, 24: 4041500, 25: 4041500, 26: 4168800, 27: 4168800, 28: 4300100, 29: 4300100, 30: 4435500, 31: 4435500, 32: 4575200 },
            'III/b': { 0: 2903600, 1: 2903600, 2: 2995000, 3: 2995000, 4: 3089300, 5: 3089300, 6: 3186600, 7: 3186600, 8: 3287000, 9: 3287000, 10: 3390500, 11: 3390500, 12: 3497300, 13: 3497300, 14: 3607500, 15: 3607500, 16: 3721100, 17: 3721100, 18: 3838300, 19: 3838300, 20: 3959200, 21: 3959200, 22: 4083900, 23: 4083900, 24: 4212500, 25: 4212500, 26: 4345100, 27: 4345100, 28: 4482000, 29: 4482000, 30: 4623200, 31: 4623200, 32: 4768800 },
            'III/c': { 0: 3026400, 1: 3026400, 2: 3121700, 3: 3121700, 4: 3220000, 5: 3220000, 6: 3321400, 7: 3321400, 8: 3426000, 9: 3426000, 10: 3533900, 11: 3533900, 12: 3645200, 13: 3645200, 14: 3760100, 15: 3760100, 16: 3878500, 17: 3878500, 18: 4000600, 19: 4000600, 20: 4126600, 21: 4126600, 22: 4256600, 23: 4256600, 24: 4390700, 25: 4390700, 26: 4528900, 27: 4528900, 28: 4671600, 29: 4671600, 30: 4818700, 31: 4818700, 32: 4970500 },
            'III/d': { 0: 3154400, 1: 3154400, 2: 3253700, 3: 3253700, 4: 3356200, 5: 3356200, 6: 3461900, 7: 3461900, 8: 3571000, 9: 3571000, 10: 3683400, 11: 3683400, 12: 3799400, 13: 3799400, 14: 3919100, 15: 3919100, 16: 4042500, 17: 4042500, 18: 4169900, 19: 4169900, 20: 4301200, 21: 4301200, 22: 4436700, 23: 4436700, 24: 4576400, 25: 4576400, 26: 4720500, 27: 4720500, 28: 4869200, 29: 4869200, 30: 5022500, 31: 5022500, 32: 5180700 },
            'IV/a': { 0: 3287800, 1: 3287800, 2: 3391400, 3: 3391400, 4: 3498200, 5: 3498200, 6: 3608400, 7: 3608400, 8: 3722000, 9: 3722000, 10: 3839200, 11: 3839200, 12: 3960200, 13: 3960200, 14: 4084900, 15: 4084900, 16: 4213500, 17: 4213500, 18: 4346200, 19: 4346200, 20: 4483100, 21: 4483100, 22: 4624300, 23: 4624300, 24: 4770000, 25: 4770000, 26: 4920200, 27: 4920200, 28: 5075200, 29: 5075200, 30: 5235000, 31: 5235000, 32: 5399900 },
            'IV/b': { 0: 3426900, 1: 3426900, 2: 3534800, 3: 3534800, 4: 3646200, 5: 3646200, 6: 3761000, 7: 3761000, 8: 3879500, 9: 3879500, 10: 4001600, 11: 4001600, 12: 4127700, 13: 4127700, 14: 4257700, 15: 4257700, 16: 4391800, 17: 4391800, 18: 4530100, 19: 4530100, 20: 4672800, 21: 4672800, 22: 4819900, 23: 4819900, 24: 4971700, 25: 4971700, 26: 5128300, 27: 5128300, 28: 5289800, 29: 5289800, 30: 5456400, 31: 5456400, 32: 5628300 },
            'IV/c': { 0: 3571900, 1: 3571900, 2: 3684400, 3: 3684400, 4: 3800400, 5: 3800400, 6: 3920100, 7: 3920100, 8: 4043600, 9: 4043600, 10: 4170900, 11: 4170900, 12: 4302300, 13: 4302300, 14: 4437800, 15: 4437800, 16: 4577500, 17: 4577500, 18: 4721700, 19: 4721700, 20: 4870400, 21: 4870400, 22: 5023800, 23: 5023800, 24: 5182000, 25: 5182000, 26: 5345200, 27: 5345200, 28: 5513600, 29: 5513600, 30: 5687200, 31: 5687200, 32: 5866400 },
            'IV/d': { 0: 3723000, 1: 3723000, 2: 3840200, 3: 3840200, 4: 3961200, 5: 3961200, 6: 4085900, 7: 4085900, 8: 4214600, 9: 4214600, 10: 4347300, 11: 4347300, 12: 4484300, 13: 4484300, 14: 4625500, 15: 4625500, 16: 4771200, 17: 4771200, 18: 4921400, 19: 4921400, 20: 5076400, 21: 5076400, 22: 5236300, 23: 5236300, 24: 5401200, 25: 5401200, 26: 5571400, 27: 5571400, 28: 5746800, 29: 5746800, 30: 5927800, 31: 5927800, 32: 6114500 },
            'IV/e': { 0: 3880400, 1: 3880400, 2: 4002700, 3: 4002700, 4: 4128700, 5: 4128700, 6: 4258700, 7: 4258700, 8: 4392900, 9: 4392900, 10: 4531200, 11: 4531200, 12: 4673900, 13: 4673900, 14: 4821100, 15: 4821100, 16: 4973000, 17: 4973000, 18: 5129600, 19: 5129600, 20: 5291200, 21: 5291200, 22: 5457800, 23: 5457800, 24: 5629700, 25: 5629700, 26: 5807000, 27: 5807000, 28: 5989900, 29: 5989900, 30: 6178600, 31: 6178600, 32: 6373200 }
        };
        const MASTER_RANK={'I/a':'Juru Muda','I/b':'Juru Muda Tk.I','I/c':'Juru','I/d':'Juru Tk.I','II/a':'Pengatur Muda','II/b':'Pengatur Muda Tk.I','II/c':'Pengatur','II/d':'Pengatur Tk.I','III/a':'Penata Muda','III/b':'Penata Muda Tk.I','III/c':'Penata','III/d':'Penata Tk.I','IV/a':'Pembina','IV/b':'Pembina Tk.I','IV/c':'Pembina Utama Muda','IV/d':'Pembina Utama Madya','IV/e':'Pembina Utama'};
        const GOLONGAN = Object.keys(MASTER_RANK);

        // --- SUPABASE SETUP ---
        let supabaseConfig = {
            url: "https://cfnnibbzhbylykckhpiy.supabase.co",
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbm5pYmJ6aGJ5bHlrY2tocGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4OTAyMTAsImV4cCI6MjA4NjQ2NjIxMH0.Xuk9m85FQ8VrRjxyMeCxnx-3_8plOBVm9-Im9S41wPk"
        };
        let supabase = null;
        let isConfigured = false;

        try {
            supabase = createClient(supabaseConfig.url, supabaseConfig.key);
            isConfigured = true;
        } catch (e) {
            console.error("Supabase config error", e);
            isConfigured = false;
        }

        // --- STATE ---
        let employees=[], proposals=[], activityLog=[], appSettings={
            signerName: 'Nama Pejabat', signerNIP: '19000000', signerPosition: 'Kepala Dinas', signerGolongan: 'IV/a', 
            logoUrl: "https://kalselprov.go.id/wp-content/uploads/2020/09/Logo-Kalsel.png"
        }, currentUser=null, chartGolongan=null;

        // --- DATA LOADER ---
        window.loadData = async function() {
            if (!supabase) return;
            document.getElementById('app-loader').classList.remove('hidden');

            try {
                // 1. Load Settings & Salary
                const { data: setConfig } = await supabase.from('settings').select('*').eq('id', 'config').single();
                if (setConfig) {
                    appSettings.signerName = setConfig.signername || appSettings.signerName;
                    appSettings.signerNIP = setConfig.signernip || appSettings.signerNIP;
                    appSettings.signerPosition = setConfig.signerposition || appSettings.signerPosition;
                    appSettings.signerGolongan = setConfig.signergolongan || appSettings.signerGolongan;
                    appSettings.logoUrl = setConfig.logourl || appSettings.logoUrl;
                }
                
                const { data: salConfig } = await supabase.from('settings').select('*').eq('id', 'salary_std').single();
                if (salConfig && salConfig.ranges) GAJI_POKOK_2024 = salConfig.ranges;

                // 2. Load Employees
                const { data: emps, error: empErr } = await supabase.from('employees').select('*');
                if (empErr) throw empErr;
                employees = (emps || []).map(e => ({
                    ...e,
                    tgl_lahir: e.tgl_lahir ? new Date(e.tgl_lahir) : new Date(),
                    tmt_pangkat: e.tmt_pangkat ? new Date(e.tmt_pangkat) : new Date(),
                    tmt_berkala: e.tmt_berkala ? new Date(e.tmt_berkala) : new Date()
                }));

                // 3. Load Proposals
                const { data: props, error: propErr } = await supabase.from('proposals').select('*');
                if (propErr) throw propErr;
                proposals = (props || []).map(p => ({
                    ...p,
                    date: p.date ? new Date(p.date) : new Date(),
                    newtmt: p.newtmt ? new Date(p.newtmt) : new Date()
                }));

                // 4. Load Activity Logs
                const { data: logs, error: logErr } = await supabase.from('activity_logs').select('*').order('createdat', { ascending: false }).limit(20);
                if (logErr) throw logErr;
                activityLog = logs || [];

                // Re-render UI Elements
                if(!document.getElementById('view-salary').classList.contains('hidden')) window.renderSalaryTable();
                if(!document.getElementById('view-pegawai').classList.contains('hidden')) window.renderPegawai();
                if(!document.getElementById('view-usulan').classList.contains('hidden')) window.renderUsulan(document.getElementById('usulan-title').innerText.includes('Pangkat') ? 'PANGKAT' : 'KGB');
                if(!document.getElementById('view-verifikasi').classList.contains('hidden')) window.renderVerifikasi();
                if(!document.getElementById('view-settings').classList.contains('hidden')) window.loadSettingsUI();
                
                window.renderActivityLog();
                window.updateDashboard();

            } catch (err) {
                console.error("Failed fetching data:", err);
                if (err.message && err.message.includes("relation") && err.message.includes("does not exist")) {
                    alert("Tabel Database belum dibuat di Supabase!\n\nSilakan jalankan Script SQL berikut di menu SQL Editor Supabase Anda:\n\nCREATE TABLE employees ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, nama TEXT, nip TEXT, jabatan TEXT, jenis_jabatan TEXT, golongan TEXT, mk_tahun INTEGER, mk_bulan INTEGER, tgl_lahir DATE, tmt_pangkat DATE, tmt_berkala DATE, nilai_skp TEXT, hukuman_disiplin BOOLEAN, lastsync BIGINT, salaryregulation TEXT );\nCREATE TABLE proposals ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, empid UUID, empname TEXT, empnip TEXT, type TEXT, status TEXT, date TIMESTAMP, newtmt DATE, oldrank TEXT, newrank TEXT, newgaji BIGINT, newmktahun INTEGER, reduction INTEGER );\nCREATE TABLE activity_logs ( id UUID DEFAULT gen_random_uuid() PRIMARY KEY, text TEXT, type TEXT, time TEXT, createdat BIGINT );\nCREATE TABLE settings ( id TEXT PRIMARY KEY, signername TEXT, signernip TEXT, signerposition TEXT, signergolongan TEXT, logourl TEXT, regulation TEXT, effectivedate TEXT, ranges JSONB, updatedat BIGINT, updatedby TEXT );\nALTER TABLE employees DISABLE ROW LEVEL SECURITY;\nALTER TABLE proposals DISABLE ROW LEVEL SECURITY;\nALTER TABLE activity_logs DISABLE ROW LEVEL SECURITY;\nALTER TABLE settings DISABLE ROW LEVEL SECURITY;");
                } else {
                    alert("Gagal menarik data dari Supabase. Pastikan URL dan Key benar, serta tabel SQL sudah dibuat.");
                }
            } finally {
                document.getElementById('app-loader').classList.add('hidden');
            }
        };

        // --- AUTH ---
        window.performLogin = async function() {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            
            if(!supabase) return alert("Koneksi database belum diatur.");

            try {
                // Query ke tabel 'users' di Supabase
                const { data, error } = await supabase.from('users').select('*').eq('username', u).eq('password', p).single();
                
                if (error || !data) {
                    window.showToast("Username atau Password salah!", "error");
                    return;
                }

                currentUser = data; 
                sessionStorage.setItem('sikaji_session', JSON.stringify(data));
                
                document.getElementById('login-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=10b981&color=fff`;
                
                window.showToast(`Selamat datang, ${currentUser.name}!`); 
                window.nav('dashboard');

                // Load initial data
                await window.loadData();

            } catch (e) {
                console.error(e);
                window.showToast("Terjadi kesalahan saat login", "error");
            }
        };

        window.performLogout = function() { if(confirm("Keluar aplikasi?")) { sessionStorage.removeItem('sikaji_session'); currentUser=null; location.reload(); } };

        window.changePassword = async function() {
            const oldP = document.getElementById('set-pass-old').value;
            const newP = document.getElementById('set-pass-new').value;

            if (currentUser.password !== oldP) {
                return alert("Password lama salah!");
            }

            try {
                const { error } = await supabase.from('users').update({ password: newP }).eq('id', currentUser.id);
                if (error) throw error;
                
                currentUser.password = newP;
                sessionStorage.setItem('sikaji_session', JSON.stringify(currentUser));
                
                alert("Password berhasil diubah!");
                document.getElementById('set-pass-old').value = '';
                document.getElementById('set-pass-new').value = '';
            } catch(e) {
                alert("Gagal mengubah password: " + e.message);
            }
        };

        function checkSession() {
            if (!isConfigured) return;
            const session = sessionStorage.getItem('sikaji_session');
            if (session) {
                currentUser = JSON.parse(session);
                document.getElementById('login-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=10b981&color=fff`;
                window.nav('dashboard');
                window.loadData();
            } else {
                document.getElementById('login-interface').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        }

        // --- UTILS ---
        function fmtMoney(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n); }
        
        // Helper baru untuk format tanggal Indonesia Lengkap (dd MMMM yyyy)
        function fmtDate(d) {
            if (!d) return '-';
            const dateObj = new Date(d);
            if (isNaN(dateObj.getTime())) return '-';
            return dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function calcGaji(g, mk) { 
            const ranges = GAJI_POKOK_2024[g];
            if (!ranges) return 0;
            const keys = Object.keys(ranges).map(Number).sort((a,b)=>a-b);
            let closestMK = keys[0];
            for(let k of keys) { if(k <= mk) closestMK = k; else break; }
            return ranges[closestMK] || 0;
        }

        function nextRank(c) { const i=GOLONGAN.indexOf(c); return (i!==-1 && i<GOLONGAN.length-1) ? GOLONGAN[i+1] : c; }
        function getTenure(d) { return Math.floor(Math.abs(new Date()-d)/(1000*60*60*24*365.25)); }
        function getAge(d) { const n=new Date(); let a=n.getFullYear()-d.getFullYear(); if(n.getMonth()<d.getMonth()||(n.getMonth()===d.getMonth()&&n.getDate()<d.getDate())) a--; return a; }
        function getTmtPensiun(d) { let t=new Date(d); t.setFullYear(t.getFullYear()+58); t.setMonth(t.getMonth()+1); t.setDate(1); return t; }
        function getMonthDiff(d1, d2) { if(!(d1 instanceof Date)||!(d2 instanceof Date)) return 0; return ((d2.getFullYear()-d1.getFullYear())*12)-d1.getMonth()+d2.getMonth()+(d2.getDate()<d1.getDate()?-1:0); }
        function getReductionYears(o, n) { const mo=o.split('/')[0], mn=n.split('/')[0]; return (mo==='I'&&mn==='II')?6:(mo==='II'&&mn==='III')?5:(mo==='III'&&mn==='IV')?4:0; }
        
        window.showToast = function(m, t='success') { 
            const c=document.getElementById('toast-container'), d=document.createElement('div'); d.className=`${t==='success'?'bg-slate-800':'bg-red-600'} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up min-w-[300px] z-[100]`; d.innerHTML=`<i class="ph ${t==='success'?'ph-check-circle':'ph-warning-circle'} text-xl"></i><span class="font-medium text-sm">${m}</span>`; c.appendChild(d); setTimeout(() => { d.style.opacity='0'; setTimeout(()=>d.remove(),300); }, 3000); 
        };
        
        async function addActivity(text, type='info') {
            if(!supabase) return;
            try {
                await supabase.from('activity_logs').insert([{
                    text, type, time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}), createdat: Date.now()
                }]);
            } catch(e) { console.error("Log error", e); }
        }

        // --- SETUP LOGIC ---
        window.saveLocalConfig = async function() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if(!url || !key) return alert("Mohon lengkapi URL dan Key Supabase!");

            document.getElementById('loader-text').innerText = "Menguji Koneksi Supabase...";
            document.getElementById('app-loader').classList.remove('hidden');

            // Test Connection
            const tempSupabase = createClient(url, key);
            const { error } = await tempSupabase.from('employees').select('id').limit(1);

            document.getElementById('app-loader').classList.add('hidden');

            if (error && error.code === 'PGRST116') {
                alert("Koneksi berhasil, tetapi tabel belum dibuat!\n\nMohon jalankan script SQL yang disediakan di tab SQL Editor pada dashboard Supabase Anda terlebih dahulu.");
            } else if (error && error.message.includes('FetchError')) {
                alert("URL Supabase salah atau tidak dapat dijangkau.");
            } else {
                localStorage.setItem('sikaji_supabase_config', JSON.stringify({ url, key }));
                alert("Koneksi Supabase berhasil disimpan. Aplikasi akan dimuat ulang.");
                location.reload();
            }
        };

        window.copySQL = function() {
            const copyText = document.getElementById("sql-script");
            copyText.select();
            document.execCommand("copy");
            window.showToast("Script SQL disalin!");
        }

        window.resetAppConfig = function() {
            if(confirm("Hapus konfigurasi Supabase lokal?")) {
                localStorage.removeItem('sikaji_supabase_config');
                location.reload();
            }
        };

        // --- LOGIC ---
        function isEligibleKGB(e) {
            if(!e.tgl_lahir || new Date() >= getTmtPensiun(e.tgl_lahir)) return { eligible:false, msg:"Pensiun" };
            if(proposals.find(p => p.empid === e.id && p.status === 'MENUNGGU')) return { eligible:false, msg:"Proses" };
            if(e.hukuman_disiplin || e.nilai_skp === 'Kurang') return { eligible:false };
            const main = e.golongan.split('/')[0], isGanjil = (main==='I'||main==='II');
            let target = e.mk_tahun + 1; while (true) { if ((isGanjil && target%2!==0) || (!isGanjil && target%2===0)) break; target++; }
            const next = new Date(e.tmt_berkala); next.setFullYear(next.getFullYear() + (target - e.mk_tahun));
            const cut = new Date(); cut.setDate(cut.getDate()+90);
            return next <= cut ? { eligible:true, nextTMT:next, nextMKG:target } : { eligible:false };
        }
        function isEligibleKP(e) {
            if(!e.tgl_lahir || new Date() >= getTmtPensiun(e.tgl_lahir)) return { eligible:false };
            if(e.hukuman_disiplin || ['Cukup','Kurang'].includes(e.nilai_skp)) return { eligible:false };
            const next = new Date(e.tmt_pangkat); next.setFullYear(next.getFullYear()+4);
            const start = new Date(next); start.setMonth(start.getMonth()-3);
            if(new Date() >= start) {
                let tmt = new Date(new Date()<next ? next : new Date());
                if(new Date() >= next) { tmt.setMonth(tmt.getMonth()+1); tmt.setDate(1); } else tmt.setDate(1);
                return { eligible:true, nextTMT:tmt };
            }
            return { eligible:false };
        }

        // --- UI RENDERERS ---
        window.nav = function(page) {
            document.querySelectorAll('#content-area > div').forEach(e => { if(e.id.startsWith('view-')) e.classList.add('hidden'); });
            let target = 'view-' + (['usulan-pangkat','usulan-kgb'].includes(page) ? 'usulan' : page);
            document.getElementById(target).classList.remove('hidden');
            document.querySelectorAll('#sidebar button').forEach(b => b.classList.remove('sidebar-item-active'));
            const btn = document.getElementById('nav-' + page); if(btn) btn.classList.add('sidebar-item-active');
            if(page==='dashboard') window.updateDashboard();
            if(page==='pegawai') window.renderPegawai();
            if(page.includes('usulan')) window.renderUsulan(page === 'usulan-pangkat' ? 'PANGKAT' : 'KGB');
            if(page==='verifikasi') window.renderVerifikasi();
            if(page==='salary') window.renderSalaryTable();
            if(page==='pensiun') window.renderPensiun();
            if(page==='settings') window.loadSettingsUI();
            if(page==='simulation') { const s = document.getElementById('sim-golongan'); if(s.options.length===0) GOLONGAN.forEach(g => s.innerHTML+=`<option value="${g}">${g}</option>`); }
        };

        window.renderActivityLog = function() { 
            const c = document.getElementById('activity-log-container'); 
            if(c) c.innerHTML = activityLog.map(l => {
                // Format waktu log lebih detail
                const date = new Date(l.createdat || Date.now());
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                
                return `<div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all"><div class="w-2 h-2 rounded-full mt-2 shrink-0 ${l.type==='success'?'bg-emerald-500':l.type==='warning'?'bg-amber-500':'bg-blue-500'}"></div><div><p class="text-xs font-bold text-slate-800">${l.text}</p><p class="text-[10px] text-slate-400 font-mono">${dateStr}, ${timeStr}</p></div></div>`;
            }).join(''); 
        }
        
        window.renderSalaryTable = function() { const t = document.getElementById('table-salary-body'); if(t) t.innerHTML = Object.keys(GAJI_POKOK_2024).map(g => { const rangeData = GAJI_POKOK_2024[g]; const mkgs = Object.keys(rangeData).map(Number).sort((a,b)=>a-b); const min = rangeData[mkgs[0]]; const max = rangeData[mkgs[mkgs.length-1]]; const maxMKG = mkgs[mkgs.length-1]; return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 pl-6 font-bold text-slate-800">${g}</td><td class="p-4 text-slate-600">${MASTER_RANK[g]}</td><td class="p-4 text-center font-mono text-emerald-600">${fmtMoney(min)}</td><td class="p-4 text-center text-slate-500">${maxMKG} Tahun</td><td class="p-4 text-right pr-6 font-mono text-slate-800 font-bold">${fmtMoney(max)}</td></tr>`; }).join(''); }
        
        window.renderPensiun = function() {
            const g = document.getElementById('pensiun-grid'); if(!g) return;
            const near = employees.filter(e => getAge(e.tgl_lahir) >= 56);
            g.innerHTML = near.length ? near.map(e => `<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500 flex justify-between items-center"><div><h4 class="font-bold text-slate-800">${e.nama}</h4><p class="text-xs text-slate-500 font-mono mb-2">${e.nip}</p><div class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded inline-block">${getAge(e.tgl_lahir)} Tahun</div></div><div class="text-right"><div class="text-[10px] text-slate-400 uppercase font-bold">TMT Pensiun</div><div class="font-bold text-slate-700">${fmtDate(getTmtPensiun(e.tgl_lahir))}</div></div></div>`).join('') : `<div class="col-span-3 text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">Tidak ada pegawai yang mendekati masa pensiun (< 2 Tahun).</div>`;
            document.getElementById('table-pensiun-body').innerHTML = employees.sort((a,b) => a.tgl_lahir - b.tgl_lahir).map(e => `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 font-bold text-slate-700 text-sm">${e.nama}</td><td class="p-4 text-sm">${fmtDate(e.tgl_lahir)}</td><td class="p-4 text-center font-bold text-sm">${getAge(e.tgl_lahir)}</td><td class="p-4 text-center text-sm text-slate-500">${58 - getAge(e.tgl_lahir)} Thn</td><td class="p-4 text-sm font-medium text-slate-800">${fmtDate(getTmtPensiun(e.tgl_lahir))}</td></tr>`).join('');
        }
        
        window.renderPegawai = function() {
            const s = document.getElementById('search-pegawai').value.toLowerCase();
            const f = employees.filter(e => e.nama.toLowerCase().includes(s) || e.nip.includes(s));
            document.getElementById('pegawai-count').innerText = `Menampilkan ${f.length} pegawai`;
            document.getElementById('table-pegawai-body').innerHTML = f.map(e => `<tr class="hover:bg-slate-50 border-b border-slate-100 group"><td class="p-4 pl-6 font-bold text-sm text-slate-700">${e.nama}<br><span class="font-normal text-xs text-slate-500 font-mono">${e.nip}</span></td><td class="p-4 text-sm text-slate-600">${e.jabatan}<div class="mt-1"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded border border-slate-200">${e.golongan}</span></div></td><td class="p-4 text-xs text-slate-500"><div class="flex items-center gap-1 mb-1" title="TMT Pangkat"><i class="ph ph-medal text-emerald-500"></i> ${fmtDate(e.tmt_pangkat)}</div><div class="flex items-center gap-1" title="TMT Berkala"><i class="ph ph-money text-teal-500"></i> ${fmtDate(e.tmt_berkala)}</div></td><td class="p-4 text-center text-xs font-bold text-slate-700 bg-slate-50/50 rounded-lg mx-2">${e.mk_tahun} Thn ${e.mk_bulan} Bln</td><td class="p-4 text-right font-mono text-sm font-bold text-emerald-700">${fmtMoney(calcGaji(e.golongan, e.mk_tahun))}</td><td class="p-4 text-center"><div class="flex items-center justify-center gap-1"><button onclick="window.openAddEmployeeModal('${e.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-all" title="Edit"><i class="ph ph-pencil-simple text-lg"></i></button><button onclick="window.deleteEmployee('${e.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all" title="Hapus"><i class="ph ph-trash text-lg"></i></button></div></td></tr>`).join('');
        }
        
        window.renderUsulan = function(type) {
            const t = document.getElementById('table-usulan-body');
            document.getElementById('usulan-title').innerText = type === 'PANGKAT' ? 'Kenaikan Pangkat' : 'Kenaikan Gaji Berkala';
            const eligible = employees.filter(e => type === 'PANGKAT' ? isEligibleKP(e).eligible : isEligibleKGB(e).eligible);
            document.getElementById('usulan-count').innerText = eligible.length;
            if (eligible.length === 0) { t.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-slate-400 italic bg-slate-50/50">Tidak ada pegawai yang memenuhi syarat.</td></tr>`; return; }
            t.innerHTML = eligible.map(e => {
                const r = type === 'PANGKAT' ? isEligibleKP(e) : isEligibleKGB(e);
                const has = proposals.find(p => p.empid === e.id && p.status === 'MENUNGGU');
                const oldG = calcGaji(e.golongan, e.mk_tahun);
                let nR, nMK, nG, det;
                if (type === 'PANGKAT') { nR = nextRank(e.golongan); const red = getReductionYears(e.golongan, nR); const md = getMonthDiff(e.tmt_pangkat, r.nextTMT); const ty = Math.floor(((e.mk_tahun*12)+e.mk_bulan+md)/12); nMK = Math.max(0, ty - red); nG = calcGaji(nR, nMK); det = `<div class="font-bold text-slate-700 text-xs">${e.golongan} <i class="ph ph-arrow-right text-blue-500"></i> ${nR}</div><div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${nMK} Thn <span class="text-red-500">(-${red} Thn)</span></div><div class="text-[10px] mt-0.5">Gaji: ${fmtMoney(oldG)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(nG)}</span></div>`; }
                else { nR = e.golongan; nMK = r.nextMKG; nG = calcGaji(nR, nMK); det = `<div class="font-bold text-slate-700 text-xs">Berkala</div><div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${nMK} Thn</div><div class="text-[10px] mt-0.5">Gaji: ${fmtMoney(oldG)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(nG)}</span></div>`; }
                return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-5 font-bold text-sm text-slate-700">${e.nama}<br><span class="font-normal text-xs text-slate-500">${e.nip}</span></td><td class="p-5">${det}<div class="text-[10px] text-slate-400 mt-1 font-mono bg-slate-100 inline-block px-1 rounded">TMT: ${fmtDate(r.nextTMT)}</div></td><td class="p-5 text-center"><span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold border border-emerald-200">ELIGIBLE</span></td><td class="p-5 text-right">${has ? '<span class="text-xs italic text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded">Menunggu</span>' : `<button onclick="window.createProposal('${e.id}', '${type}')" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition-all flex items-center gap-2 ml-auto"><i class="ph ph-paper-plane-right"></i> Proses</button>`}</td></tr>`;
            }).join('');
        }
        
        window.renderVerifikasi = function() {
            const t = document.getElementById('table-verifikasi-body');
            const l = proposals.sort((a,b) => { if(a.status==='MENUNGGU' && b.status!=='MENUNGGU') return -1; if(a.status!=='MENUNGGU' && b.status==='MENUNGGU') return 1; return new Date(b.date)-new Date(a.date); });
            if (l.length === 0) { t.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic bg-slate-50/50">Belum ada riwayat usulan.</td></tr>`; return; }
            t.innerHTML = l.map(p => {
                let bc = 'bg-slate-100 text-slate-700';
                if(p.status === 'MENUNGGU') bc = 'bg-amber-100 text-amber-700 border border-amber-200';
                else if(p.status === 'DISETUJUI') bc = 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                else if(p.status === 'DITOLAK') bc = 'bg-red-100 text-red-700 border border-red-200';
                return `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 text-xs font-mono">${fmtDate(p.date)}</td><td class="p-4 text-xs font-bold">${p.type}</td><td class="p-4 text-sm font-bold text-slate-700">${p.empname}</td><td class="p-4 text-xs text-slate-500">${p.type==='KGB'?`MKG ${p.newmktahun} Thn`:`${p.newrank} (-${p.reduction} Thn)`}</td><td class="p-4 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${bc}">${p.status}</span></td><td class="p-4 text-right">${p.status==='MENUNGGU' ? `<div class="flex justify-end gap-1"><button onclick="window.approveProposal('${p.id}')" class="text-emerald-600 hover:bg-emerald-50 p-2 rounded transition-colors" title="Setujui"><i class="ph ph-check-circle text-xl"></i></button><button onclick="window.rejectProposal('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors" title="Tolak"><i class="ph ph-x-circle text-xl"></i></button></div>` : `<i class="ph ${p.status==='DISETUJUI'?'ph-check-circle text-emerald-500':'ph-x-circle text-red-300'} text-xl"></i>`}</td></tr>`;
            }).join('');
        }

        // --- HANDLERS SUPABASE ---
        window.createProposal = async function(id, type) {
            if(!supabase) return alert("Koneksi terputus.");
            const e = employees.find(x => x.id === id);
            const rule = type === 'PANGKAT' ? isEligibleKP(e) : isEligibleKGB(e);
            let nR = e.golongan, nMK = rule.nextMKG, red = 0;
            if (type === 'PANGKAT') { nR = nextRank(e.golongan); red = getReductionYears(e.golongan, nR); const md = getMonthDiff(e.tmt_pangkat, rule.nextTMT); const ty = Math.floor(((e.mk_tahun*12)+e.mk_bulan+md)/12); nMK = Math.max(0, ty - red); nG = calcGaji(nR, nMK); det = `<div class="font-bold text-slate-700 text-xs">${e.golongan} <i class="ph ph-arrow-right text-blue-500"></i> ${nR}</div><div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${nMK} Thn <span class="text-red-500">(-${red} Thn)</span></div><div class="text-[10px] mt-0.5">Gaji: ${fmtMoney(oldG)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(nG)}</span></div>`; }
            else { nR = e.golongan; nMK = r.nextMKG; nG = calcGaji(nR, nMK); det = `<div class="font-bold text-slate-700 text-xs">Berkala</div><div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${nMK} Thn</div><div class="text-[10px] mt-0.5">Gaji: ${fmtMoney(oldG)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(nG)}</span></div>`; }
            
            try {
                const { error } = await supabase.from('proposals').insert([{
                    empid: e.id, empname: e.nama, empnip: e.nip, type: type, status: 'MENUNGGU', date: new Date().toISOString(), 
                    newtmt: rule.nextTMT.toISOString(), oldrank: e.golongan, newrank: nR, newgaji: calcGaji(nR, nMK), 
                    newmktahun: nMK, reduction: red
                }]);
                if (error) throw error;
                
                await addActivity(`Usulan ${type} ${e.nama}`, 'info'); 
                window.showToast("Usulan dibuat (Supabase)"); 
                await window.loadData();
            } catch(error) { console.error(error); alert("Gagal menyimpan usulan: " + error.message); }
        };

        window.approveProposal = async function(pid) {
            if(!supabase) return alert("Koneksi terputus.");
            const p = proposals.find(x => x.id === pid);
            if(p && p.status === 'MENUNGGU') {
                if(!confirm(`Setujui ${p.type} ${p.empname}? Data akan diupdate.`)) return;
                try {
                    // Update Proposal
                    await supabase.from('proposals').update({ status: 'DISETUJUI' }).eq('id', pid);

                    // Update Employee
                    const updates = { mk_tahun: p.newmktahun, mk_bulan: 0, tmt_berkala: p.newtmt.toISOString() };
                    if(p.type === 'PANGKAT') { updates.golongan = p.newrank; updates.tmt_pangkat = p.newtmt.toISOString(); }
                    await supabase.from('employees').update(updates).eq('id', p.empid);
                    
                    await addActivity(`Usulan ${p.type} ${p.empname} disetujui.`, 'success'); 
                    window.showToast("Disetujui");
                    await window.loadData();
                } catch(error) { console.error(error); alert("Gagal menyetujui: " + error.message); }
            }
        };

        window.rejectProposal = async function(pid) {
            if(!supabase) return alert("Koneksi terputus.");
            const p = proposals.find(x => x.id === pid);
            if(p && p.status === 'MENUNGGU') { 
                if(!confirm("Tolak usulan?")) return; 
                try {
                    await supabase.from('proposals').update({ status: 'DITOLAK' }).eq('id', pid);
                    await addActivity(`Usulan ${p.type} ${p.empname} ditolak.`, 'warning'); 
                    window.showToast("Ditolak", "warning"); 
                    await window.loadData();
                } catch(error) { console.error(error); alert("Gagal menolak: " + error.message); }
            }
        };

        window.deleteEmployee = async function(id) {
            if(!supabase) return alert("Koneksi terputus.");
            if(confirm("Hapus data pegawai ini? (Permanen)")) { 
                try {
                    const { error } = await supabase.from('employees').delete().eq('id', id);
                    if (error) throw error;
                    window.showToast("Dihapus", "warning"); 
                    await window.loadData();
                } catch(error) { console.error(error); alert("Gagal menghapus: " + error.message); }
            }
        };

        // --- SYSTEM UPDATE FUNCTIONS ---
        window.wipeDatabase = async function() {
            if(!supabase) return alert("Koneksi terputus.");
            if(prompt("PERINGATAN BAHAYA!\n\nKetik 'RESET' (huruf besar) untuk menghapus SEMUA data tabel dari Supabase Database.") !== 'RESET') {
                return;
            }

            const loader = document.getElementById('app-loader');
            loader.classList.remove('hidden');
            loader.querySelector('p').innerText = "Membersihkan Tabel...";

            try {
                // To delete all without condition in Supabase, we can use neq ID with a dummy value, or truncate from SQL editor.
                // Doing it via JS by fetching all IDs and deleting.
                await supabase.from('employees').delete().neq('nama', 'null');
                await supabase.from('proposals').delete().neq('type', 'null');
                await supabase.from('activity_logs').delete().neq('type', 'null');
                
                window.showToast("Tabel berhasil dikosongkan!", "success");
                await window.loadData();
            } catch (e) {
                console.error(e);
                alert("Gagal mengosongkan: " + e.message);
            } finally {
                loader.classList.add('hidden');
            }
        };

        window.updateSalaryReference = async function() {
            if (!supabase) return alert("Harap setup Supabase terlebih dahulu.");
            if (!confirm("Terapkan standar gaji Perpres No. 10 Tahun 2024 ke Supabase?")) return;

            try {
                const payload = {
                    id: 'salary_std',
                    regulation: "Perpres No. 10 Tahun 2024",
                    effectivedate: "2024-01-01",
                    ranges: GAJI_POKOK_2024,
                    updatedat: Date.now()
                };
                
                const { error } = await supabase.from('settings').upsert([payload]);
                if (error) throw error;

                await addActivity("Update Referensi Gaji (Perpres 10/2024)", "success");
                window.showToast("Referensi Gaji Berhasil Diupdate!");
                await window.loadData();
            } catch (e) {
                console.error(e);
                alert("Gagal update referensi: " + e.message);
            }
        };

        window.syncEmployeeData = async function() {
            if (!supabase) return;
            window.showToast("Memulai sinkronisasi...");
            await window.loadData();
            window.showToast("Tabel tersinkronisasi!", "success");
        };

        window.openAddEmployeeModal = function(id = null) {
            const m = document.getElementById('modal-add-employee'); m.classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('modal-content').classList.add('scale-100');
            const s = document.getElementById('input-golongan'); if(s.options.length===0) GOLONGAN.forEach(g => s.innerHTML+=`<option value="${g}">${g}</option>`);
            if(id) {
                const e = employees.find(x => x.id === id); document.getElementById('modal-title').innerText = "Edit Pegawai";
                document.getElementById('input-id').value = e.id; document.getElementById('input-nama').value = e.nama; document.getElementById('input-nip').value = e.nip; document.getElementById('input-lahir').value = e.tgl_lahir.toISOString().split('T')[0]; document.getElementById('input-jabatan').value = e.jabatan; document.getElementById('input-jenis-jabatan').value = e.jenis_jabatan; document.getElementById('input-golongan').value = e.golongan; document.getElementById('input-mk-tahun').value = e.mk_tahun; document.getElementById('input-mk-bulan').value = e.mk_bulan; document.getElementById('input-tmt-pangkat').value = e.tmt_pangkat.toISOString().split('T')[0]; document.getElementById('input-tmt-berkala').value = e.tmt_berkala.toISOString().split('T')[0]; document.getElementById('input-skp').value = e.nilai_skp; document.getElementById('input-hukuman').value = e.hukuman_disiplin.toString();
            } else { document.getElementById('modal-title').innerText = "Tambah Pegawai"; document.getElementById('form-add-employee').reset(); document.getElementById('input-id').value = ""; }
            window.previewGajiForm();
        };

        window.closeAddEmployeeModal = function() { const m = document.getElementById('modal-add-employee'); m.classList.add('opacity-0', 'pointer-events-none'); document.getElementById('modal-content').classList.remove('scale-100'); };

        window.saveNewEmployee = async function() {
            if(!supabase) return alert("Koneksi ke database terputus.");
            const id = document.getElementById('input-id').value;
            const nama = document.getElementById('input-nama').value;
            const nip = document.getElementById('input-nip').value;
            const lahirStr = document.getElementById('input-lahir').value;
            const tmtPangkatStr = document.getElementById('input-tmt-pangkat').value;
            const tmtBerkalaStr = document.getElementById('input-tmt-berkala').value;

            if(!nama || !nip || !lahirStr || !tmtPangkatStr || !tmtBerkalaStr) {
                return alert("Mohon lengkapi data Identitas dan Tanggal!");
            }

            const data = { 
                nama: nama, 
                nip: nip, 
                jabatan: document.getElementById('input-jabatan').value, 
                jenis_jabatan: document.getElementById('input-jenis-jabatan').value, 
                golongan: document.getElementById('input-golongan').value, 
                mk_tahun: parseInt(document.getElementById('input-mk-tahun').value)||0, 
                mk_bulan: parseInt(document.getElementById('input-mk-bulan').value)||0, 
                tgl_lahir: new Date(lahirStr).toISOString(), 
                tmt_pangkat: new Date(tmtPangkatStr).toISOString(), 
                tmt_berkala: new Date(tmtBerkalaStr).toISOString(), 
                nilai_skp: document.getElementById('input-skp').value, 
                hukuman_disiplin: document.getElementById('input-hukuman').value === 'true' 
            };
            
            try {
                if(id) { 
                    const { error } = await supabase.from('employees').update(data).eq('id', id);
                    if(error) throw error;
                } else { 
                    const { error } = await supabase.from('employees').insert([data]);
                    if(error) throw error;
                }
                window.closeAddEmployeeModal(); 
                window.showToast("Disimpan ke Supabase");
                await window.loadData();
            } catch(e) { 
                console.error(e); 
                alert("Gagal menyimpan: " + e.message); 
            }
        };

        window.previewGajiForm = function() { const g = document.getElementById('input-golongan').value; const m = parseInt(document.getElementById('input-mk-tahun').value)||0; document.getElementById('form-salary-preview').innerText = fmtMoney(calcGaji(g, m)); };
        
        window.updateDashboard = function() {
            const active = employees.filter(e => new Date() < getTmtPensiun(e.tgl_lahir));
            document.getElementById('stat-total').innerText = active.length;
            const elP = employees.filter(e => isEligibleKP(e).eligible).length; const elK = employees.filter(e => isEligibleKGB(e).eligible).length; const pend = proposals.filter(p => p.status === 'MENUNGGU').length;
            document.getElementById('stat-pangkat').innerText = elP; document.getElementById('stat-kgb').innerText = elK; document.getElementById('hero-pending-count').innerText = pend;
            const bp = document.getElementById('badge-pangkat'); if(bp) { bp.innerText = elP; bp.classList.toggle('hidden', elP === 0); }
            const bk = document.getElementById('badge-kgb'); if(bk) { bk.innerText = elK; bk.classList.toggle('hidden', elK === 0); }
            const bv = document.getElementById('badge-verif'); if(bv) { bv.innerText = pend; bv.classList.toggle('hidden', pend === 0); }
            if(chartGolongan) chartGolongan.destroy(); const gData = {}; active.forEach(e => { const k = e.golongan.split('/')[0]; gData[k] = (gData[k]||0)+1; });
            const ctx = document.getElementById('chart-golongan').getContext('2d'); chartGolongan = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(gData), datasets: [{ label: 'Pegawai', data: Object.values(gData), backgroundColor: '#10b981', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
        };

        window.runSimulation = function() {
            const currentGol = document.getElementById('sim-golongan').value;
            let mkTahun = parseInt(document.getElementById('sim-mk-tahun').value) || 0;
            const tmtPangkatStr = document.getElementById('sim-tmt-pangkat').value;
            const tmtBerkalaStr = document.getElementById('sim-tmt-berkala').value;
            if(!tmtPangkatStr || !tmtBerkalaStr) { alert("Mohon lengkapi TMT!"); return; }
            const timeline = document.getElementById('sim-timeline'); timeline.innerHTML = '';
            let simDate = new Date(); let currentRank = currentGol;
            let lastTMTPangkat = new Date(tmtPangkatStr); let lastTMTBerkala = new Date(tmtBerkalaStr);
            const events = []; const endDate = new Date(); endDate.setFullYear(endDate.getFullYear() + 10);
            while(simDate < endDate) {
                const mainGol = currentRank.split('/')[0]; const isGanjil = (mainGol === 'I' || mainGol === 'II');
                let targetMKG = mkTahun + 1; while((isGanjil && targetMKG % 2 === 0) || (!isGanjil && targetMKG % 2 !== 0)) { targetMKG++; }
                const yearsNeeded = targetMKG - mkTahun;
                const nextKGBDate = new Date(lastTMTBerkala); nextKGBDate.setFullYear(nextKGBDate.getFullYear() + yearsNeeded);
                const nextKPDate = new Date(lastTMTPangkat); nextKPDate.setFullYear(nextKPDate.getFullYear() + 4); nextKPDate.setDate(1); 
                if (nextKGBDate < nextKPDate) {
                    if (nextKGBDate > simDate) {
                        mkTahun = targetMKG; const currentSalary = calcGaji(currentRank, mkTahun);
                        lastTMTBerkala = new Date(nextKGBDate); simDate = new Date(nextKGBDate);
                        events.push({ date: new Date(nextKGBDate), type: 'KGB', desc: `Kenaikan Berkala (${mkTahun} Thn)`, detail: fmtMoney(currentSalary) });
                    } else { simDate.setMonth(simDate.getMonth() + 1); }
                } else {
                    if (nextKPDate > simDate) {
                        const nextR = nextRank(currentRank);
                        if(nextR !== currentRank) { 
                            const reduction = getReductionYears(currentRank, nextR); mkTahun = Math.max(0, mkTahun - reduction);
                            currentRank = nextR; const currentSalary = calcGaji(currentRank, mkTahun);
                            lastTMTPangkat = new Date(nextKPDate); lastTMTBerkala = new Date(nextKPDate); simDate = new Date(nextKPDate);
                            events.push({ date: new Date(nextKPDate), type: 'KP', desc: `Naik Pangkat ke ${currentRank}`, detail: `Potong ${reduction} Thn. Gaji: ${fmtMoney(currentSalary)}` });
                        } else { simDate.setFullYear(simDate.getFullYear() + 1); }
                    } else { simDate.setMonth(simDate.getMonth() + 1); }
                }
            }
            if(events.length === 0) { timeline.innerHTML = `<div class="p-4 text-center text-slate-500">Tidak ada kenaikan dalam 10 tahun.</div>`; } else { timeline.innerHTML = events.map(ev => `<div class="flex gap-4 items-start relative"><div class="w-12 text-right text-xs font-bold text-slate-400 pt-1">${ev.date.getFullYear()}</div><div class="relative flex-1 bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all"><div class="absolute -left-6 top-2 w-3 h-3 rounded-full ${ev.type==='KP'?'bg-emerald-500':'bg-teal-500'} border-2 border-white shadow"></div><div class="flex justify-between items-start"><div><h5 class="font-bold text-slate-800 text-sm">${ev.type}</h5><p class="text-xs text-slate-500">${fmtDate(ev.date)}</p></div></div><div class="mt-2 text-xs text-slate-600 font-medium border-t border-slate-50 pt-2">${ev.desc}<br><span class="text-slate-400">${ev.detail}</span></div></div></div>`).join(''); }
        };

        window.exportDataJSON = function() { const data = { employees, proposals, appSettings, activityLog }; const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data)); a.download = 'backup_sikaji_supabase.json'; a.click(); };
        window.importDataJSON = function(input) { 
            alert("Fitur Restore via JSON dinonaktifkan di mode cloud. Harap import melalui dashboard Supabase Anda.");
            input.value = ''; 
        };
        
        window.loadSettingsUI = function() {
            document.getElementById('set-nama').value = appSettings.signerName || '';
            document.getElementById('set-nip').value = appSettings.signerNIP || '';
            document.getElementById('set-jabatan').value = appSettings.signerPosition || '';
            const sel = document.getElementById('set-golongan');
            if(sel.options.length === 0) GOLONGAN.forEach(g => sel.innerHTML += `<option value="${g}">${g} - ${MASTER_RANK[g]}</option>`);
            sel.value = appSettings.signerGolongan || 'IV/a';
            if(appSettings.logoUrl) document.getElementById('settings-logo-preview').src = appSettings.logoUrl;
            document.getElementById('settings-current-user').innerText = currentUser ? currentUser.username : 'GUEST';
            window.updateQRPreview();
        };
        
        window.saveSettings = async function() { 
            if(!supabase) return alert("Koneksi terputus.");
            const newData = {
                id: 'config',
                signername: document.getElementById('set-nama').value,
                signernip: document.getElementById('set-nip').value,
                signerposition: document.getElementById('set-jabatan').value,
                signergolongan: document.getElementById('set-golongan').value,
                logourl: appSettings.logoUrl,
                updatedat: Date.now()
            };
            try {
                const { error } = await supabase.from('settings').upsert([newData]);
                if (error) throw error;
                window.showToast("Pengaturan Disimpan (Supabase)"); 
                await window.loadData();
            } catch(error) { console.error(error); alert("Gagal menyimpan pengaturan: " + error.message); }
        };
        
        window.updateQRPreview = function() { const d = `TTE|${document.getElementById('set-nip').value}|${document.getElementById('set-nama').value}`; document.getElementById('set-qr-preview').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(d)}`; };
        window.uploadLogo = function(e) { const f = e.target.files[0]; if(f && f.size < 500*1024) { const r = new FileReader(); r.onload = function(evt) { appSettings.logoUrl = evt.target.result; document.getElementById('settings-logo-preview').src = evt.target.result; }; r.readAsDataURL(f); } else alert("File terlalu besar (Maks 500KB untuk Cloud)"); };
        window.resetLogo = function() { 
            appSettings.logoUrl = "https://kalselprov.go.id/wp-content/uploads/2020/09/Logo-Kalsel.png"; 
            document.getElementById('settings-logo-preview').src = appSettings.logoUrl; 
        };
        
        window.filterUsulanTable = function() { const v = document.getElementById('search-usulan').value.toLowerCase(); document.querySelectorAll('#table-usulan-body tr').forEach(r => { r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'; }); };
        
        window.printGeneralReport = function(type) {
            const win = window.open('','_blank'); let rows = ''; let title = ''; let headers = ''; const logo = appSettings.logoUrl;
            const reportId = `LAP-${type}-${Date.now()}`; const qrData = `SIKAJI-VALID|${reportId}|${appSettings.signerNIP}`; const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(qrData)}`;
            
            const rankName = MASTER_RANK[appSettings.signerGolongan] || '';
            const todayDate = fmtDate(new Date());

            if (type === 'ALL') { title = 'DAFTAR NOMINATIF PEGAWAI'; headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Nama / NIP</th><th style="border:1px solid #000; padding:8px">Jabatan</th><th style="border:1px solid #000; padding:8px">Golongan</th><th style="border:1px solid #000; padding:8px">MKG</th>`; rows = employees.map((e, i) => `<tr><td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td><td style="border:1px solid #000; padding:5px"><b>${e.nama}</b><br>${e.nip}</td><td style="border:1px solid #000; padding:5px">${e.jabatan}</td><td style="border:1px solid #000; padding:5px; text-align:center">${e.golongan}</td><td style="border:1px solid #000; padding:5px; text-align:center">${e.mk_tahun} Thn ${e.mk_bulan} Bln</td></tr>`).join(''); } 
            else { title = type === 'APPROVED' ? 'LAPORAN REALISASI SK (DISETUJUI)' : 'DAFTAR ANTRIAN VERIFIKASI'; headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Pegawai</th><th style="border:1px solid #000; padding:8px">Jenis Usulan</th><th style="border:1px solid #000; padding:8px">Detail Perubahan</th><th style="border:1px solid #000; padding:8px">TMT</th>`; const fs = type === 'APPROVED' ? 'DISETUJUI' : 'MENUNGGU'; rows = proposals.filter(p => p.status === fs).map((p, i) => `<tr><td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td><td style="border:1px solid #000; padding:5px"><b>${p.empname}</b><br>${p.empnip}</td><td style="border:1px solid #000; padding:5px; text-align:center">${p.type}</td><td style="border:1px solid #000; padding:5px">${p.type === 'KGB' ? `Gaji: ${fmtMoney(p.newgaji)}` : `Pangkat: ${p.newrank}`}</td><td style="border:1px solid #000; padding:5px; text-align:center">${fmtDate(p.newtmt)}</td></tr>`).join(''); }
            
            win.document.write(`<html><head><title>Laporan</title><style>@page { size: A4; margin: 2cm; } body { font-family: 'Times New Roman', serif; width: 100%; margin: 0; } .kop-surat { width: 100%; border-bottom: 3px double black; margin-bottom: 25px; padding-bottom: 10px; } .kop-logo-container { width: 100px; text-align: center; vertical-align: middle; } .kop-logo { height: 95px; width: auto; object-fit: contain; } .kop-text-container { text-align: center; vertical-align: middle; padding-left: 10px; padding-right: 10px; } .kop-row-1 { font-size: 13pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-row-2 { font-size: 15pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-row-3 { font-size: 17pt; font-weight: bold; margin: 0; line-height: 1.2; } .kop-address { font-size: 9pt; margin: 2px 0 0 0; line-height: 1.3; }</style></head><body><table class="kop-surat"><tr><td class="kop-logo-container"><img src="${logo}" class="kop-logo"></td><td class="kop-text-container"><h3 class="kop-row-1">PEMERINTAH PROVINSI KALIMANTAN SELATAN</h3><h2 class="kop-row-2">DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</h2><h2 class="kop-row-3">LABORATORIUM BAHAN KONSTRUKSI</h2><p class="kop-address">Jl. Yos Sudarso No. 35 Kel. Telaga Biru Kec. Banjarmasin Barat Kota Banjarmasin RT. 34 RW. 02</p><p class="kop-address">Telpon : (0511) 4423377 | Fax : (0511) 4423377 | Email : laboratoriumpuprov.kalsel@yahoo.com</p></td></tr></table><h1 style="text-align:center; font-size:14pt; font-weight:bold; text-decoration:underline; margin-bottom:20px; text-transform:uppercase">${title}</h1><table style="width:100%; border-collapse:collapse; font-size:11pt"><thead><tr style="background-color:#f3f4f6; text-align:center">${headers}</tr></thead><tbody>${rows || '<tr><td colspan="5" style="text-align:center; padding:10px; font-style:italic; border:1px solid #000">Tidak ada data.</td></tr>'}</tbody></table>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:50px">
                <div style="text-align:center">
                    <img src="${qrUrl}" style="width:90px; height:90px; margin-bottom:10px; border:1px solid #ddd; padding:5px">
                    <p style="font-size:9pt; color:#666; margin:0">Dokumen valid & terverifikasi<br>sistem SIKAJI ASN.</p>
                </div>
                <div style="text-align:center; width:350px">
                    <p style="margin-bottom:70px; font-size:12pt">Banjarmasin, ${todayDate}<br><strong>${appSettings.signerPosition}</strong></p>
                    <p style="font-weight:bold; text-decoration:underline; margin:0; font-size:12pt">${appSettings.signerName}</p>
                    <p style="margin:0; font-size:12pt">${rankName}</p>
                    <p style="margin:0; font-size:12pt">NIP. ${appSettings.signerNIP}</p>
                </div>
            </div>
            <script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script></body></html>`);
            win.document.close();
        }

        // --- INIT ---
        window.onload = async function() {
            if (!isConfigured) {
                document.getElementById('setup-interface').classList.remove('hidden');
                return;
            }

            checkSession();

            // Load data for the first time
            if (supabase) {
                await window.loadData();
            }
            
            setInterval(() => { const d = document.getElementById('clock'); if(d) d.innerText = new Date().toLocaleTimeString(); }, 1000);
        };
    </script>
</body>
</html>
