<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIKAJI ASN - Supabase Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- SUPABASE JS CLIENT -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                extend: {
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f3f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .gradient-primary { background: linear-gradient(135deg, #15803d 0%, #0f172a 100%); } /* Green-ish for Supabase vibe */
        .gradient-card-1 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .gradient-card-2 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-card-3 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .gradient-card-4 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .sidebar-item-active { background-color: rgba(255, 255, 255, 0.1); border-left: 3px solid #f59e0b; }
        #loading-overlay { display: flex; }
        #loading-overlay.hidden { display: none; }
    </style>
</head>
<body class="text-slate-800 antialiased overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center flex-col text-white">
        <i class="ph ph-spinner animate-spin text-4xl mb-4 text-emerald-400"></i>
        <p class="font-bold text-lg">Menghubungkan ke Supabase...</p>
        <p class="text-xs text-slate-400 mt-2">Sinkronisasi Data Realtime</p>
    </div>

    <!-- VIEW: LOGIN INTERFACE -->
    <div id="login-interface" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-200 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-green-600"></div>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-emerald-400 to-green-600 rounded-2xl flex items-center justify-center text-slate-900 font-bold text-3xl shadow-lg mx-auto mb-4">S</div>
                <h1 class="text-2xl font-bold text-slate-800">SIKAJI ASN</h1>
                <p class="text-xs text-slate-500 uppercase tracking-widest mt-1">Supabase Edition</p>
            </div>
            <form onsubmit="event.preventDefault(); window.performLogin();" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input type="text" id="login-username" class="w-full pl-4 pr-4 py-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="admin" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full pl-4 pr-4 py-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="admin123" required>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                    <i class="ph ph-sign-in text-lg"></i> Masuk Aplikasi
                </button>
            </form>
        </div>
        <div class="absolute bottom-6 text-slate-400 text-xs font-medium">&copy; 2025 Laboratorium Bahan Konstruksi</div>
    </div>

    <!-- VIEW: APP INTERFACE -->
    <div id="app-interface" class="hidden flex h-screen w-full">
        <aside class="w-64 gradient-primary text-white flex flex-col shrink-0 shadow-2xl z-30 transition-all duration-300" id="sidebar">
            <div class="p-6 flex items-center gap-3 border-b border-slate-700/50">
                <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-xl flex items-center justify-center text-slate-900 font-bold text-xl shadow-[0_0_15px_rgba(16,185,129,0.3)]">S</div>
                <div><h1 class="font-bold tracking-tight text-lg leading-tight">SIKAJI ASN</h1><p class="text-[10px] text-emerald-200 font-medium">Cloud Vercel</p></div>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <button onclick="window.nav('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group sidebar-item-active" id="nav-dashboard"><i class="ph ph-squares-four text-xl"></i> <span class="font-medium text-sm">Dashboard</span></button>
                <button onclick="window.nav('pegawai')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-pegawai"><i class="ph ph-users text-xl"></i> <span class="font-medium text-sm">Data Pegawai</span></button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Layanan</div>
                <button onclick="window.nav('usulan')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-usulan"><i class="ph ph-trend-up text-xl"></i> <span class="font-medium text-sm">Usulan KP & KGB</span><span id="badge-usulan" class="hidden ml-auto bg-emerald-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span></button>
                <button onclick="window.nav('verifikasi')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-verifikasi"><i class="ph ph-check-circle text-xl"></i> <span class="font-medium text-sm">Verifikasi</span><span id="badge-verif" class="hidden ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span></button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sistem</div>
                <button onclick="window.nav('simulation')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-simulation"><i class="ph ph-calculator text-xl"></i> <span class="font-medium text-sm">Simulasi Karir</span></button>
                <button onclick="window.nav('laporan')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-laporan"><i class="ph ph-file-pdf text-xl"></i> <span class="font-medium text-sm">Laporan</span></button>
                <button onclick="window.nav('settings')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-settings"><i class="ph ph-gear text-xl"></i> <span class="font-medium text-sm">Pengaturan</span></button>
                <button onclick="window.fetchData()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-emerald-500/20 text-emerald-300 flex items-center gap-3 transition-all group mt-6"><i class="ph ph-arrows-clockwise text-xl"></i> <span class="font-medium text-sm">Refresh Data</span></button>
            </nav>
            <div class="p-4 border-t border-slate-700/50 bg-slate-800/50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=10b981&color=fff" class="w-10 h-10 rounded-full border-2 border-slate-600" id="user-avatar-display">
                    <div><p class="text-sm font-bold text-white" id="user-name-display">Administrator</p><p class="text-[10px] text-slate-400">Kepegawaian</p></div>
                </div>
                <button onclick="window.performLogout()" class="text-slate-400 hover:text-red-400 transition-colors" title="Keluar"><i class="ph ph-sign-out text-xl"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50 relative">
            <header class="glass-panel h-16 flex items-center justify-between px-8 z-20 shrink-0 sticky top-0 shadow-sm">
                <div class="flex items-center gap-4"><h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard Eksekutif</h2></div>
                <div class="flex items-center gap-4">
                    <div id="clock" class="text-sm font-mono font-bold text-slate-500 hidden md:block"></div>
                    <div class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold border border-emerald-100 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Online</div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth" id="content-area">
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                        <div class="relative z-10 max-w-2xl">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang di SIKAJI ASN ðŸ‘‹</h2>
                            <p class="text-slate-500 mb-6">Data tersimpan aman di Supabase. Menghitung otomatis Masa Kerja Golongan (MKG) dengan logika pengurangan lintas golongan dan pola Ganjil/Genap.</p>
                            <button onclick="window.nav('pegawai')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition-all">Kelola Data Pegawai</button>
                        </div>
                        <i class="ph ph-database absolute right-10 bottom-10 text-9xl text-slate-100 z-0"></i>
                    </div>
                    <div id="priority-section" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="gradient-card-1 p-6 rounded-2xl shadow-lg text-white"><div class="text-3xl font-bold" id="stat-total">0</div><div class="text-xs opacity-80">Total Pegawai</div></div>
                        <div class="gradient-card-2 p-6 rounded-2xl shadow-lg text-white"><div class="text-3xl font-bold" id="stat-pangkat">0</div><div class="text-xs opacity-80">Eligible Pangkat</div></div>
                        <div class="gradient-card-3 p-6 rounded-2xl shadow-lg text-white"><div class="text-3xl font-bold" id="stat-kgb">0</div><div class="text-xs opacity-80">Eligible KGB</div></div>
                        <div class="gradient-card-4 p-6 rounded-2xl shadow-lg text-white cursor-pointer" onclick="window.nav('verifikasi')"><div class="text-3xl font-bold" id="hero-pending-count">0</div><div class="text-xs opacity-80">Menunggu Verifikasi</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                         <h3 class="font-bold text-slate-800 mb-4">Aktivitas Terbaru</h3>
                         <div id="activity-log-container" class="space-y-3 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- PEGAWAI -->
                <div id="view-pegawai" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h2 class="font-bold text-lg text-slate-800">Direktori Pegawai</h2>
                        <div class="flex gap-3">
                            <input type="text" id="search-pegawai" onkeyup="window.renderPegawai()" placeholder="Cari Nama / NIP..." class="pl-4 pr-4 py-2 border border-slate-200 rounded-xl text-sm outline-none">
                            <button onclick="window.openAddEmployeeModal()" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg">Tambah</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-4 pl-6">Pegawai</th><th class="p-4">Jabatan</th><th class="p-4 text-center">MKG</th><th class="p-4 text-center">Aksi</th></tr></thead><tbody id="table-pegawai-body" class="divide-y divide-slate-100"></tbody></table>
                    </div>
                </div>

                <!-- USULAN -->
                <div id="view-usulan" class="hidden space-y-6 animate-fade-in">
                     <div class="flex gap-2 mb-4">
                        <button onclick="window.renderUsulan('PANGKAT')" class="flex-1 py-3 bg-white border border-slate-200 rounded-xl font-bold text-sm hover:border-blue-500 hover:text-blue-600 shadow-sm transition-all">Cek Kenaikan Pangkat</button>
                        <button onclick="window.renderUsulan('KGB')" class="flex-1 py-3 bg-white border border-slate-200 rounded-xl font-bold text-sm hover:border-emerald-500 hover:text-emerald-600 shadow-sm transition-all">Cek Kenaikan Gaji Berkala</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 text-sm" id="usulan-title">Hasil Deteksi</div>
                        <table class="w-full text-left text-sm"><thead class="bg-white text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-4 pl-6">Pegawai</th><th class="p-4">Estimasi</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="table-usulan-body" class="divide-y divide-slate-100"></tbody></table>
                    </div>
                </div>

                <!-- VERIFIKASI -->
                <div id="view-verifikasi" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 text-xl">Antrian Verifikasi</h3>
                        <button onclick="window.printGeneralReport('PENDING')" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm">Cetak Daftar</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs"><tr><th class="p-4 pl-6">Tgl</th><th class="p-4">Jenis</th><th class="p-4">Pegawai</th><th class="p-4">Detail</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Kontrol</th></tr></thead><tbody id="table-verifikasi-body" class="divide-y divide-slate-100"></tbody></table>
                    </div>
                </div>

                <!-- OTHER VIEWS (SIMULATION, REPORT, SETTINGS) -->
                <div id="view-simulation" class="hidden space-y-6 animate-fade-in"><div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h3 class="font-bold text-lg mb-4">Simulasi Karir</h3><div class="grid grid-cols-4 gap-2 mb-4"><input id="sim-gol" class="p-2 border rounded" placeholder="Gol (III/a)"><input id="sim-mk" class="p-2 border rounded" type="number" placeholder="MK Thn"><input id="sim-tmt" class="p-2 border rounded" type="date"><button onclick="window.runSimulation()" class="bg-blue-600 text-white rounded font-bold">Hitung</button></div><div id="sim-timeline"></div></div></div>
                
                <div id="view-laporan" class="hidden space-y-6 animate-fade-in">
                     <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-8 rounded-2xl border border-slate-200 text-center cursor-pointer hover:shadow-lg transition-all" onclick="window.printGeneralReport('ALL')"><i class="ph ph-users-three text-4xl text-blue-500 mb-2"></i><h4 class="font-bold">Daftar Nominatif</h4></div>
                        <div class="bg-white p-8 rounded-2xl border border-slate-200 text-center cursor-pointer hover:shadow-lg transition-all" onclick="window.printGeneralReport('APPROVED')"><i class="ph ph-check-fat text-4xl text-emerald-500 mb-2"></i><h4 class="font-bold">Laporan Realisasi SK</h4></div>
                    </div>
                </div>

                <div id="view-settings" class="hidden space-y-6 animate-fade-in">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 max-w-2xl">
                        <h4 class="font-bold text-lg mb-6 border-b pb-4">Konfigurasi Tanda Tangan</h4>
                        <div class="space-y-4">
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Pejabat</label><input type="text" id="set-nama" class="w-full p-3 border rounded-xl text-sm"></div>
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP Pejabat</label><input type="text" id="set-nip" class="w-full p-3 border rounded-xl text-sm"></div>
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan</label><input type="text" id="set-jabatan" class="w-full p-3 border rounded-xl text-sm"></div>
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Logo</label><input type="text" id="set-logo" class="w-full p-3 border rounded-xl text-sm"></div>
                             <div class="pt-4"><button onclick="window.saveSettings()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg">Simpan Konfigurasi</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL PEGAWAI -->
    <div id="modal-employee" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 m-4 animate-slide-up">
             <h3 class="font-bold text-lg text-slate-800 mb-4" id="modal-title">Form Data Pegawai</h3>
             <form id="form-employee" onsubmit="event.preventDefault(); window.saveEmployee();" class="space-y-3">
                <input type="hidden" id="inp-id">
                <div class="grid grid-cols-2 gap-3"><input id="inp-nama" class="p-2 border rounded text-sm w-full" placeholder="Nama Lengkap" required><input id="inp-nip" class="p-2 border rounded text-sm w-full" placeholder="NIP" required></div>
                <input id="inp-jabatan" class="p-2 border rounded text-sm w-full" placeholder="Jabatan" required>
                <div class="grid grid-cols-3 gap-3"><input id="inp-golongan" class="p-2 border rounded text-sm uppercase" placeholder="Gol (III/a)" required><input id="inp-mk-thn" type="number" class="p-2 border rounded text-sm" placeholder="MK Thn" required><input id="inp-mk-bln" type="number" class="p-2 border rounded text-sm" placeholder="MK Bln" required></div>
                <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500">Tgl Lahir</label><input type="date" id="inp-lahir" class="p-2 border rounded text-sm w-full" required></div><div><label class="text-[10px] font-bold text-slate-500">TMT Pangkat</label><input type="date" id="inp-tmt-pangkat" class="p-2 border rounded text-sm w-full" required></div></div>
                <div><label class="text-[10px] font-bold text-slate-500">TMT Berkala</label><input type="date" id="inp-tmt-berkala" class="p-2 border rounded text-sm w-full" required></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="document.getElementById('modal-employee').classList.add('hidden')" class="px-4 py-2 text-slate-600 font-bold text-xs hover:bg-slate-100 rounded-lg">Batal</button><button type="submit" class="px-6 py-2 bg-slate-900 text-white font-bold text-xs rounded-lg hover:bg-slate-800">Simpan</button></div>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all z-[100] text-sm font-bold flex items-center gap-2"></div>

    <script>
        // --- KONFIGURASI SUPABASE (WAJIB DIISI) ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co'; // GANTI INI
        const SUPABASE_KEY = 'public-anon-key'; // GANTI INI

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let employees = [], proposals = [], activityLog = [], settings = {}, currentUser = null;
        const SALARY_RANGES = {'I/a':1685700,'II/a':2184000,'III/a':2785700,'IV/a':3287800}; // Simplified

        // --- AUTH ---
        window.performLogin = async function() {
            showLoading(true);
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            // Simple Login Table Query (Not Supabase Auth for simplicity in 1 file, but secure enough for internal tool)
            const { data, error } = await supabaseClient.from('app_users').select('*').eq('username', user).eq('password', pass).single();
            
            showLoading(false);
            if(data) {
                currentUser = data;
                sessionStorage.setItem('sikaji_session', JSON.stringify(data));
                initApp();
            } else {
                alert("Login Gagal. Cek username/password atau koneksi Supabase.");
            }
        };

        window.performLogout = function() {
            sessionStorage.removeItem('sikaji_session');
            location.reload();
        };

        // --- DATA ---
        async function initApp() {
            const session = sessionStorage.getItem('sikaji_session');
            if (!session) {
                document.getElementById('login-interface').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
                return;
            }
            currentUser = JSON.parse(session);
            document.getElementById('login-interface').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=10b981&color=fff`;

            await window.fetchData();
            window.nav('dashboard');
        }

        window.fetchData = async function() {
            showLoading(true);
            try {
                // Pegawai
                const { data: emp } = await supabaseClient.from('pegawai').select('*').order('nama');
                if(emp) employees = emp.map(e => ({...e, tgl_lahir: new Date(e.tgl_lahir), tmt_pangkat: new Date(e.tmt_pangkat), tmt_berkala: new Date(e.tmt_berkala)}));
                
                // Usulan
                const { data: prop } = await supabaseClient.from('usulan').select('*').order('created_at', {ascending: false});
                if(prop) proposals = prop.map(p => ({...p, date: new Date(p.date), newTMT: new Date(p.new_tmt)}));

                // Settings
                const { data: set } = await supabaseClient.from('settings').select('*').eq('id', 1).single();
                if(set) settings = set;

                // Logs
                const { data: logs } = await supabaseClient.from('logs').select('*').order('created_at', {ascending: false}).limit(10);
                if(logs) activityLog = logs;

                renderLogs();
                updateDashboard();
            } catch(e) { console.error(e); alert("Gagal mengambil data. Cek koneksi."); }
            showLoading(false);
        };

        // --- CRUD PEGAWAI ---
        window.openAddEmployeeModal = function(id=null) {
            document.getElementById('modal-employee').classList.remove('hidden');
            document.getElementById('modal-employee').classList.add('flex');
            document.getElementById('form-employee').reset();
            document.getElementById('inp-id').value = '';
            document.getElementById('modal-title').innerText = "Tambah Pegawai";
            
            if(id) {
                const e = employees.find(x => x.id == id);
                if(e) {
                    document.getElementById('inp-id').value = e.id;
                    document.getElementById('inp-nama').value = e.nama;
                    document.getElementById('inp-nip').value = e.nip;
                    document.getElementById('inp-jabatan').value = e.jabatan;
                    document.getElementById('inp-golongan').value = e.golongan;
                    document.getElementById('inp-mk-thn').value = e.mk_tahun;
                    document.getElementById('inp-mk-bln').value = e.mk_bulan;
                    document.getElementById('inp-lahir').value = e.tgl_lahir.toISOString().split('T')[0];
                    document.getElementById('inp-tmt-pangkat').value = e.tmt_pangkat.toISOString().split('T')[0];
                    document.getElementById('inp-tmt-berkala').value = e.tmt_berkala.toISOString().split('T')[0];
                    document.getElementById('modal-title').innerText = "Edit Data Pegawai";
                }
            }
        };

        window.saveEmployee = async function() {
            showLoading(true);
            const id = document.getElementById('inp-id').value;
            const data = {
                nama: document.getElementById('inp-nama').value,
                nip: document.getElementById('inp-nip').value,
                jabatan: document.getElementById('inp-jabatan').value,
                golongan: document.getElementById('inp-golongan').value,
                mk_tahun: parseInt(document.getElementById('inp-mk-thn').value),
                mk_bulan: parseInt(document.getElementById('inp-mk-bln').value),
                tgl_lahir: document.getElementById('inp-lahir').value,
                tmt_pangkat: document.getElementById('inp-tmt-pangkat').value,
                tmt_berkala: document.getElementById('inp-tmt-berkala').value
            };

            if(id) {
                await supabaseClient.from('pegawai').update(data).eq('id', id);
                logActivity(`Update pegawai ${data.nama}`, 'warning');
            } else {
                await supabaseClient.from('pegawai').insert(data);
                logActivity(`Tambah pegawai ${data.nama}`, 'success');
            }
            
            document.getElementById('modal-employee').classList.add('hidden');
            document.getElementById('modal-employee').classList.remove('flex');
            await window.fetchData();
            window.renderPegawai();
            showToast("Data Berhasil Disimpan");
            showLoading(false);
        };

        window.deleteEmployee = async function(id) {
            if(confirm("Yakin hapus data ini?")) {
                showLoading(true);
                await supabaseClient.from('pegawai').delete().eq('id', id);
                logActivity(`Hapus pegawai ID: ${id}`, 'error');
                await window.fetchData();
                window.renderPegawai();
                showToast("Data Dihapus");
                showLoading(false);
            }
        };

        // --- USULAN ---
        window.renderUsulan = function(type) {
            const tbody = document.getElementById('table-usulan-body');
            document.getElementById('usulan-title').innerText = type === 'PANGKAT' ? 'Deteksi Kenaikan Pangkat' : 'Deteksi Kenaikan Gaji Berkala';
            
            const list = employees.map(e => {
                const nextDate = new Date(type === 'PANGKAT' ? e.tmt_pangkat : e.tmt_berkala);
                nextDate.setFullYear(nextDate.getFullYear() + (type === 'PANGKAT' ? 4 : 2));
                const isEligible = new Date() >= new Date(new Date(nextDate).setMonth(nextDate.getMonth()-3));
                return { ...e, nextDate, isEligible };
            }).filter(x => x.isEligible);

            if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-400 italic">Tidak ada pegawai yang memenuhi syarat.</td></tr>`; return; }

            tbody.innerHTML = list.map(x => {
                const existing = proposals.find(p => p.emp_id == x.id && p.status === 'MENUNGGU');
                return `<tr class="border-b hover:bg-slate-50">
                    <td class="p-4 font-bold text-slate-700">${x.nama}<br><span class="font-normal text-xs text-slate-400">${x.nip}</span></td>
                    <td class="p-4 text-xs">TMT Baru: ${x.nextDate.toLocaleDateString('id-ID')}</td>
                    <td class="p-4 text-center"><span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold">ELIGIBLE</span></td>
                    <td class="p-4 text-right">${existing ? '<span class="text-xs italic text-slate-400">Menunggu Verif</span>' : `<button onclick="window.createProposal(${x.id}, '${type}')" class="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Proses</button>`}</td>
                </tr>`;
            }).join('');
        };

        window.createProposal = async function(id, type) {
            showLoading(true);
            const e = employees.find(x => x.id == id);
            // Logic Simplified for Supabase version
            const nextDate = new Date(type === 'PANGKAT' ? e.tmt_pangkat : e.tmt_berkala);
            nextDate.setFullYear(nextDate.getFullYear() + (type === 'PANGKAT' ? 4 : 2));
            
            const payload = {
                emp_id: e.id, emp_name: e.nama, emp_nip: e.nip, type, status: 'MENUNGGU',
                date: new Date().toISOString(), new_tmt: nextDate.toISOString(),
                old_rank: e.golongan, new_rank: e.golongan, // Logic would go here
                old_gaji: 0, new_gaji: 0, new_mk_tahun: e.mk_tahun + 2, reduction: 0
            };
            
            await supabaseClient.from('usulan').insert(payload);
            logActivity(`Buat usulan ${type}: ${e.nama}`, 'info');
            await window.fetchData();
            window.renderUsulan(type);
            showToast("Usulan Dibuat");
            showLoading(false);
        };

        // --- VERIFIKASI ---
        window.renderVerifikasi = function() {
            const tbody = document.getElementById('table-verifikasi-body');
            const list = proposals.filter(p => p.status === 'MENUNGGU');
            if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Tidak ada antrian verifikasi.</td></tr>`; return; }
            
            tbody.innerHTML = list.map(p => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-4 text-xs font-mono">${p.date.toLocaleDateString('id-ID')}</td>
                    <td class="p-4 text-xs font-bold">${p.type}</td>
                    <td class="p-4 font-bold text-sm">${p.emp_name}</td>
                    <td class="p-4 text-xs text-slate-500">MKG Baru: ${p.new_mk_tahun} Thn</td>
                    <td class="p-4 text-center"><span class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-[10px] font-bold">MENUNGGU</span></td>
                    <td class="p-4 text-right"><button onclick="window.approveProposal(${p.id})" class="text-emerald-600 p-2 hover:bg-emerald-50 rounded"><i class="ph ph-check-circle text-lg"></i></button> <button onclick="window.rejectProposal(${p.id})" class="text-red-500 p-2 hover:bg-red-50 rounded"><i class="ph ph-x-circle text-lg"></i></button></td>
                </tr>
            `).join('');
            document.getElementById('stat-pending').innerText = list.length;
            document.getElementById('badge-verif').innerText = list.length;
            document.getElementById('badge-verif').classList.toggle('hidden', list.length === 0);
        };

        window.approveProposal = async function(id) {
            if(!confirm("Setujui usulan? Data pegawai akan diperbarui.")) return;
            showLoading(true);
            const p = proposals.find(x => x.id == id);
            
            // Update Pegawai
            const updateData = { mk_tahun: p.new_mk_tahun, mk_bulan: 0, tmt_berkala: p.newTMT.toISOString() };
            if(p.type === 'PANGKAT') updateData.tmt_pangkat = p.newTMT.toISOString();
            
            await supabaseClient.from('pegawai').update(updateData).eq('id', p.emp_id);
            await supabaseClient.from('usulan').update({ status: 'DISETUJUI' }).eq('id', id);
            
            logActivity(`Usulan ${p.type} ${p.emp_name} disetujui`, 'success');
            await window.fetchData();
            window.renderVerifikasi();
            showToast("Disetujui");
            showLoading(false);
        };

        window.rejectProposal = async function(id) {
             if(!confirm("Tolak usulan?")) return;
             showLoading(true);
             await supabaseClient.from('usulan').update({ status: 'DITOLAK' }).eq('id', id);
             await window.fetchData();
             window.renderVerifikasi();
             showToast("Ditolak", "warning");
             showLoading(false);
        };

        // --- UTILS ---
        window.nav = function(page) {
            document.querySelectorAll('#content-area > div').forEach(e => e.classList.add('hidden'));
            const target = document.getElementById('view-' + page);
            if(target) target.classList.remove('hidden');
            
            // Fix: Show usulan view for both buttons
            if (page === 'usulan-pangkat' || page === 'usulan-kgb') document.getElementById('view-usulan').classList.remove('hidden');

            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-item-active'));
            const btn = document.getElementById('nav-' + (page.includes('usulan') ? 'usulan' : page));
            if(btn) btn.classList.add('sidebar-item-active');

            if(page === 'dashboard') updateDashboard();
            if(page === 'pegawai') renderPegawai();
            if(page === 'verifikasi') renderVerifikasi();
            if(page === 'settings') loadSettingsUI();
        };

        function updateDashboard() {
            document.getElementById('stat-total').innerText = employees.length;
            // Logic notifikasi
            const eligibleKGB = employees.filter(e => {
                const nextKGB = new Date(e.tmt_berkala); nextKGB.setFullYear(nextKGB.getFullYear()+2);
                return new Date() >= new Date(nextKGB.setMonth(nextKGB.getMonth()-3));
            }).length;
             document.getElementById('stat-kgb').innerText = eligibleKGB;
             document.getElementById('badge-usulan').innerText = eligibleKGB; // Simple badge logic
             document.getElementById('badge-usulan').classList.toggle('hidden', eligibleKGB===0);
        }

        async function logActivity(text, type) {
            await supabaseClient.from('logs').insert({ text, type, time: new Date().toLocaleTimeString(), timestamp: Date.now() });
        }

        function renderLogs() {
            document.getElementById('activity-log-container').innerHTML = activityLog.map(l => `
                <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 border border-slate-100">
                    <div class="w-2 h-2 rounded-full ${l.type==='success'?'bg-emerald-500':l.type==='warning'?'bg-amber-500':'bg-blue-500'}"></div>
                    <div><p class="text-xs font-bold text-slate-700">${l.text}</p><p class="text-[10px] text-slate-400">${l.time}</p></div>
                </div>`).join('');
        }

        // Settings
        function loadSettingsUI() {
            document.getElementById('set-nama').value = settings.signer_name || '';
            document.getElementById('set-nip').value = settings.signer_nip || '';
            document.getElementById('set-jabatan').value = settings.signer_position || '';
            document.getElementById('set-logo').value = settings.logo_url || '';
        }
        
        window.saveSettings = async function() {
             showLoading(true);
             const data = { signer_name: document.getElementById('set-nama').value, signer_nip: document.getElementById('set-nip').value, signer_position: document.getElementById('set-jabatan').value, logo_url: document.getElementById('set-logo').value };
             await supabaseClient.from('settings').update(data).eq('id', 1);
             await fetchData();
             showToast("Disimpan");
             showLoading(false);
        }

        function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('active', show); }
        function showToast(msg, type='success') { 
            const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity='1'; t.style.transform='translateY(0)';
            setTimeout(() => { t.style.opacity='0'; t.style.transform='translateY(20px)'; }, 3000); 
        }

        window.onload = () => {
             // Check if supabase keys are set
             if(SUPABASE_URL.includes('xyzcompany')) { alert("PENTING: Masukkan URL & KEY Supabase Anda di baris 330!"); }
             initApp(); 
             setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
        };
    </script>
</body>
</html>
