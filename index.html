<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIKAJI ASN - Sistem Kepegawaian & Kinerja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                },
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f3f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .gradient-primary { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .gradient-card-1 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .gradient-card-2 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-card-3 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .gradient-card-4 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .sidebar-item-active { background-color: rgba(255, 255, 255, 0.1); border-left: 3px solid #f59e0b; }
    </style>
</head>
<body class="text-slate-800 antialiased overflow-hidden">

    <!-- VIEW: LOGIN INTERFACE -->
    <div id="login-interface" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-200 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-400 to-orange-500"></div>
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center text-slate-900 font-bold text-3xl shadow-lg mx-auto mb-4">S</div>
                <h1 class="text-2xl font-bold text-slate-800">SIKAJI ASN</h1>
                <p class="text-sm text-slate-500">Silakan login untuk melanjutkan</p>
            </div>

            <form onsubmit="event.preventDefault(); window.performLogin();" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <div class="relative">
                        <i class="ph ph-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                        <input type="text" id="login-username" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none transition-all" placeholder="Masukkan username" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <div class="relative">
                        <i class="ph ph-lock-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i>
                        <input type="password" id="login-password" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none transition-all" placeholder="Masukkan password" required>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 hover:shadow-xl transition-all flex items-center justify-center gap-2">
                    <i class="ph ph-sign-in text-lg"></i> Masuk Aplikasi
                </button>
            </form>
        </div>
        <div class="absolute bottom-6 text-slate-400 text-xs font-medium">
            &copy; 2025 Dinas PUPR Provinsi Kalsel - Lab Bahan Konstruksi
        </div>
    </div>

    <!-- VIEW: APP INTERFACE (MAIN) -->
    <div id="app-interface" class="hidden flex h-screen w-full">
        <!-- Sidebar -->
        <aside class="w-64 gradient-primary text-white flex flex-col shrink-0 shadow-2xl z-30 transition-all duration-300" id="sidebar">
            <div class="p-6 flex items-center gap-3 border-b border-slate-700/50">
                <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-slate-900 font-bold text-xl shadow-[0_0_15px_rgba(245,158,11,0.3)]">S</div>
                <div>
                    <h1 class="font-bold tracking-tight text-lg leading-tight">SIKAJI ASN</h1>
                    <p class="text-[10px] text-slate-400 font-medium">Regulasi BKN 2025</p>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <button onclick="window.nav('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group sidebar-item-active" id="nav-dashboard">
                    <i class="ph ph-squares-four text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Dashboard</span>
                </button>
                <button onclick="window.nav('pegawai')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-pegawai">
                    <i class="ph ph-users text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Data Pegawai</span>
                </button>
                
                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Layanan Karir</div>
                
                <button onclick="window.nav('usulan-pangkat')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-usulan-pangkat">
                    <i class="ph ph-trend-up text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Usulan Pangkat</span>
                    <span id="badge-pangkat" class="hidden absolute right-3 top-3 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                </button>
                <button onclick="window.nav('usulan-kgb')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-usulan-kgb">
                    <i class="ph ph-money text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Usulan KGB</span>
                    <span id="badge-kgb" class="hidden absolute right-3 top-3 bg-emerald-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                </button>
                <button onclick="window.nav('verifikasi')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group relative" id="nav-verifikasi">
                    <i class="ph ph-check-circle text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Verifikasi Usulan</span>
                    <span id="badge-verif" class="hidden absolute right-3 top-3 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
                </button>

                <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Laporan & Sistem</div>

                <button onclick="window.nav('simulation')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-simulation">
                    <i class="ph ph-calculator text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Simulasi Karir</span>
                </button>
                <button onclick="window.nav('laporan')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-laporan">
                    <i class="ph ph-file-pdf text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Pusat Laporan</span>
                </button>
                <button onclick="window.nav('salary')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-salary">
                    <i class="ph ph-table text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Standar Gaji</span>
                </button>
                <button onclick="window.nav('pensiun')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-pensiun">
                    <i class="ph ph-hourglass-high text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Monitoring Pensiun</span>
                </button>
                <button onclick="window.nav('settings')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 flex items-center gap-3 transition-all group" id="nav-settings">
                    <i class="ph ph-gear text-xl text-slate-400 group-hover:text-amber-400 transition-colors"></i> 
                    <span class="font-medium text-sm">Pengaturan</span>
                </button>
                
                <!-- BACKUP & RESTORE SECTION -->
                <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Manajemen Data</div>
                <div class="grid grid-cols-2 gap-2 px-4 pb-6">
                    <button onclick="window.exportDataJSON()" class="text-left px-3 py-2 rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex flex-col items-center gap-1 transition-all border border-emerald-100/20 group hover:shadow-lg">
                        <i class="ph ph-download-simple text-xl"></i>
                        <span class="font-bold text-[10px]">Backup</span>
                    </button>
                    <label for="import-json" class="cursor-pointer text-left px-3 py-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 flex flex-col items-center gap-1 transition-all border border-blue-100/20 group hover:shadow-lg">
                        <i class="ph ph-upload-simple text-xl"></i>
                        <span class="font-bold text-[10px]">Restore</span>
                    </label>
                    <input type="file" id="import-json" accept=".json" class="hidden" onchange="window.importDataJSON(this)">
                </div>
            </nav>

            <div class="p-4 border-t border-slate-700/50 bg-slate-800/50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://ui-avatars.com/api/?name=Admin+Sikaji&background=f59e0b&color=fff" class="w-10 h-10 rounded-full border-2 border-slate-600" id="user-avatar-display">
                    <div>
                        <p class="text-sm font-bold text-white" id="user-name-display">Administrator</p>
                        <p class="text-[10px] text-slate-400">Kepegawaian</p>
                    </div>
                </div>
                <button onclick="window.performLogout()" class="text-slate-400 hover:text-red-400 transition-colors" title="Keluar">
                    <i class="ph ph-sign-out text-xl"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative bg-slate-50/50">
            <!-- Header -->
            <header class="glass-panel h-16 flex items-center justify-between px-8 z-20 shrink-0 sticky top-0 shadow-sm">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard Eksekutif</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="clock" class="text-sm font-mono font-bold text-slate-500 hidden md:block"></div>
                    <div class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-bold border border-blue-100 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> Regulasi BKN 2025
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth" id="content-area">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    <!-- Welcome Card -->
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group">
                        <div class="relative z-10 max-w-2xl">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang di SIKAJI ASN ðŸ‘‹</h2>
                            <p class="text-slate-500 mb-6">Sistem terintegrasi PP 5/2024. Menghitung otomatis Masa Kerja Golongan (MKG) dengan logika pengurangan lintas golongan dan pola Ganjil/Genap.</p>
                            <button onclick="window.nav('pegawai')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2">
                                <i class="ph ph-users"></i> Kelola Data Pegawai
                            </button>
                        </div>
                        <div class="absolute right-0 top-0 w-80 h-80 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-full -mr-20 -mt-20 z-0 opacity-50"></div>
                        <i class="ph ph-buildings absolute right-10 bottom-10 text-9xl text-slate-100 z-0"></i>
                    </div>

                    <!-- Priority Alerts -->
                    <div id="priority-section" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="gradient-card-1 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform">
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-users-three text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">TOTAL</span>
                                </div>
                                <div class="text-4xl font-bold mb-1" id="stat-total">0</div>
                                <div class="text-blue-100 text-xs font-medium">Pegawai Aktif</div>
                            </div>
                            <i class="ph ph-users-three absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                        </div>

                        <div class="gradient-card-2 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform">
                             <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-trend-up text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">ELIGIBLE</span>
                                </div>
                                <div class="text-4xl font-bold mb-1" id="stat-pangkat">0</div>
                                <div class="text-emerald-100 text-xs font-medium">Kenaikan Pangkat</div>
                            </div>
                            <i class="ph ph-trend-up absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                        </div>

                        <div class="gradient-card-3 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden group hover:-translate-y-1 transition-transform">
                             <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-money text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded">ELIGIBLE</span>
                                </div>
                                <div class="text-4xl font-bold mb-1" id="stat-kgb">0</div>
                                <div class="text-purple-100 text-xs font-medium">Kenaikan Gaji Berkala</div>
                            </div>
                            <i class="ph ph-money absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                        </div>

                        <div onclick="window.nav('verifikasi')" class="gradient-card-4 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden cursor-pointer group hover:-translate-y-1 transition-transform">
                             <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm"><i class="ph ph-stamp text-xl"></i></div>
                                    <span class="text-[10px] font-bold bg-white/20 px-2 py-1 rounded animate-pulse">ACTION</span>
                                </div>
                                <div class="text-4xl font-bold mb-1" id="hero-pending-count">0</div>
                                <div class="text-amber-100 text-xs font-medium">Menunggu Verifikasi</div>
                            </div>
                            <i class="ph ph-stamp absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                        </div>
                    </div>

                    <!-- Charts & Timeline -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                             <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-chart-bar text-xl text-blue-500"></i> Distribusi Golongan</h3>
                            </div>
                            <div class="h-64 w-full relative">
                                <canvas id="chart-golongan"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                             <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-xl text-slate-500"></i> Aktivitas Terbaru</h3>
                            </div>
                            <div class="flex-1 overflow-y-auto pr-2 max-h-[250px] space-y-4" id="activity-log-container">
                                <!-- Activities injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PEGAWAI -->
                <div id="view-pegawai" class="hidden space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-2xl border border-slate-200 shadow-sm gap-4">
                        <div>
                            <h2 class="font-bold text-lg text-slate-800">Direktori Pegawai</h2>
                            <p class="text-sm text-slate-500">Kelola data master, jabatan, dan riwayat pangkat.</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="search-pegawai" onkeyup="window.renderPegawai()" placeholder="Cari Nama / NIP..." class="pl-9 pr-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-64">
                            </div>
                            <button onclick="window.openAddEmployeeModal()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl shadow-lg font-bold text-sm flex items-center gap-2 transition-colors">
                                <i class="ph ph-user-plus text-lg"></i> Tambah
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs tracking-wider">
                                    <tr>
                                        <th class="p-4 pl-6">Pegawai</th>
                                        <th class="p-4">Jabatan & Golongan</th>
                                        <th class="p-4">Riwayat TMT</th>
                                        <th class="p-4 text-center">MKG (SK)</th>
                                        <th class="p-4 text-right">Gaji Pokok</th>
                                        <th class="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pegawai-body" class="divide-y divide-slate-100 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-center text-xs text-slate-500">
                           <span id="pegawai-count">Menampilkan data pegawai</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW: USULAN (Shared for Pangkat & KGB) -->
                <div id="view-usulan" class="hidden space-y-6 animate-fade-in">
                    <div id="usulan-header-card" class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-8 rounded-2xl shadow-xl relative overflow-hidden transition-colors duration-300">
                        <div class="relative z-10">
                            <h3 class="font-bold text-2xl mb-1" id="usulan-title">Periodisasi KP</h3>
                            <p class="text-blue-100 text-sm max-w-2xl opacity-90">Sistem mendeteksi pegawai eligible berdasarkan MKG Kumulatif (PerBKN 4/2025).</p>
                            <div class="mt-6 flex gap-4">
                                <div class="bg-white/20 backdrop-blur-md px-5 py-2.5 rounded-xl border border-white/30 flex items-center gap-3">
                                    <div class="p-2 bg-white/20 rounded-full"><i class="ph ph-users text-xl"></i></div>
                                    <div><p class="text-[10px] uppercase font-bold opacity-80">Total Eligible</p><p class="text-xl font-bold" id="usulan-count">0</p></div>
                                </div>
                            </div>
                        </div>
                        <i class="ph ph-trend-up absolute right-0 top-0 text-[15rem] opacity-10 -mr-10 -mt-10"></i>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-sm">Daftar Nominatif Usulan</h4>
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="search-usulan" onkeyup="window.filterUsulanTable()" placeholder="Filter..." class="pl-8 pr-3 py-1.5 border border-slate-300 rounded-lg text-xs w-48 bg-white">
                            </div>
                        </div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs tracking-wider">
                                <tr>
                                    <th class="p-5 pl-6 w-1/3">Pegawai</th>
                                    <th class="p-5 w-1/3">Estimasi Perubahan</th>
                                    <th class="p-5 text-center">Analisis Sistem</th>
                                    <th class="p-5 text-right pr-6">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="table-usulan-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: VERIFIKASI -->
                <div id="view-verifikasi" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800 text-xl">Antrian Verifikasi</h3>
                            <p class="text-slate-500 text-sm">Verifikasi menerapkan pengurangan MKG otomatis (Lintas Golongan).</p>
                        </div>
                        <button onclick="window.printGeneralReport('PENDING')" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2">
                            <i class="ph ph-printer"></i> Cetak Daftar Antrian
                        </button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs">
                                <tr>
                                    <th class="p-4 pl-6">Tgl Usulan</th>
                                    <th class="p-4">Jenis</th>
                                    <th class="p-4">Pegawai</th>
                                    <th class="p-4">Detail Perubahan</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-right pr-6">Kontrol</th>
                                </tr>
                            </thead>
                            <tbody id="table-verifikasi-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: SIMULATION -->
                <div id="view-simulation" class="hidden space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                <i class="ph ph-sliders-horizontal text-blue-600"></i> Parameter Simulasi
                            </h3>
                            <p class="text-xs text-slate-500 mb-6">Masukkan data terkini untuk memproyeksikan kenaikan pangkat dan gaji hingga 10 tahun ke depan tanpa menyimpan ke database.</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Golongan Saat Ini</label>
                                    <select id="sim-golongan" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none"></select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Tahun</label>
                                        <input type="number" id="sim-mk-tahun" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG Bulan</label>
                                        <input type="number" id="sim-mk-bulan" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="0">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Pangkat Terakhir</label>
                                    <input type="date" id="sim-tmt-pangkat" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">TMT Berkala Terakhir</label>
                                    <input type="date" id="sim-tmt-berkala" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <button onclick="window.runSimulation()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition-colors flex items-center justify-center gap-2 mt-4">
                                    <i class="ph ph-magic-wand text-lg"></i> Hitung Proyeksi
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 space-y-6">
                            <div id="sim-result-header" class="hidden bg-slate-800 text-white p-6 rounded-2xl shadow-lg">
                                <h4 class="text-lg font-bold">Hasil Proyeksi Karir (10 Tahun)</h4>
                                <p class="text-slate-300 text-sm">Estimasi kenaikan berdasarkan regulasi PP 5/2024 & PerBKN 4/2025.</p>
                            </div>
                            <div id="sim-timeline" class="space-y-4 relative">
                                <div class="text-center text-slate-400 py-20 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                                    <i class="ph ph-chart-line-up text-4xl mb-2 text-slate-300"></i>
                                    <p>Masukkan parameter di sebelah kiri<br>untuk melihat hasil simulasi.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LAPORAN -->
                <div id="view-laporan" class="hidden space-y-6 animate-fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-slate-800 text-xl">Pusat Laporan</h3>
                            <p class="text-slate-500 text-sm">Cetak dokumen rekapitulasi kepegawaian dan usulan.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group">
                            <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                <i class="ph ph-users-three text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-lg mb-2">Daftar Nominatif</h4>
                            <p class="text-sm text-slate-500 mb-6">Rekapitulasi seluruh data pegawai aktif beserta pangkat dan jabatan terakhir.</p>
                            <button onclick="window.printGeneralReport('ALL')" class="w-full py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                                <i class="ph ph-printer"></i> Cetak Nominatif
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group">
                            <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 mb-4 group-hover:scale-110 transition-transform">
                                <i class="ph ph-check-fat text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-lg mb-2">Rekap SK Terbit</h4>
                            <p class="text-sm text-slate-500 mb-6">Daftar usulan KP dan KGB yang telah disetujui dan diterbitkan SK-nya.</p>
                            <button onclick="window.printGeneralReport('APPROVED')" class="w-full py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                                <i class="ph ph-printer"></i> Cetak Laporan SK
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all group">
                            <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600 mb-4 group-hover:scale-110 transition-transform">
                                <i class="ph ph-clock-countdown text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-lg mb-2">Antrian Verifikasi</h4>
                            <p class="text-sm text-slate-500 mb-6">Daftar usulan yang masih menunggu persetujuan pejabat berwenang.</p>
                            <button onclick="window.printGeneralReport('PENDING')" class="w-full py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                                <i class="ph ph-printer"></i> Cetak Antrian
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SALARY TABLE -->
                <div id="view-salary" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-xl">Tabel Gaji Pokok PNS (PP 5/2024)</h3>
                            <p class="text-slate-500 text-sm">Referensi dasar perhitungan kenaikan gaji berkala dan pangkat.</p>
                        </div>
                        <div class="text-xs bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1.5 rounded-lg font-bold">
                            Berlaku sejak 1 Januari 2024
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900 text-white font-bold border-b border-slate-800 uppercase text-xs">
                                    <tr>
                                        <th class="p-4 pl-6">Golongan</th>
                                        <th class="p-4">Pangkat</th>
                                        <th class="p-4 text-center">MKG Min (0 Thn)</th>
                                        <th class="p-4 text-center">MKG Maks</th>
                                        <th class="p-4 text-right pr-6">Gaji Maksimal</th>
                                    </tr>
                                </thead>
                                <tbody id="table-salary-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div class="p-6 bg-slate-50 border-t border-slate-200 text-xs text-slate-500 space-y-2">
                            <p><strong>Catatan Perhitungan:</strong></p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>Kenaikan Gaji Berkala (KGB) diberikan setiap 2 tahun sekali apabila telah memenuhi syarat nilai kinerja minimal "Baik".</li>
                                <li>Besaran kenaikan gaji berkala dalam sistem ini disimulasikan menggunakan pola increment standar PP 5/2024.</li>
                                <li>Masa Kerja Golongan (MKG) maksimum disesuaikan per golongan (Contoh: Gol II/a maksimal 33 tahun).</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PENSIUN -->
                <div id="view-pensiun" class="hidden space-y-6 animate-fade-in">
                      <div class="flex items-center justify-between">
                        <h3 class="font-bold text-slate-700 text-xl">Monitoring Batas Usia Pensiun</h3>
                        <span class="text-xs bg-red-50 text-red-600 border border-red-100 px-3 py-1 rounded-full font-bold">BUP: 58 Tahun</span>
                    </div>
                    <div id="pensiun-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mt-6">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 text-sm">Daftar Lengkap Estimasi Pensiun</div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-xs">
                                <tr>
                                    <th class="p-4 pl-6">Pegawai</th>
                                    <th class="p-4">Tanggal Lahir</th>
                                    <th class="p-4 text-center">Usia Saat Ini</th>
                                    <th class="p-4 text-center">Sisa Masa Kerja</th>
                                    <th class="p-4">TMT Pensiun</th>
                                </tr>
                            </thead>
                            <tbody id="table-pensiun-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="hidden space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Profile Card for Signer -->
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Section: Manajemen Akun (NEW) -->
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                                <h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b pb-4"><i class="ph ph-lock-key text-xl"></i> Keamanan Akun</h4>
                                
                                <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <p class="text-sm text-slate-600 mb-2">Anda login sebagai: <strong id="settings-current-user">admin</strong></p>
                                </div>

                                <form onsubmit="event.preventDefault(); window.changePassword();" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Lama</label>
                                            <input type="password" id="set-pass-old" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password Baru</label>
                                            <input type="password" id="set-pass-new" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                                        </div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-amber-500 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-amber-600 transition-all flex items-center gap-2 text-sm">
                                            <i class="ph ph-key"></i> Ganti Password
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Section: Konfigurasi SK -->
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                                <h4 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2 border-b pb-4"><i class="ph ph-pen-nib text-xl"></i> Konfigurasi Tanda Tangan SK</h4>
                                
                                <div class="mb-8 flex items-start gap-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                    <div class="w-20 h-20 bg-white rounded-lg border border-slate-200 flex items-center justify-center p-2 shadow-sm overflow-hidden">
                                        <img id="settings-logo-preview" src="" class="w-full h-full object-contain">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-bold text-slate-700 mb-1">Logo Kop Surat</label>
                                        <div class="flex gap-3">
                                            <label for="input-logo" class="cursor-pointer px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition-colors shadow-sm flex items-center gap-2">
                                                <i class="ph ph-upload-simple"></i> Upload Logo
                                            </label>
                                            <input type="file" id="input-logo" accept="image/*" class="hidden" onchange="window.uploadLogo(event)">
                                            <button onclick="window.resetLogo()" class="px-3 py-1.5 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors">Reset Default</button>
                                        </div>
                                    </div>
                                </div>

                                <form id="form-settings" onsubmit="event.preventDefault(); window.saveSettings();">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Pejabat</label>
                                            <input type="text" id="set-nama" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" oninput="window.updateQRPreview()">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP Pejabat</label>
                                            <input type="text" id="set-nip" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" oninput="window.updateQRPreview()">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan Struktural</label>
                                            <input type="text" id="set-jabatan" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat/Golongan</label>
                                            <select id="set-golongan" class="w-full p-3 border border-slate-300 rounded-xl bg-white text-sm focus:ring-2 focus:ring-blue-500 outline-none"></select>
                                        </div>
                                    </div>
                                    <div class="mt-8 flex justify-end">
                                        <button type="submit" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition-all flex items-center gap-2">
                                            <i class="ph ph-floppy-disk"></i> Simpan Konfigurasi
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Preview Card -->
                        <div class="bg-slate-100 p-6 rounded-2xl border border-slate-200 flex flex-col items-center justify-center text-center">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Preview Digital Signature</p>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-4 w-full max-w-[200px]">
                                <img id="set-qr-preview" src="" class="w-full aspect-square object-contain mix-blend-multiply" alt="QR Validasi">
                            </div>
                            <div class="text-xs text-slate-600 space-y-1">
                                <p class="font-bold">Ditandatangani secara elektronik oleh:</p>
                                <p id="preview-nama-pejabat" class="font-medium text-slate-800 text-sm">...</p>
                                <p id="preview-nip-pejabat" class="font-mono text-[10px] text-slate-500">NIP. ...</p>
                            </div>
                            <div class="mt-4 flex items-center gap-2 text-[10px] text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100">
                                <i class="ph ph-shield-check text-lg"></i> Sertifikat Valid
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals (kept for functionality, hidden) -->
    <div id="modal-add-employee" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- ... (Existing Modal Content) ... -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeAddEmployeeModal()"></div>
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-transform duration-300 m-4 flex flex-col max-h-[90vh]" id="modal-content">
             <!-- Modal content needs to be re-injected or preserved -->
             <!-- Simplified for brevity in this diff, assume logic populates/shows it -->
             <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div><h3 class="text-xl font-bold text-slate-800" id="modal-title">Form Data Pegawai</h3></div>
                <button onclick="window.closeAddEmployeeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-slate-50/50 p-6 md:p-8">
                <form id="form-add-employee" class="space-y-8">
                    <input type="hidden" id="input-id">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-user-circle text-lg text-blue-500"></i> Identitas Pegawai</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama</label><input id="input-nama" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP</label><input id="input-nip" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tgl Lahir</label><input type="date" id="input-lahir" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center gap-2 border-b pb-2 border-slate-100"><i class="ph ph-briefcase text-lg text-emerald-500"></i> Data Jabatan</h4>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="md:col-span-7 space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenis</label><select id="input-jenis-jabatan" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white"><option value="Umum">Pelaksana</option><option value="Fungsional">Fungsional</option><option value="Struktural">Struktural</option></select></div>
                                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Jabatan</label><input id="input-jabatan" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pangkat</label><select id="input-golongan" onchange="window.previewGajiForm()" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"></select></div>
                                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MKG</label><div class="flex gap-2"><input type="number" id="input-mk-tahun" onchange="window.previewGajiForm()" class="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="Thn"><input type="number" id="input-mk-bulan" class="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="Bln"></div></div>
                                </div>
                            </div>
                            <div class="md:col-span-5 bg-slate-50 p-5 rounded-xl border border-dashed border-slate-300 flex flex-col justify-center text-center">
                                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Estimasi Gaji</p><div id="form-salary-preview" class="text-2xl font-bold text-slate-800 font-mono">Rp 0</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-blue-600 uppercase mb-1">TMT Pangkat</label><input type="date" id="input-tmt-pangkat" class="w-full p-3 border border-blue-200 bg-blue-50/30 rounded-lg text-sm"></div>
                                <div><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">TMT Berkala</label><input type="date" id="input-tmt-berkala" class="w-full p-3 border border-indigo-200 bg-indigo-50/30 rounded-lg text-sm"></div>
                            </div>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nilai SKP</label><select id="input-skp" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"><option value="Sangat Baik">Sangat Baik</option><option value="Baik">Baik</option><option value="Cukup">Cukup</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hukuman</label><select id="input-hukuman" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm"><option value="false">Tidak Ada</option><option value="true">Ada Hukuman</option></select></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-slate-100 bg-white flex justify-end gap-3 sticky bottom-0 z-10">
                <button onclick="window.closeAddEmployeeModal()" class="px-6 py-3 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-100">Batal</button>
                <button onclick="window.saveNewEmployee()" class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-slate-800 shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2"></div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const SALARY_RANGES = {
            'I/a': { base: 1685700, maxMKG: 26, max: 2522600 }, 'I/b': { base: 1840800, maxMKG: 27, max: 2670700 }, 'I/c': { base: 1918700, maxMKG: 27, max: 2783700 }, 'I/d': { base: 1999900, maxMKG: 27, max: 2901400 },
            'II/a': { base: 2184000, maxMKG: 33, max: 3643400 }, 'II/b': { base: 2385000, maxMKG: 33, max: 3797500 }, 'II/c': { base: 2485900, maxMKG: 33, max: 3958200 }, 'II/d': { base: 2591100, maxMKG: 33, max: 4125600 },
            'III/a': { base: 2785700, maxMKG: 32, max: 4575200 }, 'III/b': { base: 2903600, maxMKG: 32, max: 4768800 }, 'III/c': { base: 3026400, maxMKG: 32, max: 4970500 }, 'III/d': { base: 3154400, maxMKG: 32, max: 5180700 },
            'IV/a': { base: 3287800, maxMKG: 32, max: 5399900 }, 'IV/b': { base: 3426900, maxMKG: 32, max: 5628300 }, 'IV/c': { base: 3571900, maxMKG: 32, max: 5866400 }, 'IV/d': { base: 3723000, maxMKG: 32, max: 6114500 }, 'IV/e': { base: 3880400, maxMKG: 32, max: 6373200 }
        };
        const MASTER_RANK = {'I/a':'Juru Muda','I/b':'Juru Muda Tk.I','I/c':'Juru','I/d':'Juru Tk.I','II/a':'Pengatur Muda','II/b':'Pengatur Muda Tk.I','II/c':'Pengatur','II/d':'Pengatur Tk.I','III/a':'Penata Muda','III/b':'Penata Muda Tk.I','III/c':'Penata','III/d':'Penata Tk.I','IV/a':'Pembina','IV/b':'Pembina Tk.I','IV/c':'Pembina Utama Muda','IV/d':'Pembina Utama Madya','IV/e':'Pembina Utama'};
        const GOLONGAN = Object.keys(MASTER_RANK);

        // --- STATE MANAGEMENT ---
        let employees = [];
        let proposals = [];
        let activityLog = [];
        let appSettings = {
            signerName: "Ir. H. CONTOH NAMA, MT.",
            signerNIP: "19700101 199803 1 001",
            signerPosition: "Kepala Dinas",
            signerGolongan: "IV/c",
            logoUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/Coat_of_arms_of_South_Kalimantan.svg/242px-Coat_of_arms_of_South_Kalimantan.svg.png"
        };
        // NEW: User Management
        let appUsers = [
            { username: 'admin', password: 'admin123', name: 'Administrator' } // Default user
        ];
        let currentUser = null;
        let chartGolongan = null;

        // --- LOCAL STORAGE HELPERS ---
        function saveData() {
            localStorage.setItem('sikaji_employees', JSON.stringify(employees));
            localStorage.setItem('sikaji_proposals', JSON.stringify(proposals));
            localStorage.setItem('sikaji_settings', JSON.stringify(appSettings));
            localStorage.setItem('sikaji_logs', JSON.stringify(activityLog));
            localStorage.setItem('sikaji_users', JSON.stringify(appUsers));
        }

        function loadData() {
            const storedEmp = localStorage.getItem('sikaji_employees');
            const storedProp = localStorage.getItem('sikaji_proposals');
            const storedSet = localStorage.getItem('sikaji_settings');
            const storedLog = localStorage.getItem('sikaji_logs');
            const storedUsers = localStorage.getItem('sikaji_users');

            if (storedEmp) {
                employees = JSON.parse(storedEmp).map(e => ({
                    ...e,
                    tgl_lahir: new Date(e.tgl_lahir),
                    tmt_pangkat: new Date(e.tmt_pangkat),
                    tmt_berkala: new Date(e.tmt_berkala)
                }));
            } else { seedData(); }

            if (storedProp) {
                proposals = JSON.parse(storedProp).map(p => ({
                    ...p,
                    date: new Date(p.date),
                    newTMT: new Date(p.newTMT)
                }));
            }

            if (storedSet) appSettings = JSON.parse(storedSet);
            if (storedLog) activityLog = JSON.parse(storedLog);
            if (storedUsers) appUsers = JSON.parse(storedUsers);
        }

        function seedData() {
            const lateTMT = new Date(); lateTMT.setFullYear(lateTMT.getFullYear() - 5);
            employees = [
                { id: 1, nama: "Budi Santoso", nip: "198001012005011001", jabatan: "Analis Kebijakan", golongan: "III/a", mk_tahun: 4, mk_bulan: 0, tgl_lahir: new Date("1980-01-01"), tmt_pangkat: lateTMT, tmt_berkala: new Date("2023-01-01"), nilai_skp: "Baik", hukuman_disiplin: false, jenis_jabatan: "Umum" }
            ];
            saveData();
        }

        // --- AUTH SYSTEM (LOGIN/LOGOUT) ---
        
        window.performLogin = function() {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            
            const validUser = appUsers.find(u => u.username === user && u.password === pass);
            
            if (validUser) {
                currentUser = validUser;
                // Simpan sesi di sessionStorage (sederhana)
                sessionStorage.setItem('sikaji_session', JSON.stringify(validUser));
                
                // Update UI
                document.getElementById('login-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = validUser.name;
                document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${validUser.name}&background=f59e0b&color=fff`;
                
                showToast(`Selamat datang, ${validUser.name}!`);
                nav('dashboard');
            } else {
                showToast("Username atau Password salah!", "error");
            }
        };

        window.performLogout = function() {
            if(confirm("Apakah Anda yakin ingin keluar?")) {
                sessionStorage.removeItem('sikaji_session');
                currentUser = null;
                location.reload(); // Refresh untuk kembali ke login
            }
        };

        function checkSession() {
            const session = sessionStorage.getItem('sikaji_session');
            if (session) {
                currentUser = JSON.parse(session);
                document.getElementById('login-interface').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                document.getElementById('user-avatar-display').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=f59e0b&color=fff`;
                nav('dashboard');
            } else {
                document.getElementById('login-interface').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        }

        window.changePassword = function() {
            const oldPass = document.getElementById('set-pass-old').value;
            const newPass = document.getElementById('set-pass-new').value;
            
            if (currentUser.password !== oldPass) {
                alert("Password lama salah!");
                return;
            }
            
            // Update password in memory
            const idx = appUsers.findIndex(u => u.username === currentUser.username);
            if (idx !== -1) {
                appUsers[idx].password = newPass;
                currentUser.password = newPass;
                saveData(); // Save to storage
                
                // Update Session
                sessionStorage.setItem('sikaji_session', JSON.stringify(currentUser));
                
                alert("Password berhasil diubah!");
                document.getElementById('set-pass-old').value = '';
                document.getElementById('set-pass-new').value = '';
            }
        };

        // --- REST OF APP LOGIC ---

        function fmtMoney(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n); }
        
        function calcGaji(g, mk) { 
            const data = SALARY_RANGES[g]; if (!data) return 0;
            const effectiveMK = Math.min(mk, data.maxMKG);
            const steps = Math.floor(effectiveMK / 2);
            const maxSteps = Math.floor(data.maxMKG / 2);
            if (maxSteps === 0 || steps === 0) return data.base;
            const rate = (data.max - data.base) / (data.base * maxSteps);
            const salary = data.base + (data.base * steps * rate);
            return Math.floor(salary / 100) * 100;
        }

        function nextRank(c) { const i=GOLONGAN.indexOf(c); return (i!==-1 && i<GOLONGAN.length-1) ? GOLONGAN[i+1] : c; }
        function getTenure(d) { return Math.floor(Math.abs(new Date()-d)/(1000*60*60*24*365.25)); }
        function getAge(d) { const n=new Date(); let a=n.getFullYear()-d.getFullYear(); if(n.getMonth()<d.getMonth()||(n.getMonth()===d.getMonth()&&n.getDate()<d.getDate())) a--; return a; }
        function getTmtPensiun(d) { let t=new Date(d); t.setFullYear(t.getFullYear()+58); t.setMonth(t.getMonth()+1); t.setDate(1); return t; }
        function getMonthDiff(d1, d2) { return ((d2.getFullYear()-d1.getFullYear())*12) - d1.getMonth() + d2.getMonth() + (d2.getDate()<d1.getDate()?-1:0); }
        function getReductionYears(o, n) { const mo=o.split('/')[0], mn=n.split('/')[0]; return (mo==='I'&&mn==='II')?6:(mo==='II'&&mn==='III')?5:(mo==='III'&&mn==='IV')?4:0; }

        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            const color = type === 'success' ? 'bg-slate-800' : 'bg-red-600';
            d.className = `${color} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up min-w-[300px] z-[100]`;
            d.innerHTML = `<i class="ph ${type==='success'?'ph-check-circle':'ph-warning-circle'} text-xl"></i><span class="font-medium text-sm">${msg}</span>`;
            c.appendChild(d);
            setTimeout(() => { d.style.opacity='0'; setTimeout(()=>d.remove(),300); }, 3000);
        }

        function renderSalaryTable() {
            const tbody = document.getElementById('table-salary-body');
            if (!tbody) return;
            tbody.innerHTML = Object.keys(SALARY_RANGES).map(g => {
                const data = SALARY_RANGES[g];
                return `<tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="p-4 pl-6 font-bold text-slate-800">${g}</td>
                    <td class="p-4 text-slate-600">${MASTER_RANK[g]}</td>
                    <td class="p-4 text-center font-mono text-emerald-600">${fmtMoney(data.base)}</td>
                    <td class="p-4 text-center text-slate-500">${data.maxMKG} Tahun</td>
                    <td class="p-4 text-right pr-6 font-mono text-slate-800 font-bold">${fmtMoney(data.max)}</td>
                </tr>`;
            }).join('');
        }

        // --- NEW: Added renderPensiun function back ---
        function renderPensiun() {
            const grid = document.getElementById('pensiun-grid');
            if (!grid) return;
            
            const near = employees.filter(e => getAge(e.tgl_lahir) >= 56);
            
            grid.innerHTML = near.length ? near.map(e => {
                const age = getAge(e.tgl_lahir);
                return `<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-slate-800">${e.nama}</h4>
                        <p class="text-xs text-slate-500 font-mono mb-2">${e.nip}</p>
                        <div class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded inline-block">${age} Tahun</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-400 uppercase font-bold">TMT Pensiun</div>
                        <div class="font-bold text-slate-700">${getTmtPensiun(e.tgl_lahir).toLocaleDateString('id-ID')}</div>
                    </div>
                </div>`
            }).join('') : `<div class="col-span-3 text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">Tidak ada pegawai yang mendekati masa pensiun (< 2 Tahun).</div>`;

            const tb = document.getElementById('table-pensiun-body');
            if(tb) {
                tb.innerHTML = employees.sort((a,b) => a.tgl_lahir - b.tgl_lahir).map(e => {
                    const age = getAge(e.tgl_lahir);
                    return `<tr class="hover:bg-slate-50 border-b border-slate-100">
                        <td class="p-4 font-bold text-slate-700 text-sm">${e.nama}</td>
                        <td class="p-4 text-sm">${e.tgl_lahir.toLocaleDateString('id-ID')}</td>
                        <td class="p-4 text-center font-bold text-sm">${age}</td>
                        <td class="p-4 text-center text-sm text-slate-500">${58 - age} Thn</td>
                        <td class="p-4 text-sm font-medium text-slate-800">${getTmtPensiun(e.tgl_lahir).toLocaleDateString('id-ID')}</td>
                    </tr>`;
                }).join('');
            }
        }

        // Logic Checkers
        function isEligibleKGB(emp) {
            if (new Date() >= getTmtPensiun(emp.tgl_lahir)) return { eligible: false, msg: "Pensiun" };
            const pending = proposals.find(p => p.empId === emp.id && p.type === 'PANGKAT' && p.status === 'MENUNGGU');
            if (pending) return { eligible: false, msg: "Proses KP" };
            if (emp.hukuman_disiplin || emp.nilai_skp === 'Kurang') return { eligible: false };
            
            const mainGol = emp.golongan.split('/')[0];
            const isGanjil = (mainGol === 'I' || mainGol === 'II');
            let targetYear = emp.mk_tahun + 1;
            while (true) { if ((isGanjil && targetYear % 2 !== 0) || (!isGanjil && targetYear % 2 === 0)) break; targetYear++; }
            
            const nextTMT = new Date(emp.tmt_berkala);
            nextTMT.setFullYear(nextTMT.getFullYear() + (targetYear - emp.mk_tahun));
            
            const cutoff = new Date(); cutoff.setDate(cutoff.getDate() + 90);
            if (nextTMT <= cutoff) return { eligible: true, nextTMT: nextTMT, nextMKG: targetYear, warning: "SIAP" };
            return { eligible: false };
        }

        function isEligibleKP(emp) {
            if (new Date() >= getTmtPensiun(emp.tgl_lahir)) return { eligible: false };
            if (emp.hukuman_disiplin || ['Cukup','Kurang'].includes(emp.nilai_skp)) return { eligible: false };
            
            const nextEligible = new Date(emp.tmt_pangkat); nextEligible.setFullYear(nextEligible.getFullYear() + 4);
            const subStart = new Date(nextEligible); subStart.setMonth(subStart.getMonth() - 3);
            
            if (new Date() >= subStart) {
                let tmt = new Date(new Date() < nextEligible ? nextEligible : new Date());
                if (new Date() >= nextEligible) { tmt.setMonth(tmt.getMonth()+1); tmt.setDate(1); }
                else tmt.setDate(1);
                return { eligible: true, nextTMT: tmt };
            }
            return { eligible: false };
        }

        // Navigation & Views
        window.nav = function(pageId) {
            document.querySelectorAll('#content-area > div').forEach(el => {
                if(el.id.startsWith('view-')) el.classList.add('hidden');
            });
            
            // Map nav to view IDs
            let targetId = 'view-' + pageId;
            if (['usulan-pangkat', 'usulan-kgb'].includes(pageId)) targetId = 'view-usulan';
            
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.classList.remove('hidden');
            
            document.querySelectorAll('#sidebar button').forEach(el => el.classList.remove('sidebar-item-active'));
            const btn = document.getElementById('nav-' + pageId);
            if(btn) btn.classList.add('sidebar-item-active');

            if(pageId === 'dashboard') updateDashboard();
            if(pageId === 'pegawai') renderPegawai();
            if(pageId === 'usulan-pangkat') renderUsulan('PANGKAT');
            if(pageId === 'usulan-kgb') renderUsulan('KGB');
            if(pageId === 'verifikasi') renderVerifikasi();
            if(pageId === 'salary') renderSalaryTable();
            if(pageId === 'pensiun') renderPensiun();
            if(pageId === 'settings') loadSettingsUI();
            
            if(pageId === 'simulation') {
                const simSel = document.getElementById('sim-golongan');
                if(simSel.options.length === 0) GOLONGAN.forEach(g => simSel.innerHTML += `<option value="${g}">${g} - ${MASTER_RANK[g]}</option>`);
            }
        };

        // Render Functions (Simplified for brevity as logic is identical to backup)
        function renderPegawai() {
            const tbody = document.getElementById('table-pegawai-body');
            const searchInput = document.getElementById('search-pegawai');
            if (!searchInput) return; // Guard clause
            
            const search = searchInput.value.toLowerCase();
            const filtered = employees.filter(e => e.nama.toLowerCase().includes(search) || e.nip.includes(search));
            document.getElementById('pegawai-count').innerText = `Menampilkan ${filtered.length} pegawai`;
            tbody.innerHTML = filtered.map(e => `
                <tr class="hover:bg-slate-50 border-b border-slate-100 group transition-colors">
                    <td class="p-4 pl-6 font-bold text-sm text-slate-700">
                        ${e.nama}
                        <br><span class="font-normal text-xs text-slate-500 font-mono">${e.nip}</span>
                    </td>
                    <td class="p-4 text-sm text-slate-600">
                        ${e.jabatan}
                        <div class="mt-1"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded border border-slate-200">${e.golongan}</span></div>
                    </td>
                    <td class="p-4 text-xs text-slate-500">
                        <div class="flex items-center gap-1 mb-1" title="TMT Pangkat Terakhir"><i class="ph ph-medal text-amber-500"></i> ${new Date(e.tmt_pangkat).toLocaleDateString('id-ID')}</div>
                        <div class="flex items-center gap-1" title="TMT Berkala Terakhir"><i class="ph ph-money text-emerald-500"></i> ${new Date(e.tmt_berkala).toLocaleDateString('id-ID')}</div>
                    </td>
                    <td class="p-4 text-center text-xs font-bold text-slate-700 bg-slate-50/50 rounded-lg mx-2">${e.mk_tahun} Thn ${e.mk_bulan} Bln</td>
                    <td class="p-4 text-right font-mono text-sm font-bold text-emerald-700">${fmtMoney(calcGaji(e.golongan, e.mk_tahun))}</td>
                    <td class="p-4 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="window.openAddEmployeeModal(${e.id})" class="text-blue-600 hover:bg-blue-50 hover:text-blue-700 p-2 rounded-lg transition-all" title="Edit Data">
                                <i class="ph ph-pencil-simple text-lg"></i>
                            </button>
                            <button onclick="window.deleteEmployee(${e.id})" class="text-red-500 hover:bg-red-50 hover:text-red-700 p-2 rounded-lg transition-all" title="Hapus Data">
                                <i class="ph ph-trash text-lg"></i>
                            </button>
                        </div>
                    </td>
                </tr>`).join('');
        }

        window.deleteEmployee = function(id) {
            const emp = employees.find(e => e.id === id);
            if(confirm(`Apakah Anda yakin ingin menghapus data pegawai ${emp ? emp.nama : ''}? Tindakan ini tidak dapat dibatalkan.`)) { 
                employees = employees.filter(e => e.id !== id); 
                saveData(); 
                renderPegawai(); 
                updateDashboard(); 
                showToast("Data pegawai berhasil dihapus", "warning"); 
            }
        };

        function renderUsulan(type) {
            const tbody = document.getElementById('table-usulan-body');
            const titleEl = document.getElementById('usulan-title');
            const cardEl = document.getElementById('usulan-header-card');
            
            if (!titleEl || !cardEl || !tbody) return; // Guard clause

            titleEl.innerText = type === 'PANGKAT' ? 'Usulan Kenaikan Pangkat' : 'Usulan KGB';
            cardEl.className = type === 'PANGKAT' ? "bg-gradient-to-r from-blue-600 to-blue-500 text-white p-8 rounded-2xl shadow-xl relative overflow-hidden" : "bg-gradient-to-r from-emerald-600 to-emerald-500 text-white p-8 rounded-2xl shadow-xl relative overflow-hidden";

            const eligible = employees.filter(e => type === 'PANGKAT' ? isEligibleKP(e).eligible : isEligibleKGB(e).eligible);
            document.getElementById('usulan-count').innerText = eligible.length;

            tbody.innerHTML = eligible.length ? eligible.map(e => {
                const rule = type === 'PANGKAT' ? isEligibleKP(e) : isEligibleKGB(e);
                const existing = proposals.find(p => p.empId === e.id && p.status === 'MENUNGGU');
                
                // Calculate Estimations
                const oldGaji = calcGaji(e.golongan, e.mk_tahun);
                let newRank, newMKG, newGaji, detailHtml;

                if (type === 'PANGKAT') {
                    newRank = nextRank(e.golongan);
                    const reduction = getReductionYears(e.golongan, newRank);
                    // Approximate New MKG logic matching createProposal
                    const md = getMonthDiff(e.tmt_pangkat, rule.nextTMT);
                    const totalY = Math.floor(((e.mk_tahun * 12) + e.mk_bulan + md) / 12);
                    newMKG = Math.max(0, totalY - reduction);
                    newGaji = calcGaji(newRank, newMKG);
                    
                    detailHtml = `
                        <div class="font-bold text-slate-700 text-xs">${e.golongan} <i class="ph ph-arrow-right text-blue-500 text-[10px]"></i> ${newRank}</div>
                        <div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${newMKG} Thn <span class="text-red-500">(-${reduction} Thn)</span></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">Gaji: ${fmtMoney(oldGaji)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(newGaji)}</span></div>
                    `;
                } else {
                    newRank = e.golongan;
                    newMKG = rule.nextMKG;
                    newGaji = calcGaji(newRank, newMKG);
                    
                    detailHtml = `
                        <div class="font-bold text-slate-700 text-xs">Kenaikan Berkala</div>
                        <div class="text-[10px] text-slate-500">MKG: ${e.mk_tahun} &rarr; ${newMKG} Thn</div>
                        <div class="text-[10px] text-slate-500 mt-0.5">Gaji: ${fmtMoney(oldGaji)} &rarr; <span class="font-bold text-emerald-600">${fmtMoney(newGaji)}</span></div>
                    `;
                }

                return `<tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="p-5 font-bold text-sm text-slate-700">${e.nama}<br><span class="font-normal text-xs text-slate-500">${e.nip}</span></td>
                    <td class="p-5">
                        ${detailHtml}
                        <div class="text-[10px] text-slate-400 mt-1 font-mono bg-slate-100 inline-block px-1 rounded">TMT: ${rule.nextTMT.toLocaleDateString('id-ID')}</div>
                    </td>
                    <td class="p-5 text-center"><span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold border border-emerald-200">ELIGIBLE</span></td>
                    <td class="p-5 text-right">${existing ? '<span class="text-xs italic text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded">Menunggu Verif</span>' : `<button onclick="window.createProposal(${e.id}, '${type}')" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition-all flex items-center gap-2 ml-auto"><i class="ph ph-paper-plane-right"></i> Proses</button>`}</td>
                </tr>`;
            }).join('') : `<tr><td colspan="4" class="p-12 text-center text-slate-400 italic bg-slate-50/50">Tidak ada pegawai yang memenuhi syarat saat ini.</td></tr>`;
        }

        window.createProposal = function(id, type) {
            const e = employees.find(x => x.id === id);
            const rule = type === 'PANGKAT' ? isEligibleKP(e) : isEligibleKGB(e);
            let newRank = e.golongan, newMKT = rule.nextMKG, reduction = 0;
            
            if (type === 'PANGKAT') {
                newRank = nextRank(e.golongan);
                reduction = getReductionYears(e.golongan, newRank);
                const md = getMonthDiff(e.tmt_pangkat, rule.nextTMT);
                const totalY = Math.floor(((e.mk_tahun*12)+e.mk_bulan+md)/12);
                newMKT = Math.max(0, totalY - reduction);
            }

            proposals.push({
                id: Date.now(), empId: e.id, empName: e.nama, empNip: e.nip, type: type, status: 'MENUNGGU', date: new Date(),
                newTMT: rule.nextTMT, oldRank: e.golongan, newRank: newRank,
                newGaji: calcGaji(newRank, newMKT), newMKTahun: newMKT, reduction: reduction
            });
            addActivity(`Usulan ${type} dibuat untuk ${e.nama}`, 'info'); // Log pembuatan
            saveData(); showToast("Usulan berhasil dibuat"); nav('verifikasi');
        };

        function renderVerifikasi() {
            const tbody = document.getElementById('table-verifikasi-body');
            if (!tbody) return;

            const list = proposals.sort((a,b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = list.map(p => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="p-4 text-xs font-mono">${new Date(p.date).toLocaleDateString()}</td>
                    <td class="p-4 text-xs font-bold">${p.type}</td>
                    <td class="p-4 text-sm font-bold">${p.empName}</td>
                    <td class="p-4 text-xs">${p.type==='KGB'?`MKG ${p.newMKTahun} Thn`:`${p.newRank} (Potong ${p.reduction} Thn)`}</td>
                    <td class="p-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${p.status==='MENUNGGU'?'bg-amber-100 text-amber-700':'bg-emerald-100 text-emerald-700'}">${p.status}</span></td>
                    <td class="p-4 text-right">${p.status==='MENUNGGU' ? `<button onclick="window.approveProposal(${p.id})" class="text-emerald-600 hover:bg-emerald-50 p-2 rounded"><i class="ph ph-check-circle text-xl"></i></button>` : '<i class="ph ph-check text-slate-300"></i>'}</td>
                </tr>`).join('');
        }

        window.approveProposal = function(pid) {
            const p = proposals.find(x => x.id === pid);
            if(p && p.status === 'MENUNGGU') {
                if(!confirm(`Setujui usulan ${p.type} untuk pegawai ${p.empName}? Data pegawai akan otomatis diperbarui.`)) return;

                p.status = 'DISETUJUI';
                const idx = employees.findIndex(e => e.id === p.empId);
                
                if(idx !== -1) {
                    // Update Data Pegawai (Inti Logika)
                    employees[idx].mk_tahun = p.newMKTahun;
                    employees[idx].mk_bulan = 0; // Reset bulan saat kenaikan
                    employees[idx].tmt_berkala = new Date(p.newTMT);

                    if(p.type === 'PANGKAT') {
                        employees[idx].golongan = p.newRank;
                        employees[idx].tmt_pangkat = new Date(p.newTMT);
                    }

                    // Log Aktivitas & Simpan
                    addActivity(`Usulan ${p.type} ${p.empName} disetujui. Data diperbarui.`, 'success');
                    saveData(); 
                    
                    // Refresh UI
                    showToast("Disetujui & Data Diperbarui"); 
                    renderVerifikasi(); 
                    renderPegawai(); // Refresh tabel pegawai juga
                    updateDashboard();
                }
            }
        };

        function updateDashboard() {
            const active = employees.filter(e => new Date() < getTmtPensiun(e.tgl_lahir));
            document.getElementById('stat-total').innerText = active.length;
            
            // Hitung data untuk notifikasi
            const eligiblePangkat = employees.filter(e => isEligibleKP(e).eligible).length;
            const eligibleKGB = employees.filter(e => isEligibleKGB(e).eligible).length;
            const pending = proposals.filter(p => p.status === 'MENUNGGU').length;
            
            // Update Statistik Dashboard
            document.getElementById('stat-pangkat').innerText = eligiblePangkat;
            document.getElementById('stat-kgb').innerText = eligibleKGB;
            document.getElementById('hero-pending-count').innerText = pending;
            document.getElementById('priority-section').innerHTML = pending > 0 ? `<div class="bg-amber-50 p-4 rounded-xl flex justify-between items-center"><div class="flex gap-3 items-center text-amber-700"><i class="ph ph-warning-circle text-xl"></i><span class="text-sm font-bold">${pending} Menunggu Verifikasi</span></div><button onclick="window.nav('verifikasi')" class="text-xs bg-white border px-3 py-1 rounded">Cek</button></div>` : '';
            
            // Update Notifikasi Sidebar
            const badgePangkat = document.getElementById('badge-pangkat');
            const badgeKGB = document.getElementById('badge-kgb');
            const badgeVerif = document.getElementById('badge-verif');

            if (badgePangkat) {
                badgePangkat.innerText = eligiblePangkat;
                badgePangkat.classList.toggle('hidden', eligiblePangkat === 0);
            }
            if (badgeKGB) {
                badgeKGB.innerText = eligibleKGB;
                badgeKGB.classList.toggle('hidden', eligibleKGB === 0);
            }
            if (badgeVerif) {
                badgeVerif.innerText = pending;
                badgeVerif.classList.toggle('hidden', pending === 0);
            }

            if(chartGolongan) chartGolongan.destroy();
            const gData = {}; active.forEach(e => { const k = e.golongan.split('/')[0]; gData[k] = (gData[k]||0)+1; });
            const ctx = document.getElementById('chart-golongan').getContext('2d');
            chartGolongan = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(gData), datasets: [{ label: 'Pegawai', data: Object.values(gData), backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
        }

        // Settings Logic (Existing + New User Mgmt)
        window.loadSettingsUI = function() {
            document.getElementById('set-nama').value = appSettings.signerName;
            document.getElementById('set-nip').value = appSettings.signerNIP;
            document.getElementById('set-jabatan').value = appSettings.signerPosition;
            const sel = document.getElementById('set-golongan');
            if(sel.options.length === 0) GOLONGAN.forEach(g => sel.innerHTML += `<option value="${g}">${g} - ${MASTER_RANK[g]}</option>`);
            sel.value = appSettings.signerGolongan;
            if(appSettings.logoUrl) document.getElementById('settings-logo-preview').src = appSettings.logoUrl;
            document.getElementById('settings-current-user').innerText = currentUser ? currentUser.username : 'GUEST';
            updateQRPreview();
        };

        window.saveSettings = function() {
            appSettings.signerName = document.getElementById('set-nama').value;
            appSettings.signerNIP = document.getElementById('set-nip').value;
            appSettings.signerPosition = document.getElementById('set-jabatan').value;
            appSettings.signerGolongan = document.getElementById('set-golongan').value;
            saveData(); showToast("Pengaturan Disimpan");
        };

        window.updateQRPreview = function() {
            const data = `TTE|${document.getElementById('set-nip').value}|${document.getElementById('set-nama').value}`;
            document.getElementById('set-qr-preview').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data)}`;
        };

        window.uploadLogo = function(e) {
            const file = e.target.files[0];
            if(file && file.size < 2*1024*1024) {
                const reader = new FileReader();
                reader.onload = function(evt) { appSettings.logoUrl = evt.target.result; document.getElementById('settings-logo-preview').src = evt.target.result; saveData(); };
                reader.readAsDataURL(file);
            } else alert("File terlalu besar");
        };

        // Modal Logic
        window.openAddEmployeeModal = function(id = null) {
            const modal = document.getElementById('modal-add-employee');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.remove('scale-95');
            document.getElementById('modal-content').classList.add('scale-100');
            const sel = document.getElementById('input-golongan');
            if(sel.options.length === 0) GOLONGAN.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
            
            if(id) {
                const e = employees.find(x => x.id === id);
                document.getElementById('modal-title').innerText = "Edit Pegawai";
                document.getElementById('input-id').value = e.id;
                document.getElementById('input-nama').value = e.nama;
                document.getElementById('input-nip').value = e.nip;
                document.getElementById('input-lahir').value = e.tgl_lahir.toISOString().split('T')[0];
                document.getElementById('input-jabatan').value = e.jabatan;
                document.getElementById('input-jenis-jabatan').value = e.jenis_jabatan;
                document.getElementById('input-golongan').value = e.golongan;
                document.getElementById('input-mk-tahun').value = e.mk_tahun;
                document.getElementById('input-mk-bulan').value = e.mk_bulan;
                document.getElementById('input-tmt-pangkat').value = e.tmt_pangkat.toISOString().split('T')[0];
                document.getElementById('input-tmt-berkala').value = e.tmt_berkala.toISOString().split('T')[0];
                document.getElementById('input-skp').value = e.nilai_skp;
                document.getElementById('input-hukuman').value = e.hukuman_disiplin.toString();
            } else {
                document.getElementById('modal-title').innerText = "Tambah Pegawai";
                document.getElementById('form-add-employee').reset();
                document.getElementById('input-id').value = "";
            }
            window.previewGajiForm();
        };

        window.closeAddEmployeeModal = function() {
            const modal = document.getElementById('modal-add-employee');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.add('scale-95');
        };

        window.saveNewEmployee = function() {
            const id = document.getElementById('input-id').value;
            const data = {
                nama: document.getElementById('input-nama').value, nip: document.getElementById('input-nip').value,
                jabatan: document.getElementById('input-jabatan').value, jenis_jabatan: document.getElementById('input-jenis-jabatan').value,
                golongan: document.getElementById('input-golongan').value, mk_tahun: parseInt(document.getElementById('input-mk-tahun').value)||0,
                mk_bulan: parseInt(document.getElementById('input-mk-bulan').value)||0, tgl_lahir: new Date(document.getElementById('input-lahir').value),
                tmt_pangkat: new Date(document.getElementById('input-tmt-pangkat').value), tmt_berkala: new Date(document.getElementById('input-tmt-berkala').value),
                nilai_skp: document.getElementById('input-skp').value, hukuman_disiplin: document.getElementById('input-hukuman').value === 'true'
            };
            if(!data.nama || !data.nip || isNaN(data.tgl_lahir)) { alert("Data tidak lengkap"); return; }
            
            if(id) {
                const idx = employees.findIndex(e => e.id == id);
                if(idx!==-1) employees[idx] = { id: parseInt(id), ...data };
            } else {
                employees.push({ id: Date.now(), ...data });
            }
            saveData(); closeAddEmployeeModal(); renderPegawai(); updateDashboard(); showToast("Disimpan");
        };

        window.deleteEmployee = function(id) {
            const emp = employees.find(e => e.id === id);
            if(confirm(`Apakah Anda yakin ingin menghapus data pegawai ${emp ? emp.nama : ''}? Tindakan ini tidak dapat dibatalkan.`)) { 
                employees = employees.filter(e => e.id !== id); 
                saveData(); 
                renderPegawai(); 
                updateDashboard(); 
                showToast("Data pegawai berhasil dihapus", "warning"); 
            }
        };

        window.previewGajiForm = function() {
            const g = document.getElementById('input-golongan').value;
            const m = parseInt(document.getElementById('input-mk-tahun').value)||0;
            document.getElementById('form-salary-preview').innerText = fmtMoney(calcGaji(g, m));
        };

        // --- BACKUP & RESTORE SYSTEM ---
        window.exportDataJSON = function() {
            const data = {
                employees: employees,
                proposals: proposals,
                settings: appSettings,
                logs: activityLog,
                users: appUsers,
                timestamp: new Date().toISOString(),
                appVersion: "SIKAJI-V1"
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "BACKUP_SIKAJI_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showToast("Backup data berhasil diunduh");
        };

        window.importDataJSON = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.appVersion || !data.employees) {
                        alert("Format file tidak valid atau bukan file backup SIKAJI.");
                        return;
                    }

                    if (confirm(`Restore data dari tanggal ${new Date(data.timestamp).toLocaleDateString()}? Data saat ini akan ditimpa.`)) {
                        localStorage.setItem('sikaji_employees', JSON.stringify(data.employees));
                        localStorage.setItem('sikaji_proposals', JSON.stringify(data.proposals));
                        localStorage.setItem('sikaji_settings', JSON.stringify(data.settings));
                        localStorage.setItem('sikaji_logs', JSON.stringify(data.logs));
                        if(data.users) localStorage.setItem('sikaji_users', JSON.stringify(data.users));
                        
                        location.reload();
                    }
                } catch (err) {
                    alert("Gagal membaca file backup: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        };

        // --- RESTORED FUNCTIONS ---
        // window.resetData removed

        window.resetLogo = function() {
            appSettings.logoUrl = "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/Coat_of_arms_of_South_Kalimantan.svg/242px-Coat_of_arms_of_South_Kalimantan.svg.png";
            document.getElementById('settings-logo-preview').src = appSettings.logoUrl;
            saveData();
            showToast("Logo dikembalikan ke default");
        }

        window.filterUsulanTable = function() {
            const val = document.getElementById('search-usulan').value.toLowerCase();
            const rows = document.querySelectorAll('#table-usulan-body tr');
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        }

        window.printGeneralReport = function(type) {
            const win = window.open('','_blank');
            let rows = '';
            let title = '';
            let headers = '';
            const logo = appSettings.logoUrl;

            // Generate QR Code khusus Laporan
            const reportId = `LAP-${type}-${Date.now()}`;
            const qrData = `SIKAJI-VALID|${reportId}|${appSettings.signerNIP}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(qrData)}`;

            if (type === 'ALL') {
                title = 'DAFTAR NOMINATIF PEGAWAI';
                headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Nama / NIP</th><th style="border:1px solid #000; padding:8px">Jabatan</th><th style="border:1px solid #000; padding:8px">Golongan</th><th style="border:1px solid #000; padding:8px">MKG</th>`;
                rows = employees.map((e, i) => `
                    <tr>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td>
                        <td style="border:1px solid #000; padding:5px"><b>${e.nama}</b><br>${e.nip}</td>
                        <td style="border:1px solid #000; padding:5px">${e.jabatan}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${e.golongan}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${e.mk_tahun} Thn ${e.mk_bulan} Bln</td>
                    </tr>
                `).join('');
            } else {
                title = type === 'APPROVED' ? 'LAPORAN REALISASI SK (DISETUJUI)' : 'DAFTAR ANTRIAN VERIFIKASI';
                headers = `<th style="border:1px solid #000; padding:8px">No</th><th style="border:1px solid #000; padding:8px">Pegawai</th><th style="border:1px solid #000; padding:8px">Jenis Usulan</th><th style="border:1px solid #000; padding:8px">Detail Perubahan</th><th style="border:1px solid #000; padding:8px">TMT</th>`;
                const filterStatus = type === 'APPROVED' ? 'DISETUJUI' : 'MENUNGGU';
                rows = proposals.filter(p => p.status === filterStatus).map((p, i) => `
                    <tr>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${i+1}</td>
                        <td style="border:1px solid #000; padding:5px"><b>${p.empName}</b><br>${p.empNip}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${p.type}</td>
                        <td style="border:1px solid #000; padding:5px">${p.type === 'KGB' ? `Gaji: ${fmtMoney(p.newGaji)}` : `Pangkat: ${p.newRank}`}</td>
                        <td style="border:1px solid #000; padding:5px; text-align:center">${new Date(p.newTMT).toLocaleDateString('id-ID')}</td>
                    </tr>
                `).join('');
            }

            win.document.write(`<html><head><title>Laporan</title>
                <style>
                    @page { size: A4; margin: 2cm; }
                    body { font-family: 'Times New Roman', serif; width: 100%; margin: 0; }
                    .kop-surat { width: 100%; border-bottom: 3px double black; margin-bottom: 25px; padding-bottom: 10px; }
                    .kop-logo-container { width: 100px; text-align: center; vertical-align: middle; }
                    .kop-logo { height: 95px; width: auto; object-fit: contain; }
                    .kop-text-container { text-align: center; vertical-align: middle; padding-left: 10px; padding-right: 10px; }
                    .kop-row-1 { font-size: 13pt; font-weight: bold; margin: 0; line-height: 1.2; }
                    .kop-row-2 { font-size: 15pt; font-weight: bold; margin: 0; line-height: 1.2; }
                    .kop-row-3 { font-size: 17pt; font-weight: bold; margin: 0; line-height: 1.2; }
                    .kop-address { font-size: 9pt; margin: 2px 0 0 0; line-height: 1.3; }
                </style>
                </head><body>
                <table class="kop-surat">
                    <tr>
                        <td class="kop-logo-container">
                            <img src="${logo}" class="kop-logo">
                        </td>
                        <td class="kop-text-container">
                            <h3 class="kop-row-1">PEMERINTAH PROVINSI KALIMANTAN SELATAN</h3>
                            <h2 class="kop-row-2">DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</h2>
                            <h2 class="kop-row-3">LABORATORIUM BAHAN KONSTRUKSI</h2>
                            <p class="kop-address">Jl. Yos Sudarso No. 35 Kel. Telaga Biru Kec. Banjarmasin Barat Kota Banjarmasin RT. 34 RW. 02</p>
                            <p class="kop-address">Telpon : (0511) 4423377 | Fax : (0511) 4423377 | Email : laboratoriumpuprov.kalsel@yahoo.com</p>
                        </td>
                    </tr>
                </table>

                <h1 style="text-align:center; font-size:14pt; font-weight:bold; text-decoration:underline; margin-bottom:20px; text-transform:uppercase">${title}</h1>
                <table style="width:100%; border-collapse:collapse; font-size:11pt">
                    <thead><tr style="background-color:#f3f4f6; text-align:center">${headers}</tr></thead>
                    <tbody>${rows || '<tr><td colspan="5" style="text-align:center; padding:10px; font-style:italic; border:1px solid #000">Tidak ada data.</td></tr>'}</tbody>
                </table>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:50px">
                    <div style="text-align:center">
                        <img src="${qrUrl}" style="width:90px; height:90px; margin-bottom:10px; border:1px solid #ddd; padding:5px">
                        <p style="font-size:9pt; color:#666; margin:0">Dokumen valid & terverifikasi<br>sistem SIKAJI ASN.</p>
                    </div>
                    <div style="text-align:center; width:250px">
                        <p style="margin-bottom:70px; font-size:12pt">Banjarmasin, ${new Date().toLocaleDateString('id-ID', {dateStyle:'long'})}<br><strong>${appSettings.signerPosition}</strong></p>
                        <p style="font-weight:bold; text-decoration:underline; margin:0; font-size:12pt">${appSettings.signerName}</p>
                        <p style="margin:0; font-size:12pt">NIP. ${appSettings.signerNIP}</p>
                    </div>
                </div>
                <script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>
            </body></html>`);
            win.document.close();
        }

        // --- INIT ---
        window.onload = function() {
            loadData();
            checkSession();
            setInterval(() => { const d = document.getElementById('clock'); if(d) d.innerText = new Date().toLocaleTimeString(); }, 1000);
        };
    </script>
</body>
</html>
